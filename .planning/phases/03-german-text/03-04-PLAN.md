---
phase: 03-german-text
plan: 04
type: execute
wave: 1
depends_on: []
files_modified:
  - src/types/frequency.ts
  - src/types/text.ts
  - src/components/wizard/StepStatus.vue
  - src/components/wizard/TextOutput.vue
  - src/stores/useTemplateStore.ts
  - src/composables/useTextGenerator.ts
  - src/config/templates/de.json
  - src/config/templates/en.json
autonomous: true
gap_closure: true

must_haves:
  truths:
    - "User can select from 4 affected status options: heterozygous, homozygous, compound het confirmed, compound het assumed"
    - "German text opening changes based on selected affected status"
    - "User can select patient sex (male/female/neutral) in German text output"
    - "German text uses correct grammatical gender forms (der Patient/die Patientin/der/die Patient*in)"
    - "English text remains unaffected by patient sex selection"
  artifacts:
    - path: "src/types/frequency.ts"
      provides: "Expanded IndexPatientStatus type with 4 values"
      contains: "'heterozygous' | 'homozygous' | 'compound_het_confirmed' | 'compound_het_assumed'"
    - path: "src/types/text.ts"
      provides: "PatientSex type definition"
      contains: "PatientSex"
    - path: "src/components/wizard/StepStatus.vue"
      provides: "4-option status selector UI"
      contains: "v-radio-group"
    - path: "src/components/wizard/TextOutput.vue"
      provides: "Patient sex selector for German"
      contains: "patientSex"
    - path: "src/config/templates/de.json"
      provides: "Status-specific opening text and patient gender variables"
      contains: "{{patientGenitive}}"
  key_links:
    - from: "src/components/wizard/StepStatus.vue"
      to: "src/types/frequency.ts"
      via: "IndexPatientStatus import"
      pattern: "IndexPatientStatus"
    - from: "src/composables/useTextGenerator.ts"
      to: "src/stores/useTemplateStore.ts"
      via: "patientSex from store"
      pattern: "store\\.patientSex"
    - from: "src/config/templates/de.json"
      to: "src/composables/useTextGenerator.ts"
      via: "template context variables"
      pattern: "patientNominative|patientGenitive|patientDative"
---

<objective>
Close two high-severity gaps from Phase 3 verification:
1. GAP-03-01: Expand affected status from 2 to 4 options (heterozygous, homozygous, compound het confirmed, compound het assumed)
2. GAP-03-02: Add patient sex selection for German grammatical gender agreement

Purpose: Clinical documentation requires precise status differentiation and correct German grammar to be usable in medical letters.

Output: Updated wizard step 2 with 4 status options, updated TextOutput with patient sex selector (German only), updated templates with status-specific openings and gender-declined patient references.
</objective>

<execution_context>
@~/.claude/get-shit-done/workflows/execute-plan.md
@~/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/03-german-text/03-VERIFICATION.md

# Existing implementation files
@src/types/frequency.ts
@src/types/text.ts
@src/components/wizard/StepStatus.vue
@src/components/wizard/TextOutput.vue
@src/stores/useTemplateStore.ts
@src/composables/useTextGenerator.ts
@src/config/templates/de.json
@src/config/templates/en.json
</context>

<tasks>

<task type="auto">
  <name>Task 1: Expand IndexPatientStatus type and update StepStatus UI</name>
  <files>
    src/types/frequency.ts
    src/components/wizard/StepStatus.vue
  </files>
  <action>
**1. Update src/types/frequency.ts:**

Change IndexPatientStatus from:
```typescript
export type IndexPatientStatus = 'heterozygous' | 'compound_het_homozygous';
```

To:
```typescript
export type IndexPatientStatus =
  | 'heterozygous'           // Carrier - one pathogenic allele
  | 'homozygous'             // Affected - two copies same allele
  | 'compound_het_confirmed' // Affected - two different alleles, confirmed
  | 'compound_het_assumed';  // Affected - two different alleles, assumed by phenotype
```

**2. Update src/components/wizard/StepStatus.vue:**

Replace the v-switch toggle with a v-radio-group providing 4 options:

```vue
<v-radio-group v-model="statusModel" class="mt-2">
  <v-radio value="heterozygous">
    <template #label>
      <div>
        <strong>Heterozygous carrier</strong>
        <div class="text-caption text-medium-emphasis">One pathogenic allele detected</div>
      </div>
    </template>
  </v-radio>
  <v-radio value="homozygous">
    <template #label>
      <div>
        <strong>Homozygous affected</strong>
        <div class="text-caption text-medium-emphasis">Two copies of same pathogenic allele</div>
      </div>
    </template>
  </v-radio>
  <v-radio value="compound_het_confirmed">
    <template #label>
      <div>
        <strong>Compound heterozygous (confirmed)</strong>
        <div class="text-caption text-medium-emphasis">Two different pathogenic alleles, phase confirmed</div>
      </div>
    </template>
  </v-radio>
  <v-radio value="compound_het_assumed">
    <template #label>
      <div>
        <strong>Compound heterozygous (assumed)</strong>
        <div class="text-caption text-medium-emphasis">Two pathogenic alleles, phase assumed by phenotype</div>
      </div>
    </template>
  </v-radio>
</v-radio-group>
```

Remove the isAffected computed property. Use direct v-model binding with emit.

Keep the Back/Continue buttons at bottom.
  </action>
  <verify>
- `npx vue-tsc --noEmit` passes with no type errors
- StepStatus renders 4 radio options
- Selecting each option emits correct value
  </verify>
  <done>
IndexPatientStatus has 4 values. StepStatus shows 4 radio options. User can select any status and proceed.
  </done>
</task>

<task type="auto">
  <name>Task 2: Add PatientSex type and update store/text generator</name>
  <files>
    src/types/text.ts
    src/stores/useTemplateStore.ts
    src/composables/useTextGenerator.ts
  </files>
  <action>
**1. Update src/types/text.ts:**

Add PatientSex type after GenderStyle:
```typescript
/**
 * Patient biological sex for German grammatical gender agreement
 * - 'male': der Patient / des Patienten / dem Patienten
 * - 'female': die Patientin / der Patientin / der Patientin
 * - 'neutral': der/die Patient*in / des/der Patient*in / dem/der Patient*in
 */
export type PatientSex = 'male' | 'female' | 'neutral';
```

Update TemplateContext interface to add:
```typescript
/** Index patient status - expanded for German text variations */
indexStatus: 'heterozygous' | 'homozygous' | 'compound_het_confirmed' | 'compound_het_assumed';

/** Patient grammatical forms (German only) */
patientNominative?: string;  // der Patient / die Patientin
patientGenitive?: string;    // des Patienten / der Patientin
patientDative?: string;      // dem Patienten / der Patientin
```

**2. Update src/stores/useTemplateStore.ts:**

Add patientSex to state:
```typescript
interface TemplateStoreState {
  language: 'de' | 'en';
  genderStyle: GenderStyle;
  patientSex: PatientSex;  // ADD THIS
  enabledSections: Record<Perspective, string[]>;
  customSections: Record<string, string>;
}
```

Default to 'male' (most common in clinical letters):
```typescript
state: (): TemplateStoreState => ({
  language: detectBrowserLanguage(),
  genderStyle: '*',
  patientSex: 'male',  // ADD THIS
  // ... rest unchanged
}),
```

Add getter for patient forms:
```typescript
patientForms: (state) => {
  switch (state.patientSex) {
    case 'male':
      return {
        nominative: 'der Patient',
        genitive: 'des Patienten',
        dative: 'dem Patienten',
      };
    case 'female':
      return {
        nominative: 'die Patientin',
        genitive: 'der Patientin',
        dative: 'der Patientin',
      };
    case 'neutral':
      return {
        nominative: 'der/die Patient*in',
        genitive: 'des/der Patient*in',
        dative: 'dem/der Patient*in',
      };
  }
},
```

Add action:
```typescript
setPatientSex(sex: PatientSex) {
  this.patientSex = sex;
},
```

**3. Update src/composables/useTextGenerator.ts:**

Import PatientSex type.

Update templateContext computed to include patient forms and expanded indexStatus:
```typescript
return {
  gene: data.result.gene,
  carrierFrequency: formatFrequencyForLocale(effectiveFrequency, store.language),
  carrierFrequencyRatio: formatRatio(effectiveFrequency),
  recurrenceRiskPercent: formatPercentForLocale(recurrenceRisk, store.language),
  recurrenceRiskRatio: formatRatio(recurrenceRisk),
  source: formatSourceAttribution(data, store.language),
  indexStatus: data.indexStatus,  // Pass raw value now
  genderSuffix: store.genderSuffix,
  accessDate: formatAccessDate(store.language),
  // Add patient forms for German templates
  patientNominative: store.patientForms.nominative,
  patientGenitive: store.patientForms.genitive,
  patientDative: store.patientForms.dative,
};
```

Update the divisor calculation to handle all 4 statuses:
```typescript
const divisor = data.indexStatus === 'heterozygous' ? 4 : 2;
```
This remains correct: heterozygous = carrier risk (1/4), all affected statuses = affected risk (1/2).

Export patientSex and setPatientSex from the composable return:
```typescript
return {
  // ... existing
  patientSex: computed(() => store.patientSex),
  setPatientSex: store.setPatientSex,
};
```
  </action>
  <verify>
- `npx vue-tsc --noEmit` passes
- PatientSex type exported from types/text.ts
- useTemplateStore has patientSex state and patientForms getter
- useTextGenerator returns patientSex and setPatientSex
  </verify>
  <done>
PatientSex type defined. Store holds patientSex with persistence. Text generator builds context with patient grammatical forms.
  </done>
</task>

<task type="auto">
  <name>Task 3: Update templates and TextOutput UI</name>
  <files>
    src/config/templates/de.json
    src/config/templates/en.json
    src/components/wizard/TextOutput.vue
  </files>
  <action>
**1. Update src/config/templates/de.json:**

Replace the "geneIntro" section for "affected" perspective with status-aware text using conditional template selection. Since we use simple {{variable}} interpolation, add a new template variable {{statusIntro}} that will be built by the text generator.

Actually, simpler approach: Add a new section "statusIntro" that provides the opening based on status, and update "geneIntro" to use patient gender variables:

For "affected" perspective, update geneIntro template:
```json
"geneIntro": {
  "id": "geneIntro",
  "label": "Geneinleitung",
  "template": "{{statusIntro}} {{patientGenitive}} wurde eine pathogene Variante im {{gene}}-Gen nachgewiesen."
}
```

Wait - this approach requires building {{statusIntro}} in the text generator. Better to keep templates simple.

**Alternative approach:** The text generator will select different template text based on indexStatus. Update the template to use generic phrasing with patient gender variables:

For "affected" perspective sections, replace "des Patienten" with "{{patientGenitive}}" throughout:

```json
"geneIntro": {
  "template": "Bei {{patientDative}} wurde eine pathogene Variante im {{gene}}-Gen nachgewiesen."
},
"inheritance": {
  "template": "Das {{gene}}-Gen wird autosomal rezessiv vererbt. Die Eltern {{patientGenitive}} sind mit großer Wahrscheinlichkeit jeweils heterozygote Anlageträger{{genderSuffix}}."
},
"recurrenceRisk": {
  "template": "läge das Risiko für eine {{gene}}-assoziierte Erkrankung bei Nachkommen {{patientGenitive}} bei etwa {{recurrenceRiskPercent}} ({{recurrenceRiskRatio}})."
},
"recommendation": {
  "template": "Auch weitere Verwandte haben ggf. ein erhöhtes Risiko selbst Anlageträger{{genderSuffix}} zu sein. Familienangehörigen kann eine Untersuchung auf die hier nachgewiesene Variante angeboten werden."
}
```

For geneIntro in "affected" perspective, handle status-specific openings by creating a statusIntro context variable in the text generator (not in template). The geneIntro becomes:
```json
"geneIntro": {
  "id": "geneIntro",
  "label": "Geneinleitung",
  "template": "{{statusIntro}}"
}
```

The {{statusIntro}} variable will be built by useTextGenerator based on indexStatus:
- heterozygous: "Bei {{patientDative}} wurde eine heterozygote pathogene Variante im {{gene}}-Gen nachgewiesen."
- homozygous: "Bei {{patientDative}} wurde eine pathogene Variante im {{gene}}-Gen im homozygoten Zustand nachgewiesen."
- compound_het_confirmed: "Bei {{patientDative}} wurden zwei pathogene Varianten im {{gene}}-Gen im compound heterozygoten Zustand nachgewiesen."
- compound_het_assumed: "Bei {{patientDative}} wurden zwei pathogene Varianten im {{gene}}-Gen nachgewiesen. Aufgrund des passenden Phänotyps erscheint ein compound heterozygotes Vorliegen wahrscheinlich."

Update other "affected" sections to use {{patientGenitive}} instead of hardcoded "des Patienten".

Similarly update "carrier" perspective to use "der untersuchten Person" (no patient reference needed - this is for healthy carriers).

Update "familyMember" perspective - no patient references needed (uses "der Familie").

**2. Update src/config/templates/en.json:**

Mirror the German changes but without grammatical complexity:
- geneIntro for "affected": "{{statusIntro}}"
- statusIntro built in text generator based on status:
  - heterozygous: "A heterozygous pathogenic variant in the {{gene}} gene was identified in the patient."
  - homozygous: "A pathogenic variant in the {{gene}} gene was identified in the homozygous state in the patient."
  - compound_het_confirmed: "Two pathogenic variants in the {{gene}} gene were identified in compound heterozygous state in the patient."
  - compound_het_assumed: "Two pathogenic variants in the {{gene}} gene were identified in the patient. Based on the clinical phenotype, compound heterozygous inheritance is presumed."

**3. Update src/composables/useTextGenerator.ts:**

Add function to build statusIntro:
```typescript
function buildStatusIntro(
  indexStatus: IndexPatientStatus,
  gene: string,
  patientDative: string,
  lang: 'de' | 'en'
): string {
  if (lang === 'de') {
    switch (indexStatus) {
      case 'heterozygous':
        return `Bei ${patientDative} wurde eine heterozygote pathogene Variante im ${gene}-Gen nachgewiesen.`;
      case 'homozygous':
        return `Bei ${patientDative} wurde eine pathogene Variante im ${gene}-Gen im homozygoten Zustand nachgewiesen.`;
      case 'compound_het_confirmed':
        return `Bei ${patientDative} wurden zwei pathogene Varianten im ${gene}-Gen im compound heterozygoten Zustand nachgewiesen.`;
      case 'compound_het_assumed':
        return `Bei ${patientDative} wurden zwei pathogene Varianten im ${gene}-Gen nachgewiesen. Aufgrund des passenden Phänotyps erscheint ein compound heterozygotes Vorliegen wahrscheinlich.`;
    }
  } else {
    switch (indexStatus) {
      case 'heterozygous':
        return `A heterozygous pathogenic variant in the ${gene} gene was identified in the patient.`;
      case 'homozygous':
        return `A pathogenic variant in the ${gene} gene was identified in the homozygous state in the patient.`;
      case 'compound_het_confirmed':
        return `Two pathogenic variants in the ${gene} gene were identified in compound heterozygous state in the patient.`;
      case 'compound_het_assumed':
        return `Two pathogenic variants in the ${gene} gene were identified in the patient. Based on the clinical phenotype, compound heterozygous inheritance is presumed.`;
    }
  }
}
```

Add statusIntro to templateContext:
```typescript
statusIntro: buildStatusIntro(
  data.indexStatus,
  data.result.gene,
  store.patientForms.dative,
  store.language
),
```

**4. Update src/components/wizard/TextOutput.vue:**

Add patient sex selector (German only), placed after gender style selector:

```vue
<!-- Patient sex selector (German only) -->
<v-select
  v-if="language === 'de'"
  v-model="patientSexModel"
  :items="patientSexOptions"
  :label="labels.patientSex"
  density="compact"
  variant="outlined"
  hide-details
  style="max-width: 160px"
/>
```

Add to script:
```typescript
const {
  // ... existing
  patientSex,
  setPatientSex,
} = useTextGenerator(() => ({...}));

const patientSexModel = computed({
  get: () => patientSex.value,
  set: (val: PatientSex) => setPatientSex(val),
});

const patientSexOptions = computed(() => [
  { value: 'male', title: labels.value.patientSexOptions.male },
  { value: 'female', title: labels.value.patientSexOptions.female },
  { value: 'neutral', title: labels.value.patientSexOptions.neutral },
]);
```

Add to labels:
```typescript
// German labels
patientSex: 'Patient*in',
patientSexOptions: {
  male: 'Mannlich (der Patient)',
  female: 'Weiblich (die Patientin)',
  neutral: 'Neutral (der/die Patient*in)',
},

// English labels (even though not shown in EN)
patientSex: 'Patient Sex',
patientSexOptions: {
  male: 'Male',
  female: 'Female',
  neutral: 'Neutral',
},
```

Import PatientSex type.
  </action>
  <verify>
- `npx vue-tsc --noEmit` passes
- German templates use {{patientGenitive}}, {{patientDative}} variables
- TextOutput shows patient sex selector when language is German
- Generated German text uses correct patient grammatical forms
- Generated text varies based on selected status
- English text unchanged regardless of patient sex setting
  </verify>
  <done>
Templates updated with patient gender variables. TextOutput has patient sex selector (German only). Generated text reflects selected status and patient sex.
  </done>
</task>

</tasks>

<verification>
1. Type check: `npx vue-tsc --noEmit` passes
2. Dev server: `npm run dev` starts without errors
3. Functional test:
   - Navigate to Step 2, see 4 status options
   - Select each status, verify it persists through wizard
   - On Step 4 results, see patient sex selector (German mode only)
   - Toggle patient sex, see text update with correct grammatical forms
   - Switch language to English, patient sex selector hidden, text unchanged
   - Copy text, verify clipboard contains correct content
</verification>

<success_criteria>
- GAP-03-01 closed: IndexPatientStatus has 4 values, StepStatus offers 4 options, German text opening varies by status
- GAP-03-02 closed: PatientSex type exists, TextOutput has German-only sex selector, templates use gender-declined patient references
- All existing functionality preserved (perspectives, sections, copy, language toggle)
- Type safety maintained throughout
</success_criteria>

<output>
After completion, create `.planning/phases/03-german-text/03-04-SUMMARY.md`
</output>
