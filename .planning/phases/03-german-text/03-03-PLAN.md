---
phase: 03-german-text
plan: 03
type: execute
wave: 3
depends_on: ["03-02"]
files_modified:
  - src/components/wizard/TextOutput.vue
  - src/components/wizard/StepResults.vue
autonomous: false

must_haves:
  truths:
    - "User can select perspective (affected, carrier, family member)"
    - "User can toggle individual text sections on/off"
    - "Generated text updates live as user changes options"
    - "Copy button copies complete text to clipboard"
    - "Copied state shows visual feedback for 2 seconds"
  artifacts:
    - path: "src/components/wizard/TextOutput.vue"
      provides: "Text generation UI with perspective selector, section toggles, preview, copy button"
      min_lines: 100
    - path: "src/components/wizard/StepResults.vue"
      provides: "Integration of TextOutput below results table"
      contains: "TextOutput"
  key_links:
    - from: "src/components/wizard/TextOutput.vue"
      to: "src/composables/useTextGenerator.ts"
      via: "useTextGenerator import"
      pattern: "useTextGenerator\\("
    - from: "src/components/wizard/TextOutput.vue"
      to: "@vueuse/core"
      via: "useClipboard import"
      pattern: "useClipboard\\("
    - from: "src/components/wizard/StepResults.vue"
      to: "src/components/wizard/TextOutput.vue"
      via: "component import"
      pattern: "import TextOutput"
---

<objective>
Create the TextOutput component with perspective selector, section toggles, live preview, and copy-to-clipboard functionality. Integrate into StepResults.

Purpose: Allow users to generate, customize, and copy German/English clinical documentation text.
Output: Complete Phase 3 German Text functionality meeting TEXT-01 through TEXT-04 requirements.
</objective>

<execution_context>
@~/.claude/get-shit-done/workflows/execute-plan.md
@~/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/03-german-text/03-CONTEXT.md
@.planning/phases/03-german-text/03-RESEARCH.md
@.planning/phases/03-german-text/03-01-SUMMARY.md
@.planning/phases/03-german-text/03-02-SUMMARY.md

@src/components/wizard/StepResults.vue
@src/composables/useTextGenerator.ts
@src/stores/useTemplateStore.ts
@src/types/text.ts
</context>

<tasks>

<task type="auto">
  <name>Task 1: Create TextOutput component</name>
  <files>src/components/wizard/TextOutput.vue</files>
  <action>
Create src/components/wizard/TextOutput.vue - the main text generation UI component.

**Component structure:**

1. **Props** (receive from StepResults):
   - result: CarrierFrequencyResult | null
   - frequencySource: FrequencySource
   - indexStatus: IndexPatientStatus
   - literatureFrequency: number | null
   - literaturePmid: string | null
   - usingDefault: boolean

2. **Template sections:**

   a) **Header row** with:
      - Title: "Clinical Text" / "Klinischer Text"
      - Language toggle (DE/EN buttons or switch)
      - Gender style selector (dropdown: *, :, /, traditional)

   b) **Perspective selector** (v-btn-toggle or v-tabs):
      - "Betroffener Patient" / "Affected Patient"
      - "Anlagetrager" / "Carrier"
      - "Familienmitglied" / "Family Member"
      - Default to 'affected'

   c) **Section toggles** (v-checkbox group or v-chip-group):
      - Show all available sections for selected perspective
      - Each checkbox toggles section on/off
      - Toggling updates generated text immediately

   d) **Text preview** (v-card with pre-wrap text):
      - Shows generated text with current settings
      - Uses computed property that calls generateText(perspective)
      - Updates reactively as perspective/sections change
      - Use `white-space: pre-wrap` for line breaks

   e) **Copy button** (v-btn):
      - Uses VueUse useClipboard with legacy: true fallback
      - Shows "Kopieren" / "Copy" normally
      - Shows "Kopiert!" / "Copied!" for 2 seconds after click
      - Use `copied` ref from useClipboard for state

**Script setup:**

```typescript
import { ref, computed, watch } from 'vue';
import { useClipboard } from '@vueuse/core';
import { useTextGenerator } from '@/composables';
import type {
  Perspective,
  FrequencySource,
  IndexPatientStatus,
  CarrierFrequencyResult,
} from '@/types';

const props = defineProps<{
  result: CarrierFrequencyResult | null;
  frequencySource: FrequencySource;
  indexStatus: IndexPatientStatus;
  literatureFrequency: number | null;
  literaturePmid: string | null;
  usingDefault: boolean;
}>();

const selectedPerspective = ref<Perspective>('affected');

// Pass props as getter function to composable
const {
  generateText,
  getSections,
  language,
  genderStyle,
  setLanguage,
  setGenderStyle,
  toggleSection,
} = useTextGenerator(() => ({
  result: props.result,
  frequencySource: props.frequencySource,
  indexStatus: props.indexStatus,
  literatureFrequency: props.literatureFrequency,
  literaturePmid: props.literaturePmid,
  usingDefault: props.usingDefault,
}));

// Clipboard
const { copy, copied } = useClipboard({
  legacy: true,
  copiedDuring: 2000,
});

// Generated text (reactive to perspective and section changes)
const generatedText = computed(() => generateText(selectedPerspective.value));

// Available sections for current perspective
const availableSections = computed(() => getSections(selectedPerspective.value));

// UI labels based on language
const labels = computed(() => language.value === 'de' ? {
  title: 'Klinischer Text',
  copy: 'Text kopieren',
  copied: 'Kopiert!',
  perspectives: {
    affected: 'Betroffener Patient',
    carrier: 'Anlagetrager/in',
    familyMember: 'Familienmitglied',
  },
  genderStyles: {
    '*': 'Genderstern (*)',
    ':': 'Doppelpunkt (:)',
    '/': 'Schragstrich (/)',
    'traditional': 'Traditionell',
  },
} : {
  title: 'Clinical Text',
  copy: 'Copy text',
  copied: 'Copied!',
  perspectives: {
    affected: 'Affected Patient',
    carrier: 'Carrier',
    familyMember: 'Family Member',
  },
  genderStyles: {
    '*': 'Asterisk (*)',
    ':': 'Colon (:)',
    '/': 'Slash (/)',
    'traditional': 'Traditional',
  },
});
```

**Styling notes:**
- Use Vuetify components throughout (v-card, v-btn, v-btn-toggle, v-checkbox, v-select)
- Text preview area should have good readability (decent font size, line height)
- Copy button should be prominent
- Section toggles should be compact (inline or chips)
  </action>
  <verify>Run `npm run dev`, navigate to results step, verify TextOutput renders without errors</verify>
  <done>TextOutput component renders with perspective selector, section toggles, live preview, and copy button</done>
</task>

<task type="auto">
  <name>Task 2: Integrate TextOutput into StepResults</name>
  <files>src/components/wizard/StepResults.vue</files>
  <action>
Update StepResults.vue to include the TextOutput component below the results table.

**Changes:**

1. Import TextOutput component:
```typescript
import TextOutput from './TextOutput.vue';
```

2. Add TextOutput after the "Range info" div and before the "Navigation buttons" div:

```vue
<!-- Text output section -->
<v-divider class="my-6" />

<TextOutput
  v-if="result"
  :result="result"
  :frequency-source="frequencySource"
  :index-status="indexStatus"
  :literature-frequency="literatureFrequency"
  :literature-pmid="literaturePmid"
  :using-default="usingDefault"
/>
```

3. Props are already available from the existing StepResults props - no changes needed to defineProps.

**Layout considerations:**
- Add v-divider between results table and text output for visual separation
- TextOutput should have adequate vertical spacing (my-4 or my-6)
- Keep navigation buttons at the very bottom
  </action>
  <verify>Run `npm run dev`, complete wizard to results step, verify TextOutput appears below results table</verify>
  <done>TextOutput integrated into StepResults, visible on step 4</done>
</task>

<task type="checkpoint:human-verify" gate="blocking">
  <name>Task 3: Verify complete text generation flow</name>
  <what-built>
Complete Phase 3 German Text functionality:
- Perspective selection (affected patient, carrier, family member)
- Section toggles for customizing output
- Live preview of generated clinical text
- Copy-to-clipboard with visual feedback
- Language switching (German/English)
- Gender-inclusive language options
  </what-built>
  <how-to-verify>
1. Run `npm run dev` and open http://localhost:5173
2. Complete wizard steps 1-3 (enter gene like "CFTR", select status, select frequency source)
3. On step 4 (Results), scroll down to see the TextOutput section
4. Verify:
   - [ ] Perspective buttons work (Affected/Carrier/Family Member)
   - [ ] Generated text changes when switching perspectives
   - [ ] Section checkboxes toggle sections on/off
   - [ ] Text preview updates immediately when toggling sections
   - [ ] Copy button works and shows "Copied!" feedback
   - [ ] Language switch works (DE/EN)
   - [ ] German text uses German clinical terminology
   - [ ] German numbers use comma (0,25% not 0.25%)
   - [ ] Source attribution shows correctly for the selected frequency source
5. Test with different frequency sources:
   - gnomAD: Should show gnomAD attribution with date
   - Literature: Should show PMID citation
   - Default: Should show default assumption text
  </how-to-verify>
  <resume-signal>Type "approved" if all checks pass, or describe specific issues to fix</resume-signal>
</task>

</tasks>

<verification>
1. `npm run dev` runs without errors
2. `npx vue-tsc --noEmit` passes
3. TextOutput component renders on step 4
4. Perspective selection works
5. Section toggles update preview immediately
6. Copy button copies text and shows feedback
7. Language switching works
8. German clinical terminology is correct
</verification>

<success_criteria>
TEXT-01: German clinical text generated based on calculation results
TEXT-02: User selects perspective (affected patient, carrier, family member)
TEXT-03: Text includes gene name, carrier frequency, source, and recurrence risk
TEXT-04: Copy-to-clipboard button for German text

All four Phase 3 requirements satisfied.
</success_criteria>

<output>
After completion, create `.planning/phases/03-german-text/03-03-SUMMARY.md`
</output>
