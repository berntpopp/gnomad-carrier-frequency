---
phase: 03-german-text
plan: 01
type: execute
wave: 1
depends_on: []
files_modified:
  - src/types/text.ts
  - src/types/index.ts
  - src/utils/template-renderer.ts
  - src/config/templates/de.json
  - src/config/templates/en.json
autonomous: true

must_haves:
  truths:
    - "Template variables can be replaced with context values"
    - "German templates contain correct clinical terminology"
    - "English templates mirror German structure"
    - "Missing variables are handled gracefully (empty string, no crash)"
  artifacts:
    - path: "src/types/text.ts"
      provides: "Text generation type definitions"
      exports: ["Perspective", "TextSection", "TemplateConfig", "TemplateContext"]
    - path: "src/utils/template-renderer.ts"
      provides: "Template interpolation function"
      exports: ["renderTemplate"]
    - path: "src/config/templates/de.json"
      provides: "German clinical text templates"
      contains: "Heterozygotenfrequenz"
    - path: "src/config/templates/en.json"
      provides: "English clinical text templates"
      contains: "carrier frequency"
  key_links:
    - from: "src/utils/template-renderer.ts"
      to: "src/types/text.ts"
      via: "TemplateContext type import"
      pattern: "import.*TemplateContext.*from"
---

<objective>
Create the template system foundation: types, template renderer utility, and default JSON template files for German and English clinical text.

Purpose: Establish the config-driven template architecture that allows clinical text generation with variable interpolation.
Output: Types, renderer function, and JSON template files ready for use by Pinia store and composable.
</objective>

<execution_context>
@~/.claude/get-shit-done/workflows/execute-plan.md
@~/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/03-german-text/03-CONTEXT.md
@.planning/phases/03-german-text/03-RESEARCH.md

@src/types/index.ts
@src/types/frequency.ts
@src/config/index.ts
@src/config/settings.json
</context>

<tasks>

<task type="auto">
  <name>Task 1: Create text generation types</name>
  <files>src/types/text.ts, src/types/index.ts</files>
  <action>
Create src/types/text.ts with the following type definitions:

1. `Perspective` type: 'affected' | 'carrier' | 'familyMember'

2. `GenderStyle` type: '*' | ':' | '/' | 'traditional'

3. `TextSection` interface with:
   - id: string (section identifier)
   - label: string (display label)
   - template: string (text with {{variables}})

4. `PerspectiveConfig` interface with:
   - label: string (display name for perspective)
   - sections: Record<string, TextSection>

5. `TemplateConfig` interface with:
   - language: 'de' | 'en'
   - perspectives: Record<Perspective, PerspectiveConfig>

6. `TemplateContext` interface for variable interpolation:
   - gene: string
   - carrierFrequency: string (pre-formatted with locale)
   - carrierFrequencyRatio: string (e.g., "1:25")
   - recurrenceRiskPercent: string (pre-formatted)
   - recurrenceRiskRatio: string (e.g., "1:400")
   - source: string (full attribution string)
   - indexStatus: 'carrier' | 'affected' (human-readable)
   - populationName?: string
   - pmid?: string
   - genderSuffix: string (e.g., "*innen", ":innen", "/-innen", "innen")
   - accessDate: string (formatted date)

Export all types from src/types/index.ts barrel file.
  </action>
  <verify>Run `npx vue-tsc --noEmit` to verify types compile without errors</verify>
  <done>Types exported and compile successfully, TemplateContext covers all variables from CONTEXT.md</done>
</task>

<task type="auto">
  <name>Task 2: Create template renderer utility</name>
  <files>src/utils/template-renderer.ts</files>
  <action>
Create src/utils/template-renderer.ts with a pure function for template interpolation:

```typescript
import type { TemplateContext } from '@/types';

/**
 * Renders a template string by replacing {{variable}} placeholders with context values.
 * Missing variables are replaced with empty string and logged as warnings.
 */
export function renderTemplate(
  template: string,
  context: Partial<TemplateContext>
): string {
  return template.replace(/\{\{(\w+)\}\}/g, (match, key) => {
    const value = context[key as keyof TemplateContext];
    if (value === undefined || value === null) {
      console.warn(`Template variable "${key}" is undefined`);
      return '';
    }
    return String(value);
  });
}
```

Key implementation notes:
- Pure function, no side effects except console.warn
- Uses regex to find all {{variableName}} patterns
- Gracefully handles missing variables (empty string, not crash)
- Works with partial context (not all variables required)
- Type-safe with TemplateContext
  </action>
  <verify>Create a quick test: `import { renderTemplate } from './template-renderer'; console.log(renderTemplate('Hello {{gene}}', { gene: 'CFTR' }));` - should output "Hello CFTR"</verify>
  <done>renderTemplate function handles variable interpolation with graceful missing variable handling</done>
</task>

<task type="auto">
  <name>Task 3: Create German and English template JSON files</name>
  <files>src/config/templates/de.json, src/config/templates/en.json</files>
  <action>
Create src/config/templates/ directory and add template JSON files.

**src/config/templates/de.json** - German clinical templates:

Structure with 3 perspectives (affected, carrier, familyMember) and 8 sections each:
1. geneIntro - Gene introduction
2. inheritance - Inheritance pattern (autosomal rezessiv)
3. carrierFrequency - Carrier frequency with source
4. recurrenceRisk - Recurrence risk calculation
5. populationContext - Global frequency note
6. founderEffect - Founder effect note (if applicable)
7. sourceCitation - Source details
8. recommendation - Family testing recommendation

Key German terminology from CONTEXT.md:
- Heterozygotenfrequenz (carrier frequency)
- Anlagetrager{{genderSuffix}} (carrier with gender suffix)
- Wiederholungsrisiko (recurrence risk)
- compound heterozygot
- autosomal rezessiv

Example sections for "affected" perspective:
- geneIntro: "Bei dem Patienten wurde eine pathogene Variante im {{gene}}-Gen nachgewiesen."
- inheritance: "Die Eltern des Patienten sind mit groBer Wahrscheinlichkeit jeweils heterozygote Anlagetrager{{genderSuffix}}."
- carrierFrequency: "Bei einer geschatzten Heterozygotenfrequenz von {{carrierFrequencyRatio}} {{source}} ..."
- recurrenceRisk: "... lage das Risiko fur eine {{gene}}-assoziierte Erkrankung bei Nachkommen des Patienten bei etwa {{recurrenceRiskPercent}} ({{recurrenceRiskRatio}})."
- recommendation: "Familienangehorigen kann eine Untersuchung auf die hier nachgewiesene Variante angeboten werden."

Use German decimal format in example: "0,25%" not "0.25%"
Use German date format: "19.01.2026" not "2026-01-19"

**src/config/templates/en.json** - English clinical templates:

Mirror German structure with equivalent clinical English:
- carrier frequency, recurrence risk, autosomal recessive
- Adjust phrasing for natural English clinical style
- Use English decimal format: "0.25%"
- Use English date format: "January 19, 2026"

Both files must be valid JSON with identical structure (same perspective keys, same section keys).
  </action>
  <verify>Run `node -e "const de = require('./src/config/templates/de.json'); const en = require('./src/config/templates/en.json'); console.log('DE perspectives:', Object.keys(de.perspectives)); console.log('EN perspectives:', Object.keys(en.perspectives));"` - both should show ['affected', 'carrier', 'familyMember']</verify>
  <done>German and English template files exist with matching structure, German uses clinical terminology from CONTEXT.md reference text</done>
</task>

</tasks>

<verification>
1. `npx vue-tsc --noEmit` passes (types valid)
2. Template JSON files are valid JSON and parseable
3. German templates contain: Heterozygotenfrequenz, Anlagetrager, Wiederholungsrisiko
4. English templates mirror German structure (same keys)
5. Template variables use correct names from TemplateContext type
</verification>

<success_criteria>
- Types exported from @/types barrel
- renderTemplate handles {{variable}} interpolation
- German templates use clinical terminology from reference
- English templates have identical structure
- All template variables match TemplateContext type
</success_criteria>

<output>
After completion, create `.planning/phases/03-german-text/03-01-SUMMARY.md`
</output>
