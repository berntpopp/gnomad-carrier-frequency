---
phase: 12-pwa
plan: 02
type: execute
wave: 2
depends_on: ["12-01"]
files_modified:
  - src/composables/usePwaInstall.ts
  - src/composables/useNetworkStatus.ts
  - src/composables/index.ts
  - src/components/OfflineIndicator.vue
  - src/components/SettingsDialog.vue
  - src/components/AppBar.vue
autonomous: true

must_haves:
  truths:
    - "User can see when app is offline via subtle indicator"
    - "User can install app from Settings dialog"
    - "User sees 'Back online' notification when connection restored"
    - "iOS users see manual install instructions"
  artifacts:
    - path: "src/composables/usePwaInstall.ts"
      provides: "Install prompt management composable"
      exports: ["usePwaInstall"]
    - path: "src/composables/useNetworkStatus.ts"
      provides: "Network status with notifications"
      exports: ["useNetworkStatus"]
    - path: "src/components/OfflineIndicator.vue"
      provides: "Subtle offline badge component"
    - path: "src/components/SettingsDialog.vue"
      provides: "Install App section in General tab"
      contains: "Install App"
  key_links:
    - from: "src/components/AppBar.vue"
      to: "src/components/OfflineIndicator.vue"
      via: "component import"
      pattern: "OfflineIndicator"
    - from: "src/components/SettingsDialog.vue"
      to: "src/composables/usePwaInstall.ts"
      via: "composable import"
      pattern: "usePwaInstall"
---

<objective>
Create install and offline UI components with composables for PWA functionality.

Purpose: Enable users to install the app from Settings and see network status via a subtle offline indicator in the app bar.

Output: usePwaInstall composable, useNetworkStatus composable, OfflineIndicator component, Settings install section.
</objective>

<execution_context>
@~/.claude/get-shit-done/workflows/execute-plan.md
@~/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/12-pwa/12-CONTEXT.md
@.planning/phases/12-pwa/12-RESEARCH.md
@.planning/phases/12-pwa/12-01-SUMMARY.md
@src/components/AppBar.vue
@src/components/SettingsDialog.vue
@src/composables/index.ts
</context>

<tasks>

<task type="auto">
  <name>Task 1: Create PWA install and network status composables</name>
  <files>src/composables/usePwaInstall.ts, src/composables/useNetworkStatus.ts, src/composables/index.ts</files>
  <action>
1. Create src/composables/usePwaInstall.ts:
   - Export function usePwaInstall()
   - Use refs: deferredPrompt (BeforeInstallPromptEvent | null), canInstall (boolean), isInstalled (boolean)
   - On mount, add event listeners for 'beforeinstallprompt' and 'appinstalled'
   - handleBeforeInstallPrompt: preventDefault, store event in deferredPrompt, set canInstall true
   - handleAppInstalled: set isInstalled true, canInstall false, clear deferredPrompt
   - promptInstall function: call deferredPrompt.prompt(), await userChoice, return whether accepted
   - Check if already installed via matchMedia('(display-mode: standalone)').matches
   - Detect iOS: check /iPad|iPhone|iPod/.test(navigator.userAgent) && !('MSStream' in window)
   - On unmount, remove event listeners
   - Return: canInstall, isInstalled, isIos, promptInstall

2. Create src/composables/useNetworkStatus.ts:
   - Import useOnline from '@vueuse/core'
   - Export function useNetworkStatus()
   - Use useOnline() for reactive online status
   - Use ref for showBackOnlineNotification
   - Watch isOnline: when changes from false to true, set showBackOnlineNotification true
   - Auto-hide notification after 3 seconds with setTimeout
   - Return: isOnline, showBackOnlineNotification, dismissBackOnlineNotification

3. Update src/composables/index.ts:
   - Export usePwaInstall from './usePwaInstall'
   - Export useNetworkStatus from './useNetworkStatus'
  </action>
  <verify>
- `bun run typecheck` passes
- Composables export correct types and functions
  </verify>
  <done>usePwaInstall and useNetworkStatus composables created and exported</done>
</task>

<task type="auto">
  <name>Task 2: Create OfflineIndicator component and integrate into AppBar</name>
  <files>src/components/OfflineIndicator.vue, src/components/AppBar.vue</files>
  <action>
1. Create src/components/OfflineIndicator.vue:
   - Import useNetworkStatus composable
   - Template: v-chip with v-if="!isOnline"
     - size="small"
     - color="warning"
     - variant="tonal"
     - prepend-icon="mdi-wifi-off"
     - Text: "Offline"
   - Add aria-label for accessibility
   - Style: add subtle transition for appearance

2. Update src/components/AppBar.vue:
   - Import OfflineIndicator component
   - Import useNetworkStatus composable
   - Add OfflineIndicator between logo and spacer (or after spacer before theme toggle)
   - Add v-snackbar for "Back online" notification:
     - v-model="showBackOnlineNotification"
     - timeout="3000"
     - color="success"
     - location="top"
     - Text: "Back online"
     - Close button to dismiss early

The offline indicator should be subtle and positioned consistently with the app bar layout. Per CONTEXT.md: "Subtle indicator (small icon/badge) when app is offline".
  </action>
  <verify>
- `bun run dev` shows app bar correctly
- Disconnecting network (DevTools offline mode) shows offline chip
- Reconnecting shows "Back online" snackbar briefly
  </verify>
  <done>OfflineIndicator component displays in AppBar when offline, back online notification shows</done>
</task>

<task type="auto">
  <name>Task 3: Add Install App section to SettingsDialog</name>
  <files>src/components/SettingsDialog.vue</files>
  <action>
Update SettingsDialog.vue to add an "Install App" section in the General tab:

1. Import usePwaInstall composable

2. In General tab, after the "Application Logging" section, add new v-card:
   - variant="outlined" class="mb-4"
   - v-card-title with mdi-download icon: "Install App"
   - v-card-text content depends on state:

   a) If isInstalled:
      - Show success message: "App is installed and ready to use offline."
      - mdi-check-circle icon, success color

   b) If canInstall (browser supports install):
      - Description: "Install gCFCalc on your device for quick access and offline use."
      - v-btn "Install" with prepend-icon="mdi-download"
      - @click calls promptInstall()

   c) If isIos:
      - Show iOS-specific instructions:
        "To install on iOS: tap the Share button, then 'Add to Home Screen'."
      - mdi-apple icon
      - Small instructional text

   d) Else (not installable, not iOS):
      - Show fallback: "Install option not available in this browser. Try Chrome, Edge, or Safari on iOS."
      - Subdued text style

Per CONTEXT.md: "Never auto-prompt for installation - user must discover install option themselves"
Per CONTEXT.md: "Install option always available in settings regardless of user actions"
  </action>
  <verify>
- Settings dialog opens without errors
- Install App section visible in General tab
- Install button appears when browser supports PWA install
- iOS shows manual instructions
- Already-installed state shows confirmation
  </verify>
  <done>Install App section added to SettingsDialog with all states handled</done>
</task>

</tasks>

<verification>
1. `bun run typecheck` passes
2. `bun run dev` - app runs without errors
3. Offline indicator visible when network disconnected
4. "Back online" notification appears when reconnected
5. Settings > General shows Install App section
6. Install button triggers browser install prompt (if supported)
</verification>

<success_criteria>
- usePwaInstall composable handles install prompt lifecycle
- useNetworkStatus composable provides reactive online state with notifications
- OfflineIndicator component shows subtle badge when offline
- AppBar displays offline indicator and back-online snackbar
- SettingsDialog has Install App section with install button or iOS instructions
</success_criteria>

<output>
After completion, create `.planning/phases/12-pwa/12-02-SUMMARY.md`
</output>
