---
phase: 12-pwa
plan: 01
type: execute
wave: 1
depends_on: []
files_modified:
  - package.json
  - vite.config.ts
  - src/vite-env.d.ts
  - public/icons/pwa-192x192.png
  - public/icons/pwa-512x512.png
  - public/icons/maskable-512x512.png
  - pwa-assets.config.ts
autonomous: true

must_haves:
  truths:
    - "App has valid web manifest with icons and metadata"
    - "Service worker caches app shell and static assets"
    - "gnomAD API responses cached with 24-hour expiration"
  artifacts:
    - path: "vite.config.ts"
      provides: "VitePWA plugin configuration"
      contains: "VitePWA"
    - path: "public/icons/pwa-192x192.png"
      provides: "PWA icon 192x192"
    - path: "public/icons/pwa-512x512.png"
      provides: "PWA icon 512x512"
    - path: "public/icons/maskable-512x512.png"
      provides: "Maskable PWA icon"
    - path: "src/vite-env.d.ts"
      provides: "TypeScript declarations for PWA"
      contains: "BeforeInstallPromptEvent"
  key_links:
    - from: "vite.config.ts"
      to: "public/icons/*.png"
      via: "manifest.icons array"
      pattern: "icons/pwa-.*\\.png"
---

<objective>
Configure PWA infrastructure with vite-plugin-pwa, generate icons, and set up service worker caching.

Purpose: Enable the app to be installable and work offline by configuring the web manifest, generating required icons, and setting up Workbox caching strategies.

Output: Vite config with PWA plugin, PNG icons in public/icons/, TypeScript declarations for PWA APIs.
</objective>

<execution_context>
@~/.claude/get-shit-done/workflows/execute-plan.md
@~/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/12-pwa/12-CONTEXT.md
@.planning/phases/12-pwa/12-RESEARCH.md
@vite.config.ts
@package.json
@src/vite-env.d.ts
@public/favicon.svg
</context>

<tasks>

<task type="auto">
  <name>Task 1: Install PWA dependencies and generate icons</name>
  <files>package.json, pwa-assets.config.ts, public/icons/</files>
  <action>
1. Install vite-plugin-pwa as dev dependency:
   ```bash
   bun add -D vite-plugin-pwa
   ```

2. Create pwa-assets.config.ts in project root for icon generation:
   - Use @vite-pwa/assets-generator minimal2023Preset concept
   - Target sizes: 192x192, 512x512 for standard, 512x512 for maskable, 180x180 for apple-touch-icon
   - Source: public/favicon.svg

3. Generate PNG icons manually using a Node script or sharp:
   - Create public/icons/ directory
   - Generate pwa-192x192.png (192x192 from favicon.svg)
   - Generate pwa-512x512.png (512x512 from favicon.svg)
   - Generate maskable-512x512.png (512x512 with 10% safe zone padding for maskable)
   - Update apple-touch-icon.png if needed (180x180)

NOTE: Since @vite-pwa/assets-generator requires sharp which can be complex to install, generate icons using a simple approach:
- Use existing favicon.svg as base
- Create icons via online tool or simple script if sharp unavailable
- Alternatively, use Inkscape/ImageMagick CLI if available on system

If automated generation is not feasible, create placeholder icons and document the manual step needed.
  </action>
  <verify>
- `ls public/icons/` shows pwa-192x192.png, pwa-512x512.png, maskable-512x512.png
- `bun run build` completes without errors
  </verify>
  <done>PWA icons exist in public/icons/ directory at required sizes</done>
</task>

<task type="auto">
  <name>Task 2: Configure vite-plugin-pwa with manifest and caching</name>
  <files>vite.config.ts</files>
  <action>
Add VitePWA plugin to vite.config.ts:

1. Import VitePWA from 'vite-plugin-pwa'

2. Add VitePWA plugin to plugins array with configuration:
   - registerType: 'prompt' (user decides when to update)
   - includeAssets: ['favicon.svg', 'favicon.ico', 'apple-touch-icon.png', 'favicon.png']
   - manifest object:
     - name: 'gCFCalc - Carrier Frequency Calculator'
     - short_name: 'gCFCalc'
     - description: 'Calculate carrier frequency and recurrence risk for autosomal recessive conditions'
     - theme_color: '#a09588' (RequiForm palette from CONTEXT.md)
     - background_color: '#ffffff'
     - display: 'standalone'
     - start_url: '/gnomad-carrier-frequency/'
     - scope: '/gnomad-carrier-frequency/'
     - icons array with 192x192, 512x512, and maskable 512x512

3. workbox configuration:
   - cleanupOutdatedCaches: true
   - globPatterns: ['**/*.{js,css,html,ico,png,svg,woff2}']
   - navigateFallback: 'index.html'
   - runtimeCaching for gnomAD API:
     - urlPattern: /^https:\/\/gnomad\.broadinstitute\.org\/api/
     - handler: 'NetworkFirst'
     - cacheName: 'gnomad-api-cache'
     - expiration: maxEntries 50, maxAgeSeconds 86400 (24 hours per CONTEXT.md)
     - cacheableResponse: statuses [0, 200]
   - runtimeCaching for ClinGen API (same pattern, separate cache):
     - urlPattern: /^https:\/\/search\.clinicalgenome\.org\/api/
     - handler: 'NetworkFirst'
     - cacheName: 'clingen-api-cache'
     - expiration: maxEntries 100, maxAgeSeconds 86400

4. devOptions: enabled: false (don't enable PWA in dev by default)

Preserve existing plugins (vue, checker) and config options (base, resolve, server).
  </action>
  <verify>
- `bun run build` succeeds
- `dist/manifest.webmanifest` exists after build
- `dist/sw.js` exists after build (service worker)
  </verify>
  <done>vite.config.ts has VitePWA plugin with manifest and Workbox caching configured</done>
</task>

<task type="auto">
  <name>Task 3: Add TypeScript declarations for PWA APIs</name>
  <files>src/vite-env.d.ts</files>
  <action>
Extend src/vite-env.d.ts with PWA-related type declarations:

1. Add reference to vite-plugin-pwa client types:
   ```typescript
   /// <reference types="vite-plugin-pwa/client" />
   ```

2. Add BeforeInstallPromptEvent interface:
   ```typescript
   interface BeforeInstallPromptEvent extends Event {
     readonly platforms: string[]
     readonly userChoice: Promise<{
       outcome: 'accepted' | 'dismissed'
       platform: string
     }>
     prompt(): Promise<void>
   }
   ```

3. Extend global WindowEventMap:
   ```typescript
   declare global {
     interface WindowEventMap {
       beforeinstallprompt: BeforeInstallPromptEvent
     }
   }
   ```

Preserve existing declarations (ImportMetaEnv, Vuetify modules).
  </action>
  <verify>
- `bun run typecheck` passes
- No TypeScript errors related to PWA types
  </verify>
  <done>TypeScript declarations for PWA APIs added to vite-env.d.ts</done>
</task>

</tasks>

<verification>
1. `bun run build` completes successfully
2. Build output contains manifest.webmanifest and sw.js
3. `bun run typecheck` passes
4. Icons exist at public/icons/*.png
</verification>

<success_criteria>
- PWA plugin configured in vite.config.ts with manifest and Workbox caching
- PNG icons generated for all required sizes (192, 512, maskable)
- TypeScript declarations added for BeforeInstallPromptEvent
- Build produces manifest.webmanifest and sw.js service worker
</success_criteria>

<output>
After completion, create `.planning/phases/12-pwa/12-01-SUMMARY.md`
</output>
