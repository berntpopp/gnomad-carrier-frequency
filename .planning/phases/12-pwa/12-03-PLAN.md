---
phase: 12-pwa
plan: 03
type: execute
wave: 2
depends_on: ["12-01"]
files_modified:
  - src/composables/usePwaUpdate.ts
  - src/composables/index.ts
  - src/components/SettingsDialog.vue
  - src/App.vue
autonomous: true

must_haves:
  truths:
    - "User sees notification when new app version available"
    - "User can update to new version from notification"
    - "User can clear gene data cache from Settings"
    - "User sees cache storage information in Settings"
  artifacts:
    - path: "src/composables/usePwaUpdate.ts"
      provides: "Service worker update management"
      exports: ["usePwaUpdate"]
    - path: "src/components/SettingsDialog.vue"
      provides: "Cache management controls"
      contains: "Clear Cache"
    - path: "src/App.vue"
      provides: "Update notification snackbar"
      contains: "needRefresh"
  key_links:
    - from: "src/App.vue"
      to: "src/composables/usePwaUpdate.ts"
      via: "composable import"
      pattern: "usePwaUpdate"
    - from: "src/composables/usePwaUpdate.ts"
      to: "virtual:pwa-register"
      via: "registerSW import"
      pattern: "registerSW"
---

<objective>
Implement service worker update handling and cache management UI.

Purpose: Allow users to update to new app versions and manage cached gene data from Settings.

Output: usePwaUpdate composable for update notifications, cache management in Settings, update notification in App.vue.
</objective>

<execution_context>
@~/.claude/get-shit-done/workflows/execute-plan.md
@~/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/12-pwa/12-CONTEXT.md
@.planning/phases/12-pwa/12-RESEARCH.md
@.planning/phases/12-pwa/12-01-SUMMARY.md
@src/App.vue
@src/components/SettingsDialog.vue
@src/composables/index.ts
</context>

<tasks>

<task type="auto">
  <name>Task 1: Create usePwaUpdate composable for service worker updates</name>
  <files>src/composables/usePwaUpdate.ts, src/composables/index.ts</files>
  <action>
1. Create src/composables/usePwaUpdate.ts:
   - Import registerSW from 'virtual:pwa-register'
   - Export function usePwaUpdate()
   - Use refs: needRefresh (boolean), offlineReady (boolean)
   - Call registerSW with callbacks:
     - onNeedRefresh: () => { needRefresh.value = true }
     - onOfflineReady: () => { offlineReady.value = true }
   - Store updateSW function reference from registerSW return
   - Create updateApp function: calls updateSW(true) to activate waiting SW
   - Create dismissUpdate function: sets needRefresh to false (user declined)
   - Return: needRefresh, offlineReady, updateApp, dismissUpdate

2. Update src/composables/index.ts:
   - Export usePwaUpdate from './usePwaUpdate'

The registerSW function is provided by vite-plugin-pwa's virtual module.
Per CONTEXT.md: "On app version update: clear app shell cache but preserve gene data cache" - this is handled by Workbox's cleanupOutdatedCaches which only clears the precache, not runtime caches like gnomad-api-cache.
  </action>
  <verify>
- `bun run typecheck` passes
- No import errors for 'virtual:pwa-register'
  </verify>
  <done>usePwaUpdate composable created for service worker update management</done>
</task>

<task type="auto">
  <name>Task 2: Add cache management to SettingsDialog</name>
  <files>src/components/SettingsDialog.vue</files>
  <action>
Add a "Data Cache" section to the General tab in SettingsDialog:

1. Create helper functions for cache management (can be in component or separate util):
   - async clearGeneDataCache(): Promise<boolean>
     - Uses caches.delete('gnomad-api-cache')
     - Also delete 'clingen-api-cache'
     - Returns true if successful
   - async getCacheInfo(): Promise<{ usage: number; quota: number } | null>
     - Uses navigator.storage.estimate() if available
     - Returns usage and quota in bytes

2. In General tab, after "Install App" section (or before Logging), add new v-card:
   - variant="outlined" class="mb-4"
   - v-card-title with mdi-cached icon: "Data Cache"
   - v-card-text content:
     - Show cache status:
       - "Gene and API data cached for offline use"
       - Storage usage if available: "Using X MB of Y MB"
       - Or fallback: "Storage information not available"
     - v-btn "Clear Cache" with:
       - variant="outlined"
       - size="small"
       - color="warning"
       - prepend-icon="mdi-delete"
       - @click calls clearGeneDataCache, shows confirmation/result
     - Caption text: "Clearing cache will remove offline gene data. Fresh data will be fetched on next use."

3. Add reactive state for cache info:
   - cacheInfo ref
   - cacheClearing ref for loading state
   - loadCacheInfo function called on dialog open
   - clearCache function with confirmation

Per CONTEXT.md: "Manual 'Clear cache' button available in settings"
Per CONTEXT.md: "Gene/variant data cached for 24 hours before considered stale"
  </action>
  <verify>
- Settings dialog shows Data Cache section
- Clear Cache button works (can test by checking caches in DevTools)
- Storage info displayed if browser supports navigator.storage.estimate
  </verify>
  <done>Data Cache section with Clear Cache button added to SettingsDialog</done>
</task>

<task type="auto">
  <name>Task 3: Wire update notifications into App.vue</name>
  <files>src/App.vue</files>
  <action>
Add update notification UI to App.vue:

1. Import usePwaUpdate and useNetworkStatus composables

2. Initialize composables:
   - const { needRefresh, offlineReady, updateApp, dismissUpdate } = usePwaUpdate()
   - const { showBackOnlineNotification, dismissBackOnlineNotification } = useNetworkStatus()

3. Add v-snackbar for "New version available":
   - v-model="needRefresh"
   - timeout="-1" (persistent until user acts)
   - location="bottom"
   - color="primary"
   - Content: "A new version is available"
   - Action buttons:
     - "Update" button: @click="updateApp()" color="white"
     - "Later" button: @click="dismissUpdate()" variant="text"

4. Add v-snackbar for "Ready for offline use" (first install):
   - v-model="offlineReady"
   - timeout="5000"
   - location="bottom"
   - color="success"
   - Content: "App ready for offline use"
   - Close button

5. Add v-snackbar for "Back online":
   - v-model="showBackOnlineNotification"
   - timeout="3000"
   - location="top"
   - color="success"
   - Content: "Back online"
   - Can use same pattern as offlineReady snackbar

Note: The "Back online" snackbar may already be in AppBar from Plan 02. If so, keep it there for consistency with the offline indicator. Only add the update/offline-ready snackbars to App.vue since they are app-level concerns.

Per CONTEXT.md: "Show brief 'Back online' notification when connection restored"
  </action>
  <verify>
- `bun run build` succeeds
- `bun run preview` serves the built app
- In DevTools Application > Service Workers, service worker registers
- Simulating update (modify code, rebuild, refresh) shows update notification
  </verify>
  <done>Update and offline-ready notifications wired into App.vue</done>
</task>

</tasks>

<verification>
1. `bun run build` completes successfully
2. `bun run preview` serves app with service worker
3. Application > Service Workers shows registered SW in DevTools
4. Settings > General shows Data Cache section with Clear Cache
5. Update notification appears when new version available (test by rebuilding)
6. "Ready for offline use" notification appears on first visit
</verification>

<success_criteria>
- usePwaUpdate composable handles SW update lifecycle
- SettingsDialog has Data Cache section with storage info and clear button
- App.vue shows update notification when new version available
- App.vue shows offline-ready notification on first successful caching
- Cache clearing works and removes gnomad-api-cache and clingen-api-cache
</success_criteria>

<output>
After completion, create `.planning/phases/12-pwa/12-03-SUMMARY.md`
</output>
