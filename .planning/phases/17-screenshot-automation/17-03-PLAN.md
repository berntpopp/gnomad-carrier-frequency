---
phase: 17-screenshot-automation
plan: 03
type: execute
wave: 2
depends_on: ["17-01", "17-02"]
files_modified:
  - scripts/generate-screenshots.ts
  - Makefile
autonomous: true

must_haves:
  truths:
    - "Running `make screenshots` produces 14 WebP files in docs/public/screenshots/"
    - "Each screenshot shows realistic CFTR data, not empty or error states"
    - "Desktop screenshots are 1200x800, mobile screenshot is 375x812"
    - "Dark mode screenshot shows the same results page state as light mode"
    - "Population drill-down screenshot shows Ashkenazi Jewish variant data"
    - "Search history screenshot shows at least one history entry"
    - "Settings dialog screenshot shows the General tab"
  artifacts:
    - path: "docs/public/screenshots/hero-preview.webp"
      provides: "Landing page hero image - Step 1 with gene selected"
    - path: "docs/public/screenshots/step-1-gene-search.webp"
      provides: "Gene search autocomplete with CFTR dropdown"
    - path: "docs/public/screenshots/step-1-gene-selected.webp"
      provides: "CFTR selected with ClinGen + constraint cards"
    - path: "docs/public/screenshots/step-2-patient-status.webp"
      provides: "Step 2 with heterozygous carrier selected"
    - path: "docs/public/screenshots/step-3-frequency.webp"
      provides: "Step 3 gnomAD tab with calculated frequency"
    - path: "docs/public/screenshots/step-4-results.webp"
      provides: "Step 4 full results page"
    - path: "docs/public/screenshots/text-output.webp"
      provides: "German clinical text with section chips"
    - path: "docs/public/screenshots/variant-table.webp"
      provides: "Variant table modal with columns and ClinVar data"
    - path: "docs/public/screenshots/filter-chips.webp"
      provides: "Filter section with chip toggles"
    - path: "docs/public/screenshots/settings-dialog.webp"
      provides: "Settings dialog General tab"
    - path: "docs/public/screenshots/dark-mode-results.webp"
      provides: "Results page in dark theme"
    - path: "docs/public/screenshots/mobile-results.webp"
      provides: "Results page at 375x812 mobile viewport"
    - path: "docs/public/screenshots/population-drilldown.webp"
      provides: "Ashkenazi Jewish population variant table"
    - path: "docs/public/screenshots/search-history.webp"
      provides: "History panel with saved CFTR entry"
  key_links:
    - from: "scripts/generate-screenshots.ts"
      to: "src/components/**/*.vue"
      via: "data-testid locators for navigation and interaction"
      pattern: "data-testid"
    - from: "Makefile"
      to: "scripts/generate-screenshots.ts"
      via: "npx tsx scripts/generate-screenshots.ts"
      pattern: "npx tsx"
---

<objective>
Add all 14 screenshot capture sequences to the existing script scaffold (from Plan 01) and update the Makefile `screenshots` target. Each capture involves navigating the app to the correct state using data-testid locators (from Plan 02), waiting for animations, and saving a WebP screenshot. The captures must follow the exact specifications from DOCUMENTATION-PLAN.md Section 3.4.

Purpose: This completes the core deliverable of Phase 17 -- generating all documentation screenshots from a single `make screenshots` command.
Output: 14 WebP files in docs/public/screenshots/, working Makefile target.
</objective>

<execution_context>
@~/.claude/get-shit-done/workflows/execute-plan.md
@~/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/17-screenshot-automation/17-CONTEXT.md
@.planning/phases/17-screenshot-automation/17-RESEARCH.md

Prior plan summaries (needed for script structure and data-testid names):
@.planning/phases/17-screenshot-automation/17-01-SUMMARY.md
@.planning/phases/17-screenshot-automation/17-02-SUMMARY.md

Key codebase references:
@scripts/generate-screenshots.ts (scaffold from Plan 01)
@Makefile (current placeholder target)
@src/components/wizard/WizardStepper.vue (stepper navigation)
@src/components/wizard/StepResults.vue (results page structure)
@src/components/SettingsDialog.vue (dialog with tabs)
@src/components/HistoryPanel.vue (history entries)
</context>

<tasks>

<task type="auto">
  <name>Task 1: Add wizard flow screenshot captures (8 screenshots)</name>
  <files>scripts/generate-screenshots.ts</files>
  <action>
    Read the existing `scripts/generate-screenshots.ts` (from Plan 01) and add the first 8 screenshot capture sequences in the main() function where the placeholder comment is. Each capture is a function call that navigates the app to the required state and calls the `capture()` helper.

    **Screenshot sequence (must be in this order since wizard state is cumulative):**

    **1. hero-preview (SHOT-02):**
    - Start at Step 1 (app loads here by default)
    - Type "CFTR" in gene search input (`[data-testid="gene-search-input"]`) — the autocomplete will trigger a GeneSearch GraphQL call which is intercepted by fixtures
    - Wait for autocomplete dropdown to appear (look for Vuetify's `.v-list` or `.v-autocomplete__content` that becomes visible)
    - Select CFTR from the dropdown (click the list item containing "CFTR")
    - Wait for gene details to load (GeneDetails query intercepted), ClinGen warning and constraint card should appear
    - Wait for animations
    - Capture as `hero-preview` — this shows Step 1 with gene selected, info cards visible

    **2. step-1-gene-search (SHOT-03):**
    - We need the autocomplete dropdown visible. The previous capture had the gene already selected.
    - Reset: clear the gene search input (click the clearable X button on the autocomplete, or use `page.fill()`)
    - Type "CFT" (partial) in the gene search to trigger autocomplete dropdown
    - Wait for dropdown to appear with CFTR result
    - Capture as `step-1-gene-search` while dropdown is visible
    - IMPORTANT: The dropdown may close if focus is lost. Use `page.locator('[data-testid="gene-search-input"]').fill('CFT')` or equivalent, and wait for the dropdown items to appear.

    **3. step-1-gene-selected (SHOT-04):**
    - Select CFTR from the dropdown (click it)
    - Wait for ClinGen warning and gene constraint card to appear
    - Wait for animations
    - Capture as `step-1-gene-selected`

    **4. step-2-patient-status (SHOT-05):**
    - Click the Next/continue button on Step 1 (`[data-testid="step-gene-next-btn"]`)
    - Wait for Step 2 to appear (stepper transitions)
    - Wait for `[data-testid="step-status"]` to be visible
    - Select "Heterozygous carrier" option (`[data-testid="status-option-heterozygous"]`)
    - Wait for animations
    - Capture as `step-2-patient-status`

    **5. step-3-frequency (SHOT-06):**
    - Click Next on Step 2 (`[data-testid="step-status-next-btn"]`)
    - Wait for Step 3 to appear
    - Wait for `[data-testid="step-frequency"]` to be visible
    - The gnomAD tab should be selected by default (or click `[data-testid="freq-tab-gnomad"]`)
    - Wait for frequency to display (GeneVariants query fires and is intercepted)
    - Wait for animations
    - Capture as `step-3-frequency`

    **6. step-4-results (SHOT-07):**
    - Click Next on Step 3 (`[data-testid="step-frequency-next-btn"]`)
    - Wait for Step 4 to appear
    - Wait for `[data-testid="step-results"]` to be visible
    - Wait for population table to render (`[data-testid="population-table"]`)
    - Wait for animations
    - Capture as `step-4-results`

    **7. text-output (SHOT-08):**
    - Still on Step 4. The clinical text section should be visible below the results.
    - Scroll down to `[data-testid="text-output"]` if needed
    - Wait for text content to appear in `[data-testid="text-content"]`
    - Ensure section chips are visible (`[data-testid="text-section-chips"]`)
    - Capture as `text-output`
    - NOTE: May need to scroll the page so text output is in view. Use `page.locator('[data-testid="text-output"]').scrollIntoViewIfNeeded()`

    **8. variant-table (SHOT-09):**
    - Click to open the variant table modal. Look for a button/link on the results page that opens it. It might be:
      - A "View Variants" button on the results card
      - Or clicking on the variant count in the results summary
      - Check StepResults.vue for how VariantModal is triggered — look for the v-model or @click that opens it
    - Wait for `[data-testid="variant-modal"]` to be visible
    - Wait for table data to render inside the modal
    - Capture as `variant-table`
    - Close the modal (`[data-testid="variant-modal-close-btn"]`)

    **Implementation notes:**
    - Between captures, add brief waitForAnimations() calls
    - Each capture should be wrapped in a try/catch that logs which screenshot failed before re-throwing
    - Use descriptive console.log messages: `console.log('Capturing: hero-preview (Step 1 with gene selected)...')`
    - If any locator is not found within 10 seconds, the script should fail with a clear message about which element was expected
    - After the autocomplete dropdown interaction, the GeneSearch mock will return CFTR. Verify the fixture data matches what the app expects.
    - For scrolling, prefer `scrollIntoViewIfNeeded()` over `page.evaluate(window.scrollTo)`
  </action>
  <verify>
    - `npx tsx scripts/generate-screenshots.ts` runs and produces 8 WebP files:
      hero-preview.webp, step-1-gene-search.webp, step-1-gene-selected.webp,
      step-2-patient-status.webp, step-3-frequency.webp, step-4-results.webp,
      text-output.webp, variant-table.webp
    - `ls -la docs/public/screenshots/*.webp | wc -l` shows 8
    - Each file is > 10KB (not empty/corrupt)
    - `file docs/public/screenshots/hero-preview.webp` shows "RIFF...WEBP"
  </verify>
  <done>
    8 core wizard flow screenshots are generated successfully as WebP files. Each shows realistic CFTR data at the correct wizard step.
  </done>
</task>

<task type="auto">
  <name>Task 2: Add feature screenshot captures (6 screenshots) and update Makefile</name>
  <files>
    scripts/generate-screenshots.ts
    Makefile
  </files>
  <action>
    **Part A: Add 6 more screenshot captures to the script**

    Continue adding captures after the 8 wizard flow captures. These capture special UI states.

    **9. filter-chips (SHOT-10):**
    - Still on Step 4 results page (from previous captures)
    - Scroll to the filter chips area (`[data-testid="filter-chips"]`)
    - The filter chips should be visible inline on the results page (they are chip toggles, not a separate panel)
    - Wait for chips to render
    - Capture as `filter-chips`

    **10. settings-dialog (SHOT-11):**
    - Open settings dialog. Find the settings trigger button in the footer (`[data-testid="footer-settings-btn"]`). If footer isn't visible, scroll to bottom first.
    - Wait for `[data-testid="settings-dialog"]` to be visible
    - Ensure General tab is active (click `[data-testid="settings-tab-general"]` if needed — it should be default)
    - Wait for dialog content to render
    - Capture as `settings-dialog`
    - Close the dialog (click the close X button or press Escape)

    **11. dark-mode-results (SHOT-12):**
    - Close any open dialogs first
    - Switch to dark mode: `await page.emulateMedia({ colorScheme: 'dark' })`
    - The app uses Vuetify's theme which responds to `prefers-color-scheme`. If the app has its own theme toggle that doesn't respond to media query, you may need to:
      - Check if the app reads `prefers-color-scheme` or stores theme in Pinia/localStorage
      - If Pinia-based: inject `theme: 'dark'` in localStorage and reload
      - Try `emulateMedia` first — if the app uses Vuetify's `useTheme()` with system preference detection, this should work
    - Wait for theme transition to complete
    - Ensure we're still on Step 4 results (the dark mode shot should mirror the light mode results)
    - Capture as `dark-mode-results`
    - Switch back to light: `await page.emulateMedia({ colorScheme: 'light' })`
    - Wait for theme to revert

    **12. mobile-results (SHOT-13):**
    - Change viewport: `await page.setViewportSize({ width: 375, height: 812 })`
    - Wait for responsive layout to adjust (Vuetify breakpoints trigger)
    - Wait for animations
    - Still on Step 4 results
    - Capture as `mobile-results`
    - Reset viewport: `await page.setViewportSize({ width: 1200, height: 800 })`
    - Wait for layout to reset

    **13. population-drilldown (SHOT-14):**
    - Back on desktop viewport, Step 4 results
    - Find the Ashkenazi Jewish row in the population table (`[data-testid="population-table"]`)
    - Click the row for "Ashkenazi Jewish" (look for text content "Ashkenazi" in the table rows). Use `page.locator('[data-testid="population-table"]').locator('tr', { hasText: 'Ashkenazi' }).click()` or equivalent.
    - Wait for the drill-down view to appear (this opens a variant table specific to that population)
    - Wait for animations
    - Capture as `population-drilldown`
    - Navigate back or close the drill-down (click back or close button)

    **14. search-history (SHOT-15):**
    - Open the history panel. Find the history trigger in the footer (`[data-testid="footer-history-btn"]`) or wherever the history drawer opens from.
    - Wait for `[data-testid="history-drawer"]` or `[data-testid="history-panel"]` to be visible
    - The panel should show at least one entry (the demo CFTR entry from the localStorage fixture + any entry auto-saved from our wizard navigation)
    - Wait for entries to render
    - Capture as `search-history`
    - Close the history panel

    **Implementation notes:**
    - Population drill-down behavior: Check how StepResults.vue handles population row clicks. The population table rows are clickable and open a variant table filtered to that population. The "Ashkenazi Jewish" population code is "asj" in gnomAD.
    - For dark mode: the app may use Vuetify `useTheme()` which reads system preference. `page.emulateMedia({ colorScheme: 'dark' })` sets `prefers-color-scheme: dark` at the browser level. If the app overrides with an explicit theme stored in localStorage, this might not work — check and adapt.
    - For search history: the fixture pre-loads one history entry. The wizard navigation we just did may also auto-save to history. Either way, the panel should have entries.
    - Handle the case where elements might not be immediately visible — use `waitFor()` with reasonable timeouts (10s default).

    **Part B: Update Makefile**

    Replace the placeholder `screenshots` target in the Makefile with a working target:

    ```makefile
    # Generate documentation screenshots
    screenshots:
    	@echo "Generating documentation screenshots..."
    	@npx tsx scripts/generate-screenshots.ts
    	@echo "Screenshots saved to docs/public/screenshots/"
    ```

    The script handles its own dev server lifecycle (start/stop), so the Makefile target just runs the script. Remove the old placeholder message about "Phase 17".
  </action>
  <verify>
    - `npx tsx scripts/generate-screenshots.ts` produces all 14 WebP files
    - `ls docs/public/screenshots/*.webp | wc -l` shows 14
    - File names match: hero-preview.webp, step-1-gene-search.webp, step-1-gene-selected.webp, step-2-patient-status.webp, step-3-frequency.webp, step-4-results.webp, text-output.webp, variant-table.webp, filter-chips.webp, settings-dialog.webp, dark-mode-results.webp, mobile-results.webp, population-drilldown.webp, search-history.webp
    - Each file is > 10KB
    - `make screenshots` runs the full pipeline and exits with code 0
    - After `make screenshots`, all 14 files exist in docs/public/screenshots/
    - Dark mode screenshot is visually distinct from light mode (file sizes will differ)
    - Mobile screenshot dimensions: check with `identify docs/public/screenshots/mobile-results.webp` (if imagemagick available) or verify the viewport was set in the script
  </verify>
  <done>
    All 14 screenshots generated. `make screenshots` works end-to-end. SHOT-02 through SHOT-15 satisfied. MAKE-02 satisfied.
  </done>
</task>

</tasks>

<verification>
- `make screenshots` completes successfully, producing 14 WebP files
- All files in docs/public/screenshots/ are valid WebP images (> 10KB each)
- Screenshot filenames match the specification table from DOCUMENTATION-PLAN.md
- Desktop screenshots were captured at 1200x800 viewport
- Mobile screenshot was captured at 375x812 viewport
- Dark mode screenshot shows dark theme
- No orphaned processes after script completes
</verification>

<success_criteria>
- SHOT-01 fully satisfied (Playwright installed + working generation script)
- SHOT-02 through SHOT-15 satisfied (all 14 screenshots generated)
- SHOT-16 satisfied (data-testid from Plan 02)
- SHOT-17 satisfied (disclaimer auto-dismissed from Plan 01)
- MAKE-02 satisfied (Makefile target works)
- All 18 Phase 17 requirements complete
</success_criteria>

<output>
After completion, create `.planning/phases/17-screenshot-automation/17-03-SUMMARY.md`
</output>
