---
phase: 02-wizard-ui
plan: 03
type: execute
wave: 3
depends_on: ["02-02"]
files_modified:
  - src/components/wizard/StepResults.vue
  - src/components/wizard/WizardStepper.vue
  - src/App.vue
autonomous: false

must_haves:
  truths:
    - "User sees all population frequencies in sortable table"
    - "Results show source attribution (gnomAD/literature/default)"
    - "Founder effect highlighted with row color AND icon"
    - "Global frequency shown as summary card AND first table row"
    - "User can navigate back to any previous step from results"
    - "Complete wizard flow works end-to-end"
  artifacts:
    - path: "src/components/wizard/StepResults.vue"
      provides: "Results display with sortable v-data-table"
      min_lines: 100
    - path: "src/components/wizard/WizardStepper.vue"
      provides: "Main wizard container with v-stepper"
      min_lines: 80
    - path: "src/App.vue"
      provides: "Application root using WizardStepper"
      contains: "WizardStepper"
  key_links:
    - from: "src/components/wizard/WizardStepper.vue"
      to: "src/composables/useWizard.ts"
      via: "imports and uses useWizard composable"
      pattern: "import.*useWizard"
    - from: "src/components/wizard/WizardStepper.vue"
      to: "src/composables/useCarrierFrequency.ts"
      via: "imports and uses useCarrierFrequency"
      pattern: "import.*useCarrierFrequency"
    - from: "src/components/wizard/StepResults.vue"
      to: "v-data-table"
      via: "uses Vuetify sortable data table"
      pattern: "v-data-table"
---

<objective>
Create results step, wizard stepper container, and integrate into App.vue.

Purpose: Complete the wizard UI by building the results display with sortable population table, wrapping all steps in a v-stepper container, and replacing the test UI in App.vue.

Output: StepResults.vue, WizardStepper.vue, updated App.vue - fully functional wizard flow
</objective>

<execution_context>
@~/.claude/get-shit-done/workflows/execute-plan.md
@~/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/02-wizard-ui/02-CONTEXT.md
@.planning/phases/02-wizard-ui/02-RESEARCH.md
@.planning/phases/02-wizard-ui/02-01-SUMMARY.md
@.planning/phases/02-wizard-ui/02-02-SUMMARY.md
@src/components/FrequencyResults.vue
@src/composables/useWizard.ts
@src/composables/useCarrierFrequency.ts
</context>

<tasks>

<task type="auto">
  <name>Task 1: Create StepResults component</name>
  <files>src/components/wizard/StepResults.vue</files>
  <action>
Create `src/components/wizard/StepResults.vue`:

1. Props:
   - result: CarrierFrequencyResult | null
   - globalFrequency: { percent: string; ratio: string } | null
   - indexStatus: IndexPatientStatus
   - frequencySource: FrequencySource
   - literatureFrequency: number | null
   - literaturePmid: string | null
   - usingDefault: boolean

2. Emits:
   - back: ()
   - restart: ()

3. Computed values:
   - recurrenceRisk: Calculate using indexStatus (carrier = /4, affected = /2)
   - effectiveFrequency: Based on frequencySource (gnomad, literature value, or default from config)
   - sourceAttribution: String describing the source (e.g., "gnomAD v4", "Literature (PMID: 12345)", "Default assumption")

4. Template with v-data-table (from RESEARCH.md):

**Summary card (above table):**
```vue
<v-card class="mb-4">
  <v-card-title>
    {{ result.gene }} - Carrier Frequency Results
    <v-chip :color="sourceChipColor" size="small" class="ml-2">
      {{ sourceAttribution }}
    </v-chip>
  </v-card-title>
  <v-card-text>
    <div class="text-h5">
      Global: {{ globalFrequency?.ratio }}
      <span class="text-body-2 text-medium-emphasis">({{ globalFrequency?.percent }})</span>
    </div>
    <div class="text-body-1 mt-2">
      Recurrence Risk ({{ indexStatus === 'heterozygous' ? 'carrier' : 'affected' }}):
      <strong>{{ recurrenceRisk.ratio }}</strong>
      <span class="text-medium-emphasis">({{ recurrenceRisk.percent }})</span>
    </div>
  </v-card-text>
</v-card>
```

**v-data-table (sortable, from CONTEXT.md):**
```vue
<v-data-table
  :items="tableItems"
  :headers="headers"
  :sort-by="[{ key: 'carrierFrequency', order: 'desc' }]"
  density="compact"
  items-per-page="-1"
  class="elevation-1"
>
  <template #item="{ item }">
    <tr :class="getRowClass(item)">
      <td>{{ item.label }}</td>
      <td class="text-right">{{ formatPercent(item.carrierFrequency) }}</td>
      <td class="text-right">{{ formatRatio(item.carrierFrequency) }}</td>
      <td class="text-right">{{ item.recurrenceRisk }}</td>
      <td class="text-right">{{ item.variantCount }}</td>
      <td class="text-right">{{ item.alleleCount }}</td>
      <td class="text-right">{{ item.alleleNumber?.toLocaleString() ?? '-' }}</td>
      <td>
        <v-chip v-if="item.isFounderEffect" color="info" size="x-small">
          <v-icon start size="x-small">mdi-star</v-icon>
          Founder
        </v-chip>
      </td>
    </tr>
  </template>

  <template #bottom></template> <!-- Hide pagination -->
</v-data-table>
```

5. Headers array (from CONTEXT.md user decision):
```typescript
const headers = [
  { title: 'Population', key: 'label', sortable: true },
  { title: 'Carrier Freq (%)', key: 'carrierFrequency', sortable: true, align: 'end' },
  { title: 'Ratio', key: 'ratio', sortable: false, align: 'end' },
  { title: 'Recurrence Risk', key: 'recurrenceRisk', sortable: true, align: 'end' },
  { title: 'Variants', key: 'variantCount', sortable: true, align: 'end' },
  { title: 'AC', key: 'alleleCount', sortable: true, align: 'end' },
  { title: 'AN', key: 'alleleNumber', sortable: true, align: 'end' },
  { title: 'Notes', key: 'notes', sortable: false },
];
```

6. Table items: Map populations to include:
   - Global row first (with isGlobal: true for styling)
   - All population rows
   - Per-population recurrence risk calculation

7. Row styling (from CONTEXT.md):
   - Global row: 'bg-grey-lighten-4 font-weight-bold'
   - Founder effect: 'bg-blue-lighten-5'

8. Back button to return to previous step, "Start Over" button to restart wizard
  </action>
  <verify>Component renders with v-data-table. Sorting works on columns. Run `npm run typecheck`.</verify>
  <done>StepResults.vue shows sortable table with source attribution and recurrence risk</done>
</task>

<task type="auto">
  <name>Task 2: Create WizardStepper container</name>
  <files>src/components/wizard/WizardStepper.vue</files>
  <action>
Create `src/components/wizard/WizardStepper.vue`:

1. Use useWizard() for state management
2. Use useCarrierFrequency() for calculations

3. Template with v-stepper (from RESEARCH.md):
```vue
<template>
  <v-stepper v-model="state.currentStep" flat>
    <v-stepper-header>
      <v-stepper-item
        :complete="state.currentStep > 1"
        :value="1"
        title="Gene"
        subtitle="Search and select"
      />
      <v-divider />
      <v-stepper-item
        :complete="state.currentStep > 2"
        :value="2"
        title="Status"
        subtitle="Carrier or affected"
      />
      <v-divider />
      <v-stepper-item
        :complete="state.currentStep > 3"
        :value="3"
        title="Frequency"
        subtitle="Select source"
      />
      <v-divider />
      <v-stepper-item
        :value="4"
        title="Results"
        subtitle="View calculations"
      />
    </v-stepper-header>

    <v-stepper-window>
      <v-stepper-window-item :value="1">
        <StepGene
          v-model="state.gene"
          @complete="onGeneComplete"
        />
      </v-stepper-window-item>

      <v-stepper-window-item :value="2">
        <StepStatus
          v-model="state.indexStatus"
          @complete="nextStep"
          @back="prevStep"
        />
      </v-stepper-window-item>

      <v-stepper-window-item :value="3">
        <StepFrequency
          v-model:source="state.frequencySource"
          v-model:literature-frequency="state.literatureFrequency"
          v-model:literature-pmid="state.literaturePmid"
          :gnomad-frequency="globalFrequency"
          :gnomad-loading="isLoading"
          :using-default="usingDefault"
          @complete="nextStep"
          @back="prevStep"
        />
      </v-stepper-window-item>

      <v-stepper-window-item :value="4">
        <StepResults
          :result="result"
          :global-frequency="globalFrequency"
          :index-status="state.indexStatus"
          :frequency-source="state.frequencySource"
          :literature-frequency="state.literatureFrequency"
          :literature-pmid="state.literaturePmid"
          :using-default="usingDefault"
          @back="prevStep"
          @restart="resetWizard"
        />
      </v-stepper-window-item>
    </v-stepper-window>
  </v-stepper>
</template>
```

4. Script:
   - Import and use both composables
   - Wire gene selection to setGeneSymbol in useCarrierFrequency
   - onGeneComplete: Set gene symbol AND call nextStep
   - Watch state.gene to sync with useCarrierFrequency.setGeneSymbol

5. Handle error state:
   - If hasError, show v-alert with retry option
   - Loading state handled by StepFrequency showing gnomadLoading

6. Linear navigation enforced:
   - Clicking stepper headers does nothing (no @click handlers)
   - Navigation only via Back/Continue buttons
  </action>
  <verify>Wizard displays all 4 steps. Navigation works via buttons. Run `npm run typecheck`.</verify>
  <done>WizardStepper.vue wraps all steps with v-stepper and coordinates state</done>
</task>

<task type="auto">
  <name>Task 3: Integrate wizard into App.vue</name>
  <files>src/App.vue</files>
  <action>
Update `src/App.vue`:

1. Remove existing test UI (GeneSearch, FrequencyResults, expansion panel)
2. Import WizardStepper from '@/components/wizard/WizardStepper.vue'
3. Replace with:

```vue
<template>
  <v-app>
    <v-main>
      <v-container max-width="900">
        <h1 class="text-h4 mb-2">gnomAD Carrier Frequency Calculator</h1>
        <p class="text-body-2 text-medium-emphasis mb-6">
          Calculate carrier frequency and recurrence risk from gnomAD population data.
        </p>

        <WizardStepper />
      </v-container>
    </v-main>
  </v-app>
</template>

<script setup lang="ts">
import WizardStepper from '@/components/wizard/WizardStepper.vue';
</script>
```

4. Remove unused imports (useCarrierFrequency, GeneSearch, FrequencyResults, VersionSelector, ref)
  </action>
  <verify>Run `npm run dev`. App displays wizard. Navigate through all 4 steps with CFTR gene.</verify>
  <done>App.vue uses WizardStepper as main content</done>
</task>

<task type="checkpoint:human-verify" gate="blocking">
  <what-built>Complete 4-step wizard flow with gene selection, status toggle, frequency source tabs, and sortable results table</what-built>
  <how-to-verify>
1. Run `npm run dev` and open http://localhost:5173
2. **Step 1 (Gene):**
   - Search for "CFTR"
   - Select from autocomplete
   - Verify Continue button becomes enabled
   - Click Continue

3. **Step 2 (Status):**
   - Verify toggle defaults to "Carrier (heterozygous)"
   - Toggle to "Affected" and back
   - Click Back - verify returns to Step 1 with gene preserved
   - Click Continue

4. **Step 3 (Frequency):**
   - Verify gnomAD tab shows calculated frequency
   - Switch to Literature tab - enter frequency "0.04" and PMID "12345"
   - Switch to Default tab - verify shows 1:100
   - Return to gnomAD tab
   - Click Continue

5. **Step 4 (Results):**
   - Verify source attribution chip shows "gnomAD v4"
   - Verify global frequency matches expected (~1:25 for CFTR NFE)
   - Verify recurrence risk calculation shown
   - **Click column headers** - verify sorting works
   - Check founder effect rows have blue background
   - Click Back - verify returns to Step 3
   - Click "Start Over" - verify returns to Step 1 with cleared state

6. **Edge cases:**
   - Return to Step 1, change gene to "HEXA" - verify downstream steps reset
   - Complete flow with literature source - verify results show "Literature (PMID: ...)"
  </how-to-verify>
  <resume-signal>Type "approved" or describe any issues</resume-signal>
</task>

</tasks>

<verification>
- [ ] `npm run typecheck` passes
- [ ] `npm run dev` starts without errors
- [ ] 4-step wizard navigation works (Continue/Back buttons)
- [ ] Gene search works in Step 1
- [ ] Status toggle works in Step 2 (default: carrier)
- [ ] Frequency source tabs work in Step 3
- [ ] Literature validation requires both frequency and PMID
- [ ] Results table is sortable by clicking headers
- [ ] Founder effect rows highlighted (background + chip)
- [ ] Source attribution shown in results
- [ ] Changing gene resets downstream steps
- [ ] "Start Over" resets entire wizard
</verification>

<success_criteria>
- Complete wizard flow works end-to-end
- All 10 Phase 2 requirements covered:
  - UI-01: 4-step wizard flow (Gene -> Status -> Frequency -> Results)
  - UI-02: Vuetify stepper component
  - UI-03: User can navigate back to previous steps
  - UI-04: Results step shows all population frequencies in table format (sortable)
  - IDX-01: User selects index patient status (carrier OR affected)
  - IDX-02: Status selection captured (affects text in Phase 3)
  - SRC-01: User can use gnomAD-calculated carrier frequency
  - SRC-02: User can enter literature-based frequency with PMID citation
  - SRC-03: User can select default assumption (from config)
  - SRC-04: Source attribution shown in results
</success_criteria>

<output>
After completion, create `.planning/phases/02-wizard-ui/02-03-SUMMARY.md`
</output>
