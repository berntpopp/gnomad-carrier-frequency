---
phase: 15-search-history
plan: 02
type: execute
wave: 2
depends_on: ["15-01"]
files_modified:
  - src/components/HistoryPanel.vue
  - src/components/HistoryDrawer.vue
  - src/components/AppBar.vue
  - src/App.vue
autonomous: true

must_haves:
  truths:
    - "User can access history from app bar icon"
    - "History drawer shows list of previous calculations"
    - "User can delete individual history entries"
    - "History is grouped by date for visual scanning"
  artifacts:
    - path: "src/components/HistoryPanel.vue"
      provides: "History list content with date grouping and entry cards"
      min_lines: 80
    - path: "src/components/HistoryDrawer.vue"
      provides: "Right-side drawer wrapper (matches LogViewerPanel pattern)"
      min_lines: 20
    - path: "src/components/AppBar.vue"
      provides: "History icon button in app bar"
      contains: "mdi-history"
  key_links:
    - from: "src/components/HistoryPanel.vue"
      to: "src/stores/useHistoryStore.ts"
      via: "store.groupedByDate getter"
      pattern: "historyStore\\.groupedByDate"
    - from: "src/components/AppBar.vue"
      to: "src/App.vue"
      via: "emit openHistory event"
      pattern: "emit.*openHistory"
    - from: "src/App.vue"
      to: "src/components/HistoryDrawer.vue"
      via: "v-model binding"
      pattern: "HistoryDrawer.*v-model"
---

<objective>
Create history UI components: drawer panel, list display with date grouping, and app bar integration.

Purpose: Provide users with a visual interface to browse previous calculations, see key information at a glance (gene, date, frequency), and delete unwanted entries.
Output: HistoryPanel.vue, HistoryDrawer.vue, updated AppBar.vue with history icon, updated App.vue with drawer integration
</objective>

<execution_context>
@~/.claude/get-shit-done/workflows/execute-plan.md
@~/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/15-search-history/15-RESEARCH.md
@.planning/phases/15-search-history/15-CONTEXT.md
@.planning/phases/15-search-history/15-01-SUMMARY.md
@src/components/LogViewerPanel.vue
@src/components/LogViewer.vue
@src/components/AppBar.vue
@src/App.vue
</context>

<tasks>

<task type="auto">
  <name>Task 1: Create HistoryPanel component</name>
  <files>src/components/HistoryPanel.vue</files>
  <action>
Create `src/components/HistoryPanel.vue` following LogViewer.vue patterns:

```vue
<template>
  <div class="history-panel">
    <div class="d-flex align-center mb-4">
      <h2 class="text-h6">
        Search History
      </h2>
      <v-spacer />
      <v-btn
        icon
        variant="text"
        size="small"
        aria-label="Close history panel"
        @click="emit('close')"
      >
        <v-icon>mdi-close</v-icon>
      </v-btn>
    </div>

    <!-- Empty state -->
    <div
      v-if="historyStore.isEmpty"
      class="text-center py-8 text-medium-emphasis"
    >
      <v-icon
        size="48"
        class="mb-2"
      >
        mdi-history
      </v-icon>
      <p class="text-body-2">
        No search history yet
      </p>
      <p class="text-caption">
        Completed calculations will appear here
      </p>
    </div>

    <!-- History list grouped by date -->
    <template v-else>
      <div class="text-body-2 text-medium-emphasis mb-2">
        {{ historyStore.entryCount }} {{ historyStore.entryCount === 1 ? 'entry' : 'entries' }}
      </div>

      <div
        v-for="group in historyStore.groupedByDate"
        :key="group.date"
        class="mb-4"
      >
        <!-- Date header -->
        <div class="text-caption text-medium-emphasis mb-2 font-weight-medium">
          {{ group.date }}
        </div>

        <!-- Entries for this date -->
        <v-list
          density="compact"
          class="history-list"
        >
          <v-list-item
            v-for="entry in group.entries"
            :key="entry.id"
            class="history-entry rounded mb-1"
            @click="emit('restore', entry.id)"
          >
            <template #prepend>
              <v-icon
                color="primary"
                size="small"
              >
                mdi-dna
              </v-icon>
            </template>

            <v-list-item-title class="font-weight-medium">
              {{ entry.gene.symbol }}
            </v-list-item-title>

            <v-list-item-subtitle class="text-caption">
              {{ formatTime(entry.timestamp) }}
            </v-list-item-subtitle>

            <template #append>
              <v-chip
                size="x-small"
                color="success"
                variant="tonal"
                class="mr-2"
              >
                {{ formatFrequency(entry.results.globalCarrierFrequency) }}
              </v-chip>
              <v-btn
                icon
                variant="text"
                size="x-small"
                aria-label="Delete history entry"
                @click.stop="handleDelete(entry.id)"
              >
                <v-icon size="small">
                  mdi-delete-outline
                </v-icon>
              </v-btn>
            </template>
          </v-list-item>
        </v-list>
      </div>
    </template>
  </div>
</template>

<script setup lang="ts">
import { useHistoryStore } from '@/stores/useHistoryStore';

const historyStore = useHistoryStore();

const emit = defineEmits<{
  close: [];
  restore: [id: string];
}>();

/**
 * Format timestamp to time string (e.g., "2:30 PM")
 */
function formatTime(timestamp: number): string {
  return new Date(timestamp).toLocaleTimeString('en-US', {
    hour: 'numeric',
    minute: '2-digit',
  });
}

/**
 * Format carrier frequency as ratio (e.g., "1:25")
 */
function formatFrequency(freq: number): string {
  if (freq <= 0) return 'N/A';
  return `1:${Math.round(1 / freq)}`;
}

/**
 * Handle delete with instant removal (no confirmation per CONTEXT.md)
 */
function handleDelete(id: string) {
  historyStore.deleteEntry(id);
}
</script>

<style scoped>
.history-panel {
  min-height: 200px;
}

.history-list {
  background: transparent;
}

.history-entry {
  cursor: pointer;
  transition: background-color 0.2s ease;
}

.history-entry:hover {
  background-color: rgba(var(--v-theme-primary), 0.08);
}
</style>
```

Key patterns:
- Follow LogViewer.vue structure for consistency
- Group entries by date using groupedByDate getter
- Show gene symbol, time, carrier frequency ratio
- Instant delete (no confirmation per CONTEXT.md)
- Emit 'restore' event with entry ID for parent handling
  </action>
  <verify>Run `bun run typecheck` and `bun run lint` - no errors</verify>
  <done>HistoryPanel.vue displays grouped history with gene, time, frequency, delete button</done>
</task>

<task type="auto">
  <name>Task 2: Create HistoryDrawer wrapper component</name>
  <files>src/components/HistoryDrawer.vue</files>
  <action>
Create `src/components/HistoryDrawer.vue` following LogViewerPanel.vue pattern exactly:

```vue
<template>
  <v-navigation-drawer
    v-model="modelValue"
    location="right"
    temporary
    :width="drawerWidth"
    class="history-drawer"
  >
    <div class="pa-4">
      <HistoryPanel
        @close="modelValue = false"
        @restore="handleRestore"
      />
    </div>
  </v-navigation-drawer>
</template>

<script setup lang="ts">
import { computed } from 'vue';
import { useDisplay } from 'vuetify';
import HistoryPanel from '@/components/HistoryPanel.vue';

// Responsive breakpoint detection
const { smAndDown, width: viewportWidth } = useDisplay();

// Full-width on mobile, fixed width on desktop (per CONTEXT.md)
const drawerWidth = computed(() => smAndDown.value ? viewportWidth.value : 450);

const modelValue = defineModel<boolean>();

const emit = defineEmits<{
  restore: [id: string];
}>();

function handleRestore(id: string) {
  // Close drawer before emitting restore
  modelValue.value = false;
  emit('restore', id);
}
</script>

<style scoped>
/* Ensure drawer doesn't cause layout issues on mobile */
.history-drawer {
  max-width: 100vw;
}
</style>
```

Key patterns:
- Identical structure to LogViewerPanel.vue
- Responsive width: full viewport on mobile, 450px on desktop
- Close drawer before emitting restore event
  </action>
  <verify>Run `bun run typecheck` - component compiles without errors</verify>
  <done>HistoryDrawer.vue wraps HistoryPanel in responsive navigation drawer</done>
</task>

<task type="auto">
  <name>Task 3: Add history icon to AppBar and integrate in App.vue</name>
  <files>src/components/AppBar.vue, src/App.vue</files>
  <action>
Update `src/components/AppBar.vue` to add history icon button:

1. Add 'openHistory' to emit definition:
```typescript
const emit = defineEmits<{
  openSettings: [];
  openHistory: [];
  reset: [];
}>();
```

2. Add history button BEFORE the theme toggle (between OfflineIndicator and theme button):
```vue
<v-tooltip
  text="Search history"
  location="bottom"
  aria-label="Search history"
>
  <template #activator="{ props }">
    <v-btn
      v-bind="props"
      icon
      variant="text"
      title="Search history"
      aria-label="Search history"
      @click="emit('openHistory')"
    >
      <v-icon>mdi-history</v-icon>
    </v-btn>
  </template>
</v-tooltip>
```

Update `src/App.vue`:

1. Add import for HistoryDrawer:
```typescript
import HistoryDrawer from '@/components/HistoryDrawer.vue';
```

2. Add showHistory ref:
```typescript
const showHistory = ref(false);
```

3. Add @open-history handler to AppBar:
```vue
<AppBar
  @open-settings="showSettings = true"
  @open-history="showHistory = true"
  @reset="handleReset"
/>
```

4. Add HistoryDrawer component after LogViewerPanel:
```vue
<HistoryDrawer
  v-model="showHistory"
  @restore="handleHistoryRestore"
/>
```

5. Add handleHistoryRestore function (placeholder for Plan 03):
```typescript
function handleHistoryRestore(id: string) {
  // Restoration logic implemented in Plan 03
  console.log('Restore history entry:', id);
}
```

6. Initialize auto-save in App.vue setup:
```typescript
import { useHistoryAutoSave } from '@/composables';

// Initialize history auto-save
const { initialize: initHistoryAutoSave } = useHistoryAutoSave();
initHistoryAutoSave();
```
  </action>
  <verify>
1. `bun run typecheck` passes
2. `bun run lint` passes
3. `bun run dev` - click history icon, drawer opens
4. Make a calculation, reach results - entry appears in history
5. Click delete - entry removed instantly
  </verify>
  <done>History icon in AppBar, HistoryDrawer integrated in App.vue, auto-save initialized</done>
</task>

</tasks>

<verification>
1. `bun run typecheck` passes
2. `bun run lint` passes
3. `bun run build` succeeds
4. History icon visible in app bar between offline indicator and theme toggle
5. Clicking history icon opens right-side drawer
6. Completing a calculation auto-saves to history
7. History shows gene name, time, carrier frequency ratio
8. Entries grouped by date with date headers
9. Delete button removes entry instantly
10. Drawer is full-width on mobile, 450px on desktop
</verification>

<success_criteria>
- HistoryPanel displays entries grouped by date (HIST-03, HIST-05)
- Each entry shows gene symbol, time, carrier frequency (HIST-05)
- Delete button removes entry instantly without confirmation (HIST-06)
- History icon in app bar opens drawer (HIST-03)
- Drawer is responsive - full width on mobile (mobile optimization)
- Auto-save triggers when reaching results step (HIST-01)
- Empty state shown when no history
</success_criteria>

<output>
After completion, create `.planning/phases/15-search-history/15-02-SUMMARY.md`
</output>
