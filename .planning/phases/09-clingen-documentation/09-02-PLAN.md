---
phase: 09-clingen-documentation
plan: 02
type: execute
wave: 1
depends_on: []
files_modified:
  - src/types/constraint.ts
  - src/types/index.ts
  - src/api/queries/gene-search.ts
  - src/api/queries/types.ts
  - src/components/GeneConstraintCard.vue
  - src/components/wizard/StepGene.vue
autonomous: true

must_haves:
  truths:
    - "Gene constraint data (pLI, LOEUF) is fetched from gnomAD"
    - "Constraint scores display with color-coded interpretation"
    - "User sees constraint info during gene selection"
    - "Missing constraint data shows N/A gracefully"
  artifacts:
    - path: "src/types/constraint.ts"
      provides: "Gene constraint type definitions"
      exports: ["GeneConstraint", "ConstraintInterpretation"]
    - path: "src/api/queries/gene-search.ts"
      provides: "Extended gene query with constraint fields"
      contains: "gnomad_constraint"
    - path: "src/components/GeneConstraintCard.vue"
      provides: "Constraint score display component"
      min_lines: 60
  key_links:
    - from: "src/components/GeneConstraintCard.vue"
      to: "src/types/constraint.ts"
      via: "type imports"
      pattern: "GeneConstraint"
    - from: "src/components/wizard/StepGene.vue"
      to: "src/components/GeneConstraintCard.vue"
      via: "component usage"
      pattern: "GeneConstraintCard"
---

<objective>
Extend gnomAD gene query to fetch constraint data (pLI, LOEUF) and create a card component to display gene constraint scores with color-coded interpretation during gene selection.

Purpose: CLIN-05 requires displaying gene constraint scores. Users need this clinical context when evaluating carrier frequency results for a gene.

Output: Extended GraphQL query with constraint fields, constraint types, and a GeneConstraintCard component integrated into StepGene.vue.
</objective>

<execution_context>
@~/.claude/get-shit-done/workflows/execute-plan.md
@~/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/09-clingen-documentation/09-RESEARCH.md

# Existing files to extend
@src/api/queries/gene-search.ts
@src/api/queries/types.ts
@src/components/wizard/StepGene.vue
@src/composables/useGeneSearch.ts
</context>

<tasks>

<task type="auto">
  <name>Task 1: Create constraint types and extend query</name>
  <files>src/types/constraint.ts, src/types/index.ts, src/api/queries/gene-search.ts, src/api/queries/types.ts</files>
  <action>
Create `src/types/constraint.ts`:

```typescript
/**
 * Gene constraint data from gnomAD gnomad_constraint object
 */
export interface GeneConstraint {
  pLI: number | null;           // Probability of LoF intolerance
  loeuf: number | null;         // oe_lof_upper - LOEUF metric
  oeLof: number | null;         // oe_lof - observed/expected ratio
  oeLofLower: number | null;    // Lower confidence bound
  expLof: number | null;        // Expected LoF variants
  obsLof: number | null;        // Observed LoF variants
  lofZ: number | null;          // Z-score for LoF
  flags: string[] | null;       // Quality flags
}

/**
 * Interpretation of constraint score
 */
export type ConstraintInterpretation = 'constrained' | 'intermediate' | 'tolerant' | 'unknown';

/**
 * pLI interpretation result
 */
export interface PliInterpretation {
  label: string;
  color: string;
}

/**
 * LOEUF interpretation result
 */
export interface LoeufInterpretation {
  level: ConstraintInterpretation;
  label: string;
  color: string;
}

/**
 * Get LOEUF interpretation based on gnomAD version
 * v4 uses different thresholds than v2/v3
 */
export function getLoeufInterpretation(
  loeuf: number | null,
  gnomadVersion: string
): LoeufInterpretation {
  if (loeuf === null) {
    return { level: 'unknown', label: 'N/A', color: 'grey' };
  }

  // v4 has higher thresholds due to larger sample size
  const isV4 = gnomadVersion.startsWith('4');
  const constrainedThreshold = isV4 ? 0.6 : 0.35;
  const tolerantThreshold = isV4 ? 1.5 : 1.0;

  if (loeuf < constrainedThreshold) {
    return { level: 'constrained', label: 'LoF intolerant', color: 'error' };
  }
  if (loeuf > tolerantThreshold) {
    return { level: 'tolerant', label: 'LoF tolerant', color: 'success' };
  }
  return { level: 'intermediate', label: 'Intermediate', color: 'warning' };
}

/**
 * Get pLI interpretation
 */
export function getPliInterpretation(pLI: number | null): PliInterpretation {
  if (pLI === null) {
    return { label: 'N/A', color: 'grey' };
  }
  if (pLI >= 0.9) {
    return { label: 'LoF intolerant (>=0.9)', color: 'error' };
  }
  if (pLI <= 0.1) {
    return { label: 'LoF tolerant (<=0.1)', color: 'success' };
  }
  return { label: 'Intermediate', color: 'warning' };
}
```

Export from `src/types/index.ts`:
- Add exports for GeneConstraint, ConstraintInterpretation, getLoeufInterpretation, getPliInterpretation

Update `src/api/queries/gene-search.ts` to include constraint fields:

```typescript
// Gene search query with constraint data
export const GENE_SEARCH_QUERY = `
  query GeneSearch($query: String!, $referenceGenome: ReferenceGenomeId!) {
    gene_search(query: $query, reference_genome: $referenceGenome) {
      ensembl_id
      symbol
    }
  }
`;

// Separate query for gene details including constraint (used after selection)
export const GENE_DETAILS_QUERY = `
  query GeneDetails($geneSymbol: String!, $referenceGenome: ReferenceGenomeId!) {
    gene(gene_symbol: $geneSymbol, reference_genome: $referenceGenome) {
      gene_id
      symbol
      gnomad_constraint {
        exp_lof
        obs_lof
        oe_lof
        oe_lof_lower
        oe_lof_upper
        pLI
        lof_z
        flags
      }
    }
  }
`;

export interface GeneSearchVariables {
  query: string;
  referenceGenome: 'GRCh37' | 'GRCh38';
}

export interface GeneDetailsVariables {
  geneSymbol: string;
  referenceGenome: 'GRCh37' | 'GRCh38';
}
```

Update `src/api/queries/types.ts` to add constraint response types:

```typescript
// Add to existing types:

export interface GnomadConstraint {
  exp_lof: number | null;
  obs_lof: number | null;
  oe_lof: number | null;
  oe_lof_lower: number | null;
  oe_lof_upper: number | null;  // This is LOEUF
  pLI: number | null;
  lof_z: number | null;
  flags: string[] | null;
}

export interface GeneDetailsResult {
  gene_id: string;
  symbol: string;
  gnomad_constraint: GnomadConstraint | null;
}

export interface GeneDetailsResponse {
  gene: GeneDetailsResult | null;
}
```
  </action>
  <verify>Run `bun run typecheck` - all types compile correctly</verify>
  <done>Constraint types created, gene details query added with constraint fields</done>
</task>

<task type="auto">
  <name>Task 2: Create GeneConstraintCard component</name>
  <files>src/components/GeneConstraintCard.vue</files>
  <action>
Create `src/components/GeneConstraintCard.vue`:

```vue
<template>
  <v-card
    v-if="constraint || loading"
    variant="outlined"
    class="mt-4"
  >
    <v-card-title class="text-subtitle-1 d-flex align-center">
      <v-icon start size="small">mdi-dna</v-icon>
      Gene Constraint
      <v-tooltip location="top">
        <template #activator="{ props }">
          <v-icon
            v-bind="props"
            size="x-small"
            class="ml-1"
          >
            mdi-information-outline
          </v-icon>
        </template>
        <span>
          Constraint metrics indicate how tolerant a gene is to loss-of-function variants.
          Lower LOEUF values suggest the gene is more constrained (intolerant to LoF).
        </span>
      </v-tooltip>
    </v-card-title>

    <v-card-text>
      <v-skeleton-loader
        v-if="loading"
        type="text, text"
      />

      <template v-else-if="constraint">
        <div class="d-flex flex-wrap ga-4">
          <!-- LOEUF (primary metric) -->
          <div class="constraint-metric">
            <div class="text-caption text-medium-emphasis">LOEUF</div>
            <div class="d-flex align-center">
              <v-chip
                :color="loeufInterpretation.color"
                size="small"
                variant="tonal"
              >
                {{ constraint.loeuf !== null ? constraint.loeuf.toFixed(2) : 'N/A' }}
              </v-chip>
              <span class="text-caption ml-2">{{ loeufInterpretation.label }}</span>
            </div>
          </div>

          <!-- pLI (secondary metric) -->
          <div class="constraint-metric">
            <div class="text-caption text-medium-emphasis">pLI</div>
            <div class="d-flex align-center">
              <v-chip
                :color="pliInterpretation.color"
                size="small"
                variant="tonal"
              >
                {{ constraint.pLI !== null ? constraint.pLI.toFixed(2) : 'N/A' }}
              </v-chip>
              <span class="text-caption ml-2">{{ pliInterpretation.label }}</span>
            </div>
          </div>

          <!-- O/E Ratio -->
          <div
            v-if="constraint.oeLof !== null"
            class="constraint-metric"
          >
            <div class="text-caption text-medium-emphasis">O/E LoF</div>
            <div class="text-body-2">
              {{ constraint.oeLof.toFixed(2) }}
              <span
                v-if="constraint.oeLofLower !== null"
                class="text-medium-emphasis"
              >
                ({{ constraint.oeLofLower.toFixed(2) }} - {{ constraint.loeuf?.toFixed(2) }})
              </span>
            </div>
          </div>

          <!-- Observed/Expected counts -->
          <div
            v-if="constraint.obsLof !== null && constraint.expLof !== null"
            class="constraint-metric"
          >
            <div class="text-caption text-medium-emphasis">LoF Variants</div>
            <div class="text-body-2">
              {{ constraint.obsLof }} observed / {{ constraint.expLof?.toFixed(1) }} expected
            </div>
          </div>
        </div>

        <!-- Quality flags warning -->
        <v-alert
          v-if="constraint.flags && constraint.flags.length > 0"
          type="warning"
          variant="tonal"
          density="compact"
          class="mt-3"
        >
          <div class="text-caption">
            Quality flags: {{ constraint.flags.join(', ') }}
          </div>
        </v-alert>
      </template>

      <div
        v-else
        class="text-medium-emphasis text-body-2"
      >
        No constraint data available for this gene.
      </div>
    </v-card-text>
  </v-card>
</template>

<script setup lang="ts">
import { computed } from 'vue';
import type { GeneConstraint } from '@/types';
import { getLoeufInterpretation, getPliInterpretation } from '@/types';

const props = defineProps<{
  constraint: GeneConstraint | null;
  loading?: boolean;
  gnomadVersion?: string;
}>();

const loeufInterpretation = computed(() =>
  getLoeufInterpretation(props.constraint?.loeuf ?? null, props.gnomadVersion ?? '4.1')
);

const pliInterpretation = computed(() =>
  getPliInterpretation(props.constraint?.pLI ?? null)
);
</script>

<style scoped>
.constraint-metric {
  min-width: 120px;
}
</style>
```
  </action>
  <verify>Run `bun run typecheck` - component compiles without errors</verify>
  <done>GeneConstraintCard displays pLI and LOEUF with color-coded interpretation</done>
</task>

<task type="auto">
  <name>Task 3: Integrate constraint card into StepGene</name>
  <files>src/components/wizard/StepGene.vue, src/composables/useGeneSearch.ts</files>
  <action>
Update `src/composables/useGeneSearch.ts` to fetch constraint data after gene selection:

Add a new function to fetch gene details:

```typescript
// Add to imports
import { GENE_SEARCH_QUERY, GENE_DETAILS_QUERY } from '@/api/queries/gene-search';
import type { GeneSearchResponse, GeneSearchResult, GeneDetailsResponse } from '@/api/queries/types';
import type { GeneConstraint } from '@/types';

// Add to return interface:
export interface UseGeneSearchReturn {
  // ... existing fields ...
  geneConstraint: Ref<GeneConstraint | null>;
  constraintLoading: Ref<boolean>;
}

// Inside useGeneSearch function, add:
const geneConstraint = ref<GeneConstraint | null>(null);
const constraintLoading = ref(false);

// Add function to fetch constraint after selection
const fetchConstraint = async (symbol: string) => {
  constraintLoading.value = true;
  geneConstraint.value = null;

  try {
    const { data, error: queryError } = await useQuery<GeneDetailsResponse>({
      query: GENE_DETAILS_QUERY,
      variables: {
        geneSymbol: symbol,
        referenceGenome: getReferenceGenome(version.value),
      },
    }).then();

    if (data.value?.gene?.gnomad_constraint) {
      const c = data.value.gene.gnomad_constraint;
      geneConstraint.value = {
        pLI: c.pLI,
        loeuf: c.oe_lof_upper,
        oeLof: c.oe_lof,
        oeLofLower: c.oe_lof_lower,
        expLof: c.exp_lof,
        obsLof: c.obs_lof,
        lofZ: c.lof_z,
        flags: c.flags,
      };
    }
  } catch (err) {
    console.error('[GeneSearch] Constraint fetch error:', err);
  } finally {
    constraintLoading.value = false;
  }
};

// Modify selectGene to trigger constraint fetch:
const selectGene = (gene: GeneSearchResult) => {
  selectedGene.value = gene;
  searchTerm.value = gene.symbol;
  debouncedTerm.value = '';
  fetchConstraint(gene.symbol);  // Add this line
};

// Clear constraint on clearSelection:
const clearSelection = () => {
  selectedGene.value = null;
  searchTerm.value = '';
  debouncedTerm.value = '';
  geneConstraint.value = null;  // Add this line
};

// Add to return:
return {
  // ... existing fields ...
  geneConstraint,
  constraintLoading,
};
```

NOTE: The useQuery from villus may need to be called differently for one-off queries. Use `executeQuery` pattern if available, or create a separate query composable. Check villus documentation for the correct pattern. The key is to fetch constraint data only when a gene is selected, not during search.

Update `src/components/wizard/StepGene.vue`:

```vue
<template>
  <div>
    <h2 class="text-h6 mb-4">Select Gene</h2>
    <p class="text-body-2 text-medium-emphasis mb-4">
      Search for a gene symbol to calculate carrier frequency.
    </p>

    <div class="mb-4" style="max-width: 300px">
      <VersionSelector />
    </div>

    <GeneSearch @select="onGeneChange" />

    <!-- Gene Constraint Card - shows after gene selection -->
    <GeneConstraintCard
      v-if="modelValue"
      :constraint="geneConstraint"
      :loading="constraintLoading"
      :gnomad-version="gnomadVersion"
    />

    <div class="d-flex justify-end mt-6">
      <v-btn
        color="primary"
        :disabled="!modelValue"
        @click="$emit('complete')"
      >
        Continue
      </v-btn>
    </div>
  </div>
</template>

<script setup lang="ts">
import { computed } from 'vue';
import GeneSearch from '@/components/GeneSearch.vue';
import VersionSelector from '@/components/VersionSelector.vue';
import GeneConstraintCard from '@/components/GeneConstraintCard.vue';
import type { GeneSearchResult } from '@/api/queries/types';
import { useGeneSearch } from '@/composables';
import { useGnomadVersion } from '@/api';

defineProps<{
  modelValue: GeneSearchResult | null;
}>();

const emit = defineEmits<{
  'update:modelValue': [gene: GeneSearchResult | null];
  complete: [];
}>();

const { geneConstraint, constraintLoading } = useGeneSearch();
const { version } = useGnomadVersion();
const gnomadVersion = computed(() => version.value);

const onGeneChange = (gene: GeneSearchResult | null) => {
  emit('update:modelValue', gene);
};
</script>
```
  </action>
  <verify>Run `bun run dev`, select a gene like CFTR, verify constraint card appears with pLI/LOEUF data</verify>
  <done>Gene constraint card shows during gene selection with color-coded interpretation</done>
</task>

</tasks>

<verification>
1. `bun run typecheck` passes
2. `bun run lint` passes
3. `bun run dev` - select gene, constraint card appears
4. LOEUF shows with red/yellow/green interpretation
5. pLI shows with interpretation
6. Missing constraint shows "N/A" gracefully
</verification>

<success_criteria>
- Gene details query fetches gnomad_constraint object
- GeneConstraintCard displays pLI and LOEUF with color coding
- Constraint card appears in StepGene after gene selection
- Version-specific LOEUF thresholds applied correctly
- Quality flags shown as warning if present
</success_criteria>

<output>
After completion, create `.planning/phases/09-clingen-documentation/09-02-SUMMARY.md`
</output>
