---
phase: 08-filtering-variant-display
plan: 04
type: execute
wave: 3
depends_on: ["08-03"]
files_modified:
  - src/components/VariantModal.vue
  - src/components/VariantTable.vue
  - src/utils/variant-display.ts
  - src/components/FrequencyResults.vue
autonomous: true

must_haves:
  truths:
    - "User can open modal showing contributing variants"
    - "Variant modal displays variant ID, consequence, allele frequency, ClinVar status"
    - "Variant table columns are sortable"
    - "User can click population row to see population-specific variants"
    - "Population drill-down shows variant frequencies for that population"
  artifacts:
    - path: "src/components/VariantModal.vue"
      provides: "Large dialog with variant data table"
      min_lines: 100
    - path: "src/components/VariantTable.vue"
      provides: "Sortable expandable data table for variants"
      min_lines: 80
    - path: "src/utils/variant-display.ts"
      provides: "Transform variants to display format"
      exports: ["toDisplayVariants", "getPopulationVariants"]
  key_links:
    - from: "src/components/VariantModal.vue"
      to: "src/components/VariantTable.vue"
      via: "component composition"
      pattern: "VariantTable"
    - from: "src/components/FrequencyResults.vue"
      to: "src/components/VariantModal.vue"
      via: "population row click"
      pattern: "@click.*openVariantModal"
    - from: "src/utils/variant-display.ts"
      to: "src/types/display.ts"
      via: "DisplayVariant type"
      pattern: "DisplayVariant"
---

<objective>
Create variant modal with sortable table and population drill-down functionality.

Purpose: Users need to inspect which variants contribute to the carrier frequency calculation. The modal displays detailed variant information in a sortable table. Population drill-down allows seeing which variants are present in specific populations and their frequencies.

Output: VariantModal component with sortable VariantTable, integrated into FrequencyResults with population row click and "View all variants" button.
</objective>

<execution_context>
@~/.claude/get-shit-done/workflows/execute-plan.md
@~/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/08-filtering-variant-display/08-CONTEXT.md
@.planning/phases/08-filtering-variant-display/08-RESEARCH.md

@.planning/phases/08-filtering-variant-display/08-01-SUMMARY.md
@.planning/phases/08-filtering-variant-display/08-02-SUMMARY.md
@.planning/phases/08-filtering-variant-display/08-03-SUMMARY.md

@src/components/FrequencyResults.vue (integration target with FilterPanel already added)
@src/types/display.ts (DisplayVariant, PopulationVariantFrequency types)
</context>

<tasks>

<task type="auto">
  <name>Task 1: Create variant display utility functions</name>
  <files>src/utils/variant-display.ts</files>
  <action>
Create `src/utils/variant-display.ts` with functions to transform raw variant data to display format:

1. Import types: GnomadVariant, ClinVarVariant, DisplayVariant, PopulationVariantFrequency from '@/types'

2. `toDisplayVariant(variant: GnomadVariant, clinvarVariants: ClinVarVariant[]): DisplayVariant`:
   - Extract variant_id, pos, ref, alt from variant
   - Get transcript_consequence fields (consequence, hgvsc, hgvsp, transcriptId, lof)
   - Find matching ClinVar variant by variant_id
   - Compute alleleFrequency: (exome.ac + genome.ac) / max(exome.an, genome.an)
   - Set clinvarStatus and goldStars from ClinVar match (null if no match)
   - Set boolean flags: isLoF, isClinvarPathogenic, isMissense
   - Return DisplayVariant object

3. `toDisplayVariants(variants: GnomadVariant[], clinvarVariants: ClinVarVariant[]): DisplayVariant[]`:
   - Map variants through toDisplayVariant

4. `getPopulationVariants(variants: GnomadVariant[], populationCode: string): PopulationVariantFrequency[]`:
   - For each variant, find the population in exome.populations or genome.populations
   - Return array of PopulationVariantFrequency with:
     - populationCode, populationLabel (from config lookup)
     - alleleFrequency computed from that population's ac/an
     - alleleCount, alleleNumber from that population

5. `getConsequenceLabel(consequenceTerms: string[]): string`:
   - Return first consequence term, formatted for display (replace underscores with spaces)
   - Handle null/empty gracefully

6. `getClinvarColor(status: string | null): string`:
   - 'pathogenic' -> 'error'
   - 'likely_pathogenic' -> 'warning'
   - 'uncertain_significance' -> 'grey'
   - null/other -> 'default'

Export all functions.
  </action>
  <verify>
`bun run typecheck` passes. Functions can be imported and called.
  </verify>
  <done>
Utility functions transform raw gnomAD/ClinVar data to display-ready format with computed fields.
  </done>
</task>

<task type="auto">
  <name>Task 2: Create VariantTable component</name>
  <files>src/components/VariantTable.vue</files>
  <action>
Create `src/components/VariantTable.vue` - sortable data table for variants:

1. Props:
   - `variants: DisplayVariant[]` - Variants to display
   - `loading?: boolean` - Loading state
   - `populationCode?: string | null` - If set, shows population-specific view

2. Template:
   - Use v-data-table with following headers (all sortable except expand):
     - Variant ID (key: 'variant_id')
     - Consequence (key: 'consequence')
     - Allele Freq (key: 'alleleFrequency', align: 'end')
     - ClinVar (key: 'clinvarStatus')
     - Stars (key: 'goldStars', align: 'center')
     - HGVS-c (key: 'hgvsc', sortable: false)
     - HGVS-p (key: 'hgvsp', sortable: false)
     - Expand column
   - Use density="compact" for more data visibility
   - Enable show-expand for expandable rows
   - item-value="variant_id" for unique key

3. Custom slots:
   - #item.clinvarStatus: v-chip with color from getClinvarColor
   - #item.goldStars: Star icons (filled + empty to equal 4)
   - #item.alleleFrequency: Format as scientific notation for small values
   - #expanded-row: Show additional details (transcript ID, position, ref/alt, LoF flags)

4. Sorting:
   - Default sort by alleleFrequency descending
   - Use v-data-table's built-in sort-by prop

5. Pagination:
   - items-per-page: 10 (default)
   - Show pagination controls
  </action>
  <verify>
`bun run typecheck` passes. Component renders with sample data.
  </verify>
  <done>
VariantTable displays sortable, expandable variant data with clinical-relevant columns.
  </done>
</task>

<task type="auto">
  <name>Task 3: Create VariantModal and integrate population drill-down</name>
  <files>src/components/VariantModal.vue, src/components/FrequencyResults.vue</files>
  <action>
Create `src/components/VariantModal.vue`:

1. Props:
   - `modelValue: boolean` (v-model for visibility)
   - `variants: DisplayVariant[]` - Variants to show
   - `populationLabel?: string | null` - Population name for title (null = all)
   - `loading?: boolean`

2. Emits: `update:modelValue`

3. Template:
   - v-dialog with responsive width (90% on lg+, fullscreen on sm and down)
   - persistent: false (can close by clicking outside)
   - scrollable: true
   - v-card containing:
     - v-card-title: "Variants for {populationLabel}" or "All Contributing Variants"
     - Close button (v-btn icon with mdi-close)
     - v-card-text: VariantTable component
     - v-card-actions: "Close" button

4. Responsive sizing:
   - Use Vuetify display composable for breakpoint detection
   - Width: '90%' on lgAndUp, '95%' otherwise
   - Max-height: 80vh

Update `src/components/FrequencyResults.vue`:

1. Import VariantModal, toDisplayVariants, getPopulationVariants

2. Add component state:
   - `showVariantModal: ref(false)`
   - `selectedPopulation: ref<string | null>(null)`
   - `modalVariants: computed` - filtered variants for modal

3. Add "View all variants" button below the population table:
   - v-btn variant="text" with mdi-table icon
   - @click sets selectedPopulation to null, showVariantModal to true

4. Make population rows clickable (VAR-04):
   - Add @click handler to each population row
   - On click: set selectedPopulation to pop.code, showVariantModal to true
   - Add cursor: pointer style to rows
   - Add visual indicator (mdi-chevron-right icon in row)

5. Compute modalVariants:
   - If selectedPopulation is null: return all filtered DisplayVariants
   - If selectedPopulation is set: filter to variants present in that population (where population ac > 0)

6. Add VariantModal component:
   - v-model bound to showVariantModal
   - :variants="modalVariants"
   - :population-label="selectedPopulationLabel" (computed from population code)

7. Update population row to show drill-down affordance:
   - Add tooltip: "Click to view variants in this population"
   - Consider hover state styling
  </action>
  <verify>
`bun run dev` - Navigate to results, click "View all variants" button, verify modal opens with sortable table. Click population row, verify modal shows population-specific variants.
  </verify>
  <done>
Variant modal shows contributing variants with sortable table. Population rows are clickable for drill-down to population-specific variants.
  </done>
</task>

</tasks>

<verification>
1. `bun run typecheck` passes
2. `bun run lint` passes
3. "View all variants" button opens modal with all filtered variants
4. Population row click opens modal filtered to that population
5. Modal title changes based on population selection
6. Table columns are sortable (click header to sort)
7. Expanded rows show additional variant details
8. Modal closes on X button, close button, or escape key
</verification>

<success_criteria>
1. VAR-01: User can open modal showing contributing variants (via button or population click)
2. VAR-02: Variant modal displays variant ID, consequence, allele frequency, ClinVar status (all columns present)
3. VAR-03: Variant table columns are sortable (v-data-table sorting works)
4. VAR-04: User can click population row to see population-specific variants
5. VAR-05: Population drill-down shows variant frequencies for that population
</success_criteria>

<output>
After completion, create `.planning/phases/08-filtering-variant-display/08-04-SUMMARY.md`
</output>
