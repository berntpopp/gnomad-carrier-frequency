---
phase: 08-filtering-variant-display
plan: 03
type: execute
wave: 2
depends_on: ["08-01", "08-02"]
files_modified:
  - src/composables/useVariantFilters.ts
  - src/composables/index.ts
  - src/components/FilterPanel.vue
  - src/components/FilterChips.vue
  - src/components/SettingsDialog.vue
  - src/components/FrequencyResults.vue
autonomous: true

must_haves:
  truths:
    - "User can see current filter criteria displayed as chips when panel collapsed"
    - "User can toggle LoF HC, missense, and ClinVar filters via switches"
    - "User can adjust ClinVar star threshold with slider (0-4)"
    - "Filter changes show real-time variant count update"
    - "User can reset filters to saved defaults"
    - "User can configure filter defaults in Settings dialog"
  artifacts:
    - path: "src/composables/useVariantFilters.ts"
      provides: "Reactive filter state and filtered variants computed"
      exports: ["useVariantFilters"]
    - path: "src/components/FilterPanel.vue"
      provides: "Collapsible filter controls with switches and slider"
      min_lines: 80
    - path: "src/components/FilterChips.vue"
      provides: "Chip summary of active filters"
      min_lines: 30
    - path: "src/components/SettingsDialog.vue"
      provides: "Filter defaults configuration in Filters tab"
      contains: "useFilterStore"
  key_links:
    - from: "src/composables/useVariantFilters.ts"
      to: "src/stores/useFilterStore.ts"
      via: "store import for defaults"
      pattern: "useFilterStore"
    - from: "src/composables/useVariantFilters.ts"
      to: "src/utils/variant-filters.ts"
      via: "filterPathogenicVariantsConfigurable"
      pattern: "filterPathogenicVariantsConfigurable"
    - from: "src/components/FilterPanel.vue"
      to: "src/composables/useVariantFilters.ts"
      via: "composable usage"
      pattern: "useVariantFilters"
    - from: "src/components/FrequencyResults.vue"
      to: "src/components/FilterPanel.vue"
      via: "component integration"
      pattern: "FilterPanel"
---

<objective>
Create filter UI components and integrate with carrier frequency calculation.

Purpose: Users need to configure variant filters and see real-time feedback. This plan creates the filter composable (reactive state layer), FilterPanel (expanded controls), FilterChips (collapsed summary), updates SettingsDialog with filter defaults, and integrates into FrequencyResults.

Output: Fully functional filter UI with real-time variant count updates, integrated into the calculation workflow.
</objective>

<execution_context>
@~/.claude/get-shit-done/workflows/execute-plan.md
@~/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/08-filtering-variant-display/08-CONTEXT.md
@.planning/phases/08-filtering-variant-display/08-RESEARCH.md

@.planning/phases/08-filtering-variant-display/08-01-SUMMARY.md (filter store and types)
@.planning/phases/08-filtering-variant-display/08-02-SUMMARY.md (extended query and display types)

@src/components/FrequencyResults.vue (integration target)
@src/components/SettingsDialog.vue (add filter defaults UI)
@src/composables/useCarrierFrequency.ts (pattern for composable)
</context>

<tasks>

<task type="auto">
  <name>Task 1: Create useVariantFilters composable</name>
  <files>src/composables/useVariantFilters.ts, src/composables/index.ts</files>
  <action>
Create `src/composables/useVariantFilters.ts`:

1. Import dependencies:
   - `computed, ref, type Ref` from vue
   - `useFilterStore` from stores
   - `filterPathogenicVariantsConfigurable` from utils/variant-filters
   - `FilterConfig` from types
   - `GnomadVariant, ClinVarVariant` from types

2. Define return interface `UseVariantFiltersReturn`:
   - `filters: Ref<FilterConfig>` - Current filter state (local, not store)
   - `filteredVariants: ComputedRef<GnomadVariant[]>` - Filtered result
   - `filteredCount: ComputedRef<number>` - Count for display
   - `resetFilters: () => void` - Reset to store defaults
   - `saveAsDefaults: () => void` - Save current to store
   - `isModifiedFromDefaults: ComputedRef<boolean>` - True if differs from store

3. Export function `useVariantFilters(variants: Ref<GnomadVariant[]>, clinvarVariants: Ref<ClinVarVariant[]>)`:
   - Get filter store
   - Create local `filters` ref initialized from `store.defaults`
   - Create `filteredVariants` computed using `filterPathogenicVariantsConfigurable`
   - Implement resetFilters: copy store.defaults to local filters
   - Implement saveAsDefaults: call store.setDefaults(filters.value)
   - Implement isModifiedFromDefaults: compare local vs store

Export from `src/composables/index.ts`.
  </action>
  <verify>
`bun run typecheck` passes. Composable can be imported and instantiated.
  </verify>
  <done>
useVariantFilters composable provides reactive filtered variants that update when filter toggles change.
  </done>
</task>

<task type="auto">
  <name>Task 2: Create FilterChips and FilterPanel components</name>
  <files>src/components/FilterChips.vue, src/components/FilterPanel.vue</files>
  <action>
Create `src/components/FilterChips.vue` - collapsed filter summary:

1. Props: `filters: FilterConfig`
2. Template: Display active filters as v-chip elements:
   - "LoF HC" chip if lofHcEnabled (color="primary")
   - "Missense" chip if missenseEnabled (color="secondary")
   - "ClinVar P/LP" chip if clinvarEnabled (color="success")
   - If clinvarEnabled, append star count: "ClinVar >= N stars"
3. Use x-small size chips with appropriate icons (mdi-check)

Create `src/components/FilterPanel.vue` - expanded filter controls:

1. Props:
   - `modelValue: FilterConfig` (v-model)
   - `variantCount: number` (for display)
2. Emits: `update:modelValue`, `reset`
3. Template structure using v-expansion-panels (per CONTEXT.md):
   - Collapsed: Show FilterChips
   - Expanded: Show controls
4. Controls (inside expansion panel text):
   - v-switch for lofHcEnabled (label: "LoF High Confidence")
   - v-switch for missenseEnabled (label: "Include Missense")
   - v-switch for clinvarEnabled (label: "ClinVar P/LP")
   - v-slider for clinvarStarThreshold (disabled if !clinvarEnabled):
     - min: 0, max: 4, step: 1
     - tick-labels: ['0', '1', '2', '3', '4']
     - label: "ClinVar Min Stars"
   - Variant count display: "{{ variantCount }} qualifying variant(s)"
   - v-btn variant="text" for reset (emits 'reset')
5. Use v-model pattern: emit update:modelValue on any control change
  </action>
  <verify>
`bun run typecheck` passes. Components render without errors in browser.
  </verify>
  <done>
FilterPanel shows collapsible filter controls with chips summary when collapsed, real-time feedback.
  </done>
</task>

<task type="auto">
  <name>Task 3: Add filter defaults to SettingsDialog and integrate FilterPanel</name>
  <files>src/components/SettingsDialog.vue, src/components/FrequencyResults.vue</files>
  <action>
Update `src/components/SettingsDialog.vue`:

1. Import useFilterStore
2. In the "filters" tab, replace placeholder with actual controls:
   - v-switch for each filter option (bound to store.defaults.*)
   - v-slider for clinvarStarThreshold
   - v-btn "Reset to Factory Defaults" calling store.resetToFactoryDefaults()
   - Descriptive text explaining these are the default values for new calculations
3. Ensure Save button persists any pending changes (store auto-persists, but ensure reactivity)

Update `src/components/FrequencyResults.vue`:

1. Import FilterPanel, useVariantFilters
2. Accept new props:
   - `variants: GnomadVariant[]` - Raw unfiltered variants
   - `clinvarVariants: ClinVarVariant[]` - ClinVar data
3. Setup useVariantFilters with the variant refs
4. Add FilterPanel above the results table, inside the v-card:
   - Place between card-title and card-text
   - Bind v-model to filters from composable
   - Bind variantCount to filteredCount
   - Handle @reset with resetFilters
5. Update displayed variant count to use filteredCount instead of result.qualifyingVariantCount
6. The result object should use filtered variants (may need to recompute or accept computed result)

Note: The parent component (likely StepFrequency or WizardStepper) will need to pass variants. If necessary, update the data flow so raw variants are available to FrequencyResults.
  </action>
  <verify>
`bun run dev` - Open app, navigate to results, verify FilterPanel appears. Toggle filters, verify count updates.
  </verify>
  <done>
Settings dialog allows configuring filter defaults. FrequencyResults displays FilterPanel with real-time variant count updates.
  </done>
</task>

</tasks>

<verification>
1. `bun run typecheck` passes
2. `bun run lint` passes
3. Settings dialog "Filters" tab shows filter configuration controls
4. FrequencyResults shows collapsible FilterPanel
5. Toggling filters updates variant count in real-time (no page refresh)
6. Reset button restores saved defaults
7. Changes in Settings dialog persist across browser refresh
</verification>

<success_criteria>
1. FILT-01: Current filter criteria displayed as chips when panel collapsed
2. FILT-02: User can toggle LoF HC filter on/off
3. FILT-03: User can toggle missense inclusion on/off
4. FILT-04: User can toggle ClinVar P/LP filter on/off
5. FILT-05: User can adjust ClinVar star threshold (0-4) via slider
6. FILT-06: Filter defaults stored in settings (useFilterStore persists)
7. FILT-07: User can override filter defaults per calculation (local filters ref)
8. FILT-08: User can reset filters to defaults (resetFilters function)
9. FILT-09: Filter changes show real-time variant count feedback (computed filteredCount)
</success_criteria>

<output>
After completion, create `.planning/phases/08-filtering-variant-display/08-03-SUMMARY.md`
</output>
