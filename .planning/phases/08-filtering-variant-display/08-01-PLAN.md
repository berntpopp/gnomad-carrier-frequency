---
phase: 08-filtering-variant-display
plan: 01
type: execute
wave: 1
depends_on: []
files_modified:
  - src/types/filter.ts
  - src/stores/useFilterStore.ts
  - src/utils/variant-filters.ts
  - src/types/index.ts
autonomous: true

must_haves:
  truths:
    - "Filter defaults persist across browser sessions"
    - "Filter logic supports configurable LoF HC, missense, ClinVar toggles"
    - "ClinVar star threshold is configurable 0-4"
  artifacts:
    - path: "src/types/filter.ts"
      provides: "FilterConfig interface with all filter options"
      exports: ["FilterConfig", "FilterDefaults"]
    - path: "src/stores/useFilterStore.ts"
      provides: "Pinia store for persisted filter defaults"
      exports: ["useFilterStore"]
    - path: "src/utils/variant-filters.ts"
      provides: "Configurable variant filtering functions"
      exports: ["filterPathogenicVariantsConfigurable", "shouldIncludeVariantConfigurable"]
  key_links:
    - from: "src/stores/useFilterStore.ts"
      to: "pinia-plugin-persistedstate"
      via: "persist option"
      pattern: "persist.*key.*carrier-freq-filters"
    - from: "src/utils/variant-filters.ts"
      to: "src/types/filter.ts"
      via: "FilterConfig import"
      pattern: "import.*FilterConfig.*from.*filter"
---

<objective>
Create filter infrastructure: type definitions, persistent store, and configurable filtering logic.

Purpose: Establish the data layer for variant filtering. The store holds user's saved defaults, the types define filter configuration, and the extended filter functions accept configurable parameters instead of hardcoded values.

Output: Filter types, persistent store, and configurable filter functions ready for UI integration.
</objective>

<execution_context>
@~/.claude/get-shit-done/workflows/execute-plan.md
@~/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/08-filtering-variant-display/08-CONTEXT.md
@.planning/phases/08-filtering-variant-display/08-RESEARCH.md

@src/stores/useTemplateStore.ts (pattern for Pinia store with persistence)
@src/utils/variant-filters.ts (current filter logic to extend)
@src/types/variant.ts (existing variant types)
</context>

<tasks>

<task type="auto">
  <name>Task 1: Create filter type definitions</name>
  <files>src/types/filter.ts, src/types/index.ts</files>
  <action>
Create `src/types/filter.ts` with:

1. `FilterConfig` interface:
   - `lofHcEnabled: boolean` - Toggle for LoF High Confidence filter
   - `missenseEnabled: boolean` - Toggle for missense variants inclusion
   - `clinvarEnabled: boolean` - Toggle for ClinVar P/LP filter
   - `clinvarStarThreshold: number` - Star threshold 0-4

2. `FilterDefaults` type (alias to FilterConfig for semantic clarity in store context)

3. `FACTORY_FILTER_DEFAULTS` constant with sensible defaults:
   - lofHcEnabled: true
   - missenseEnabled: false
   - clinvarEnabled: true
   - clinvarStarThreshold: 1

Export all from `src/types/index.ts`.
  </action>
  <verify>
`bun run typecheck` passes with new types
  </verify>
  <done>
FilterConfig and FilterDefaults types exported and available for import throughout codebase.
  </done>
</task>

<task type="auto">
  <name>Task 2: Create filter store with persistence</name>
  <files>src/stores/useFilterStore.ts</files>
  <action>
Create `src/stores/useFilterStore.ts` following the pattern in `useTemplateStore.ts`:

1. Define store state with `defaults: FilterDefaults`

2. Define getters:
   - `activeFiltersDescription`: Returns human-readable filter summary (e.g., "LoF HC, ClinVar >= 1 star")

3. Define actions:
   - `setDefaults(newDefaults: Partial<FilterConfig>)`: Merge partial updates
   - `resetToFactoryDefaults()`: Reset to FACTORY_FILTER_DEFAULTS
   - `setLofHcEnabled(enabled: boolean)`
   - `setMissenseEnabled(enabled: boolean)`
   - `setClinvarEnabled(enabled: boolean)`
   - `setClinvarStarThreshold(threshold: number)`: Validate 0-4 range

4. Configure persistence:
   - key: 'carrier-freq-filters'
   - storage: localStorage

Import FACTORY_FILTER_DEFAULTS from types.
  </action>
  <verify>
`bun run typecheck` passes, store can be instantiated in a test or browser console
  </verify>
  <done>
useFilterStore exports correctly, defaults persist to localStorage with key 'carrier-freq-filters'.
  </done>
</task>

<task type="auto">
  <name>Task 3: Extend variant-filters.ts for configurable filtering</name>
  <files>src/utils/variant-filters.ts</files>
  <action>
Extend existing filter functions to accept FilterConfig:

1. Add MISSENSE_CONSEQUENCES constant array:
   - 'missense_variant'
   - 'inframe_insertion'
   - 'inframe_deletion'

2. Create `isPathogenicClinVarWithThreshold(variant: ClinVarVariant, threshold: number): boolean`:
   - Same logic as existing isPathogenicClinVar but uses threshold parameter
   - Returns true if pathogenic/likely_pathogenic (not conflicting) AND gold_stars >= threshold

3. Create `shouldIncludeVariantConfigurable(variant: GnomadVariant, clinvarVariants: ClinVarVariant[], config: FilterConfig): boolean`:
   - Check LoF HC if config.lofHcEnabled
   - Check missense consequences if config.missenseEnabled
   - Check ClinVar P/LP with threshold if config.clinvarEnabled
   - Return true if ANY enabled filter matches

4. Create `filterPathogenicVariantsConfigurable(variants: GnomadVariant[], clinvarVariants: ClinVarVariant[], config: FilterConfig): GnomadVariant[]`:
   - Filter using shouldIncludeVariantConfigurable

5. Keep existing functions (isHighConfidenceLoF, isPathogenicClinVar, shouldIncludeVariant, filterPathogenicVariants) for backwards compatibility - they use default config internally.

Import FilterConfig from types.
  </action>
  <verify>
`bun run typecheck` passes. Existing code using old functions still works (no breaking changes).
  </verify>
  <done>
Configurable filter functions available. Existing hardcoded functions preserved. All exports work correctly.
  </done>
</task>

</tasks>

<verification>
1. `bun run typecheck` passes
2. `bun run lint` passes (or only pre-existing warnings)
3. Types can be imported: `import { FilterConfig, FilterDefaults, FACTORY_FILTER_DEFAULTS } from '@/types'`
4. Store can be used: `const store = useFilterStore(); console.log(store.defaults);`
5. New filter function signature works: `filterPathogenicVariantsConfigurable(variants, clinvar, config)`
</verification>

<success_criteria>
1. FilterConfig type defines all four filter options with correct types
2. useFilterStore persists to localStorage under 'carrier-freq-filters' key
3. Configurable filter functions accept FilterConfig parameter
4. Existing filterPathogenicVariants function still works unchanged (backwards compatible)
5. All TypeScript compilation and linting passes
</success_criteria>

<output>
After completion, create `.planning/phases/08-filtering-variant-display/08-01-SUMMARY.md`
</output>
