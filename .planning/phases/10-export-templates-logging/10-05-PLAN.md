---
phase: 10-export-templates-logging
plan: 05
type: execute
wave: 2
depends_on: ["10-04"]
files_modified:
  - src/components/TemplateEditor.vue
  - src/components/VariablePicker.vue
  - src/components/SettingsDialog.vue
autonomous: true

must_haves:
  truths:
    - "User can edit template sections in Settings > Templates tab"
    - "Variables {{name}} are visually highlighted as colored chips"
    - "User can insert variables via picker panel by clicking"
    - "User can reset templates to defaults per language"
    - "User can export/import templates to/from JSON files"
  artifacts:
    - path: "src/components/TemplateEditor.vue"
      provides: "Section-based editor with variable chip highlighting"
      contains: "parseTemplate"
    - path: "src/components/VariablePicker.vue"
      provides: "Clickable variable list grouped by category"
      contains: "TEMPLATE_VARIABLES"
    - path: "src/components/SettingsDialog.vue"
      provides: "Templates tab with editor, picker, import/export buttons"
      contains: "TemplateEditor"
  key_links:
    - from: "src/components/TemplateEditor.vue"
      to: "src/utils/template-parser.ts"
      via: "parseTemplate import"
      pattern: "parseTemplate"
    - from: "src/components/VariablePicker.vue"
      to: "src/config/template-variables.ts"
      via: "TEMPLATE_VARIABLES import"
      pattern: "TEMPLATE_VARIABLES"
    - from: "src/components/SettingsDialog.vue"
      to: "src/stores/useTemplateStore.ts"
      via: "import/export actions"
      pattern: "exportTemplates|importTemplates"
---

<objective>
Create template editor UI with variable highlighting, picker panel, and settings integration.

Purpose: Allow users to customize clinical text templates with visual feedback and easy variable insertion.
Output: TemplateEditor component with chip highlighting, VariablePicker for insertion, full Settings integration.
</objective>

<execution_context>
@~/.claude/get-shit-done/workflows/execute-plan.md
@~/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/phases/10-export-templates-logging/10-CONTEXT.md
@.planning/phases/10-export-templates-logging/10-04-PLAN.md

@src/components/SettingsDialog.vue (integration target - Templates tab)
@src/stores/useTemplateStore.ts (extended in plan 04)
@src/config/template-variables.ts (from plan 04)
@src/utils/template-parser.ts (from plan 04)
@src/config/templates/en.json (template structure)
</context>

<tasks>

<task type="auto">
  <name>Task 1: Create VariablePicker component</name>
  <files>src/components/VariablePicker.vue</files>
  <action>
Create component that displays available variables grouped by category:

```vue
<template>
  <v-card
    variant="outlined"
    class="variable-picker"
  >
    <v-card-title class="text-subtitle-2 py-2">
      Insert Variable
    </v-card-title>

    <v-card-text class="pa-2">
      <v-expansion-panels
        variant="accordion"
        density="compact"
      >
        <v-expansion-panel
          v-for="category in categories"
          :key="category.id"
        >
          <v-expansion-panel-title class="text-body-2">
            {{ category.label }}
          </v-expansion-panel-title>
          <v-expansion-panel-text>
            <v-list density="compact" class="pa-0">
              <v-list-item
                v-for="variable in category.variables"
                :key="variable.name"
                class="variable-item"
                @click="emit('select', variable.name)"
              >
                <template #prepend>
                  <v-chip
                    size="x-small"
                    color="primary"
                    variant="flat"
                    class="mr-2"
                  >
                    {{ `{{${variable.name}}}` }}
                  </v-chip>
                </template>
                <v-list-item-title class="text-body-2">
                  {{ variable.description }}
                </v-list-item-title>
                <v-list-item-subtitle class="text-caption">
                  Example: {{ variable.example }}
                </v-list-item-subtitle>
              </v-list-item>
            </v-list>
          </v-expansion-panel-text>
        </v-expansion-panel>
      </v-expansion-panels>
    </v-card-text>
  </v-card>
</template>

<script setup lang="ts">
import { computed } from 'vue';
import { TEMPLATE_VARIABLES, type TemplateVariable } from '@/config/template-variables';

const emit = defineEmits<{
  select: [variableName: string];
}>();

interface Category {
  id: TemplateVariable['category'];
  label: string;
  variables: TemplateVariable[];
}

const categories = computed((): Category[] => {
  const categoryLabels: Record<TemplateVariable['category'], string> = {
    gene: 'Gene',
    frequency: 'Frequency',
    risk: 'Risk',
    context: 'Context',
    formatting: 'Formatting (German)',
  };

  return (Object.keys(categoryLabels) as TemplateVariable['category'][]).map(id => ({
    id,
    label: categoryLabels[id],
    variables: TEMPLATE_VARIABLES.filter(v => v.category === id),
  })).filter(cat => cat.variables.length > 0);
});
</script>

<style scoped>
.variable-picker {
  max-height: 400px;
  overflow-y: auto;
}

.variable-item {
  cursor: pointer;
  border-radius: 4px;
}

.variable-item:hover {
  background-color: rgba(var(--v-theme-primary), 0.08);
}
</style>
```
  </action>
  <verify>Component renders categories with expandable panels, clicking variable emits select event</verify>
  <done>VariablePicker component displays grouped variables with click-to-insert</done>
</task>

<task type="auto">
  <name>Task 2: Create TemplateEditor component</name>
  <files>src/components/TemplateEditor.vue</files>
  <action>
Create section-based template editor with variable highlighting:

```vue
<template>
  <div class="template-editor">
    <!-- Section selector -->
    <div class="d-flex align-center mb-3">
      <v-select
        v-model="selectedPerspective"
        :items="perspectiveItems"
        label="Perspective"
        density="compact"
        variant="outlined"
        hide-details
        class="mr-2"
        style="max-width: 200px"
      />
      <v-select
        v-model="selectedSection"
        :items="sectionItems"
        label="Section"
        density="compact"
        variant="outlined"
        hide-details
        style="max-width: 200px"
      />
    </div>

    <!-- Editor area -->
    <div class="editor-container mb-3">
      <div class="editor-label text-caption text-medium-emphasis mb-1">
        Template Text
        <v-chip
          v-if="hasCustomization"
          size="x-small"
          color="warning"
          class="ml-2"
        >
          Modified
        </v-chip>
      </div>

      <!-- Preview with highlighted variables -->
      <div
        class="template-preview pa-3 rounded border"
        @click="focusTextarea"
      >
        <template v-for="(segment, idx) in parsedTemplate" :key="idx">
          <span v-if="segment.type === 'text'">{{ segment.content }}</span>
          <v-chip
            v-else
            size="small"
            color="primary"
            variant="flat"
            class="mx-1"
          >
            {{ segment.content }}
          </v-chip>
        </template>
      </div>

      <!-- Hidden textarea for actual editing -->
      <v-textarea
        ref="textareaRef"
        v-model="templateText"
        variant="outlined"
        density="compact"
        rows="4"
        hide-details
        class="mt-2"
        placeholder="Enter template text with {{variables}}"
      />
    </div>

    <!-- Actions -->
    <div class="d-flex align-center ga-2">
      <v-btn
        v-if="hasCustomization"
        variant="text"
        size="small"
        color="warning"
        @click="resetSection"
      >
        Reset Section
      </v-btn>
    </div>
  </div>
</template>

<script setup lang="ts">
import { ref, computed, watch } from 'vue';
import { useTemplateStore } from '@/stores/useTemplateStore';
import { parseTemplate } from '@/utils/template-parser';
import type { Perspective } from '@/types';

const templateStore = useTemplateStore();
const textareaRef = ref<HTMLTextAreaElement | null>(null);

// Selection state
const selectedPerspective = ref<Perspective>('affected');
const selectedSection = ref('geneIntro');

// Perspective options
const perspectiveItems = computed(() => {
  const templates = templateStore.defaultTemplates;
  return Object.entries(templates.perspectives).map(([key, config]) => ({
    title: config.label,
    value: key as Perspective,
  }));
});

// Section options based on selected perspective
const sectionItems = computed(() => {
  const templates = templateStore.defaultTemplates;
  const perspective = templates.perspectives[selectedPerspective.value];
  if (!perspective) return [];

  return Object.entries(perspective.sections).map(([key, section]) => ({
    title: section.label,
    value: key,
  }));
});

// Reset section selection when perspective changes
watch(selectedPerspective, () => {
  const items = sectionItems.value;
  if (items.length > 0 && !items.find(i => i.value === selectedSection.value)) {
    selectedSection.value = items[0].value;
  }
});

// Current template text (custom or default)
const templateText = computed({
  get: () => templateStore.getEffectiveTemplate(selectedPerspective.value, selectedSection.value),
  set: (value: string) => {
    const key = `${selectedPerspective.value}.${selectedSection.value}`;
    if (value === getDefaultTemplate()) {
      // If matches default, remove customization
      templateStore.resetCustomSection(key);
    } else {
      templateStore.setCustomSection(key, value);
    }
  },
});

// Check if current section has customization
const hasCustomization = computed(() =>
  templateStore.hasCustomization(selectedPerspective.value, selectedSection.value)
);

// Parse template for highlighting
const parsedTemplate = computed(() => parseTemplate(templateText.value));

// Get default template for comparison
function getDefaultTemplate(): string {
  const templates = templateStore.defaultTemplates;
  return templates.perspectives[selectedPerspective.value]?.sections[selectedSection.value]?.template ?? '';
}

// Reset current section to default
function resetSection() {
  const key = `${selectedPerspective.value}.${selectedSection.value}`;
  templateStore.resetCustomSection(key);
}

// Focus textarea when preview clicked
function focusTextarea() {
  textareaRef.value?.focus();
}

// Public method for variable insertion
function insertVariable(variableName: string) {
  const textarea = textareaRef.value;
  if (!textarea) {
    // Just append if no textarea focus
    templateText.value += `{{${variableName}}}`;
    return;
  }

  const start = textarea.selectionStart ?? templateText.value.length;
  const end = textarea.selectionEnd ?? start;
  const text = templateText.value;
  const insertion = `{{${variableName}}}`;

  templateText.value = text.slice(0, start) + insertion + text.slice(end);

  // Restore cursor position after insertion
  requestAnimationFrame(() => {
    textarea.selectionStart = textarea.selectionEnd = start + insertion.length;
    textarea.focus();
  });
}

defineExpose({ insertVariable });
</script>

<style scoped>
.template-preview {
  background-color: rgb(var(--v-theme-surface-variant));
  min-height: 80px;
  cursor: text;
  white-space: pre-wrap;
  word-break: break-word;
}

.border {
  border: 1px solid rgba(var(--v-border-color), var(--v-border-opacity));
}
</style>
```
  </action>
  <verify>Component renders with perspective/section selectors, variables appear as chips, text editing works</verify>
  <done>TemplateEditor component provides section-based editing with variable chip highlighting</done>
</task>

<task type="auto">
  <name>Task 3: Integrate into SettingsDialog Templates tab</name>
  <files>src/components/SettingsDialog.vue</files>
  <action>
Replace placeholder content in Templates tab with full editor integration:

1. Import new components:
```typescript
import TemplateEditor from '@/components/TemplateEditor.vue';
import VariablePicker from '@/components/VariablePicker.vue';
import { useTemplateStore } from '@/stores/useTemplateStore';
```

2. Add template store and refs:
```typescript
const templateStore = useTemplateStore();
const templateEditorRef = ref<InstanceType<typeof TemplateEditor> | null>(null);
const fileInputRef = ref<HTMLInputElement | null>(null);
```

3. Add import/export handlers:
```typescript
// Handle variable selection from picker
function handleVariableSelect(variableName: string) {
  templateEditorRef.value?.insertVariable(variableName);
}

// Export templates to JSON file
function handleExportTemplates() {
  const data = templateStore.exportTemplates();
  const json = JSON.stringify(data, null, 2);
  const blob = new Blob([json], { type: 'application/json' });
  const url = URL.createObjectURL(blob);
  const link = document.createElement('a');
  link.href = url;
  link.download = `templates_${data.language}_${new Date().toISOString().split('T')[0]}.json`;
  document.body.appendChild(link);
  link.click();
  document.body.removeChild(link);
  URL.revokeObjectURL(url);
}

// Import templates from JSON file
function handleImportTemplates(event: Event) {
  const input = event.target as HTMLInputElement;
  const file = input.files?.[0];
  if (!file) return;

  const reader = new FileReader();
  reader.onload = (e) => {
    try {
      const data = JSON.parse(e.target?.result as string);
      const success = templateStore.importTemplates(data);
      if (!success) {
        alert('Invalid template file format');
      }
    } catch {
      alert('Failed to parse template file');
    }
    // Reset file input
    input.value = '';
  };
  reader.readAsText(file);
}

// Reset templates for current language
function handleResetLanguage() {
  if (confirm(`Reset all ${templateStore.language === 'de' ? 'German' : 'English'} templates to defaults?`)) {
    templateStore.resetLanguageTemplates(templateStore.language);
  }
}
```

4. Replace Templates tab content:
```vue
<v-tabs-window-item value="templates">
  <div class="d-flex flex-column flex-md-row ga-4">
    <!-- Editor column -->
    <div class="flex-grow-1">
      <p class="text-body-2 text-medium-emphasis mb-4">
        Customize the clinical text templates. Use {{variable}} syntax for dynamic values.
      </p>

      <!-- Language selector -->
      <v-btn-toggle
        v-model="templateStore.language"
        color="primary"
        density="compact"
        mandatory
        class="mb-4"
      >
        <v-btn value="de">German</v-btn>
        <v-btn value="en">English</v-btn>
      </v-btn-toggle>

      <TemplateEditor ref="templateEditorRef" />

      <!-- Import/Export/Reset buttons -->
      <v-divider class="my-4" />

      <div class="d-flex flex-wrap ga-2">
        <v-btn
          variant="outlined"
          size="small"
          prepend-icon="mdi-download"
          @click="handleExportTemplates"
        >
          Export Templates
        </v-btn>

        <v-btn
          variant="outlined"
          size="small"
          prepend-icon="mdi-upload"
          @click="fileInputRef?.click()"
        >
          Import Templates
        </v-btn>
        <input
          ref="fileInputRef"
          type="file"
          accept=".json"
          style="display: none"
          @change="handleImportTemplates"
        >

        <v-btn
          variant="outlined"
          size="small"
          color="warning"
          prepend-icon="mdi-restore"
          @click="handleResetLanguage"
        >
          Reset {{ templateStore.language === 'de' ? 'German' : 'English' }}
        </v-btn>
      </div>
    </div>

    <!-- Variable picker column -->
    <div style="min-width: 280px">
      <VariablePicker @select="handleVariableSelect" />
    </div>
  </div>
</v-tabs-window-item>
```

5. Ensure all imports are at top:
```typescript
import { ref, nextTick } from 'vue';
```
  </action>
  <verify>Settings > Templates tab shows editor and picker, import/export/reset buttons work</verify>
  <done>SettingsDialog Templates tab provides full template editing with import/export</done>
</task>

</tasks>

<verification>
1. `bun run typecheck` - all imports resolve
2. `bun run lint` - no ESLint errors
3. `bun run dev` - Templates tab displays editor and variable picker
4. Test: Select perspective/section, edit text, variables show as chips
5. Test: Click variable in picker, variable inserted at cursor position
6. Test: Export templates - JSON file downloads
7. Test: Import templates - customizations applied
8. Test: Reset language - customizations cleared, defaults restored
</verification>

<success_criteria>
- TMPL-01: User can edit German clinical text templates in settings
- TMPL-02: User can edit English clinical text templates in settings
- TMPL-03: Template editor highlights {{variable}} placeholders as chips
- TMPL-04: Variable picker shows available template variables
- TMPL-05: User can insert variables via picker click
- TMPL-06: User can export templates to file
- TMPL-07: User can import templates from file
- TMPL-08: Template changes persist across sessions (via store persistence)
</success_criteria>

<output>
After completion, create `.planning/phases/10-export-templates-logging/10-05-SUMMARY.md`
</output>
