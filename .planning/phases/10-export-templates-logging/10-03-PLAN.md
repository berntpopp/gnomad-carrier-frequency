---
phase: 10-export-templates-logging
plan: 03
type: execute
wave: 2
depends_on: ["10-02"]
files_modified:
  - src/components/wizard/StepResults.vue
  - src/components/VariantModal.vue
autonomous: true

must_haves:
  truths:
    - "User can click export button in results step to download JSON or Excel"
    - "User can click export button in variant modal for population-specific export"
    - "Export buttons show dropdown menu with format options"
    - "Exports contain correct data based on current filters and selection"
  artifacts:
    - path: "src/components/wizard/StepResults.vue"
      provides: "Export button dropdown with JSON/Excel options"
      contains: "useExport"
    - path: "src/components/VariantModal.vue"
      provides: "Export button for current variants view"
      contains: "useExport"
  key_links:
    - from: "src/components/wizard/StepResults.vue"
      to: "src/composables/useExport.ts"
      via: "composable import"
      pattern: "useExport\\(\\)"
    - from: "src/components/VariantModal.vue"
      to: "src/composables/useExport.ts"
      via: "composable import"
      pattern: "useExport\\(\\)"
---

<objective>
Integrate export buttons into StepResults and VariantModal components.

Purpose: Allow users to export calculation results as JSON or Excel files from relevant locations.
Output: Export dropdown menus in results step and variant modal with working JSON/Excel download.
</objective>

<execution_context>
@~/.claude/get-shit-done/workflows/execute-plan.md
@~/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/phases/10-export-templates-logging/10-CONTEXT.md
@.planning/phases/10-export-templates-logging/10-02-PLAN.md

@src/components/wizard/StepResults.vue (integration target)
@src/components/VariantModal.vue (integration target)
@src/composables/useExport.ts (from plan 02)
@src/utils/export-utils.ts (from plan 02)
</context>

<tasks>

<task type="auto">
  <name>Task 1: Add export dropdown to StepResults</name>
  <files>src/components/wizard/StepResults.vue</files>
  <action>
Add export functionality to StepResults.vue:

1. Import composable and utilities:
```typescript
import { useExport } from '@/composables';
import { buildExportData } from '@/utils/export-utils';
import { toDisplayVariants } from '@/utils/variant-display';
```

2. Set up composable in script:
```typescript
const { exportToJson, exportToExcel } = useExport();
```

3. Create export handler function:
```typescript
function handleExport(format: 'json' | 'xlsx') {
  if (!props.result) return;

  // Convert filtered variants to display format for export
  const displayVariants = toDisplayVariants(filteredVariants.value, props.clinvarVariants);

  // Build complete export data
  const exportData = buildExportData(props.result, displayVariants, props.filterConfig);

  if (format === 'json') {
    exportToJson(exportData, props.result.gene);
  } else {
    exportToExcel(exportData, props.result.gene);
  }
}
```

4. Add export button in template, near "View all variants" button:
```vue
<!-- Export dropdown -->
<v-menu>
  <template #activator="{ props: menuProps }">
    <v-btn
      v-bind="menuProps"
      variant="outlined"
      color="secondary"
      prepend-icon="mdi-download"
      class="ml-2"
    >
      Export
      <v-icon end>mdi-chevron-down</v-icon>
    </v-btn>
  </template>
  <v-list density="compact">
    <v-list-item
      prepend-icon="mdi-code-json"
      @click="handleExport('json')"
    >
      <v-list-item-title>Export as JSON</v-list-item-title>
    </v-list-item>
    <v-list-item
      prepend-icon="mdi-file-excel"
      @click="handleExport('xlsx')"
    >
      <v-list-item-title>Export as Excel</v-list-item-title>
    </v-list-item>
  </v-list>
</v-menu>
```

Place the export button in the same row as the "View all variants" button, wrapped in a d-flex container if not already.

5. Ensure necessary imports are at top of file:
```typescript
import type { DisplayVariant } from '@/types';
```

Note: toDisplayVariants is already imported in the existing file.
  </action>
  <verify>Export dropdown appears in results step, clicking JSON/Excel downloads file with correct data</verify>
  <done>StepResults has working export dropdown with JSON and Excel options</done>
</task>

<task type="auto">
  <name>Task 2: Add export button to VariantModal</name>
  <files>src/components/VariantModal.vue</files>
  <action>
Add export functionality to VariantModal.vue for exporting current variant view:

1. Import composable and utilities:
```typescript
import { useExport } from '@/composables';
import { buildExportVariants, buildExportMetadata, generateFilename } from '@/utils/export-utils';
```

2. Add props for filter config (if not present) and result version:
Update props to include what's needed for metadata:
```typescript
const props = defineProps<{
  variants: DisplayVariant[];
  populationLabel: string | null;
  populationCode: string | null;
  // Add if not present:
  filterConfig?: FilterConfig;
  gnomadVersion?: GnomadVersion;
  gene?: string;
}>();
```

Note: Check existing props - if filterConfig/version/gene not available, may need to add them or fetch from store.

3. Set up composable:
```typescript
const { exportToJson, exportToExcel } = useExport();
```

4. Create export handler for variant-specific export:
```typescript
function handleVariantExport(format: 'json' | 'xlsx') {
  if (!props.variants.length) return;

  const exportVariants = buildExportVariants(props.variants);
  const gene = props.gene || 'variants';
  const population = props.populationCode || undefined;

  if (format === 'json') {
    const data = {
      variants: exportVariants,
      populationCode: props.populationCode,
      populationLabel: props.populationLabel,
      exportDate: new Date().toISOString(),
      variantCount: exportVariants.length,
    };
    const json = JSON.stringify(data, null, 2);
    const blob = new Blob([json], { type: 'application/json' });
    const filename = generateFilename(gene, population) + '_variants.json';
    // Use native download
    const url = URL.createObjectURL(blob);
    const link = document.createElement('a');
    link.href = url;
    link.download = filename;
    document.body.appendChild(link);
    link.click();
    document.body.removeChild(link);
    URL.revokeObjectURL(url);
  } else {
    // Excel export with single Variants sheet
    import('xlsx').then(XLSX => {
      const wb = XLSX.utils.book_new();
      const ws = XLSX.utils.json_to_sheet(exportVariants);
      XLSX.utils.book_append_sheet(wb, ws, 'Variants');
      const filename = generateFilename(gene, population) + '_variants.xlsx';
      XLSX.writeFile(wb, filename);
    });
  }
}
```

5. Add export button in modal card actions:
```vue
<v-card-actions>
  <!-- Export dropdown -->
  <v-menu>
    <template #activator="{ props: menuProps }">
      <v-btn
        v-bind="menuProps"
        variant="text"
        color="secondary"
        size="small"
        :disabled="variants.length === 0"
      >
        <v-icon start>mdi-download</v-icon>
        Export
        <v-icon end>mdi-chevron-down</v-icon>
      </v-btn>
    </template>
    <v-list density="compact">
      <v-list-item @click="handleVariantExport('json')">
        <template #prepend>
          <v-icon>mdi-code-json</v-icon>
        </template>
        <v-list-item-title>JSON</v-list-item-title>
      </v-list-item>
      <v-list-item @click="handleVariantExport('xlsx')">
        <template #prepend>
          <v-icon>mdi-file-excel</v-icon>
        </template>
        <v-list-item-title>Excel</v-list-item-title>
      </v-list-item>
    </v-list>
  </v-menu>

  <v-spacer />
  <v-btn variant="text" @click="close">Close</v-btn>
</v-card-actions>
```

6. Update StepResults to pass additional props to VariantModal if needed:
```vue
<VariantModal
  v-model="showVariantModal"
  :variants="modalVariants"
  :population-label="selectedPopulationLabel"
  :population-code="selectedPopulationCode"
  :gene="result?.gene"
/>
```
  </action>
  <verify>Export dropdown appears in variant modal, exports work for both all-variants and population-filtered views</verify>
  <done>VariantModal has working export dropdown for current variant view</done>
</task>

</tasks>

<verification>
1. `bun run typecheck` - all imports resolve
2. `bun run lint` - no ESLint errors
3. `bun run dev` - export dropdowns visible in UI
4. Test: Complete calculation, click Export > JSON - file downloads with correct data
5. Test: Complete calculation, click Export > Excel - file downloads with 4 sheets
6. Test: Open variant modal, click Export > JSON - variant-only file downloads
7. Test: Population drill-down, export from modal - filename includes population code
</verification>

<success_criteria>
- EXP-01: User can export results as JSON file from results step
- EXP-02: User can export results as Excel file from results step
- EXP-03: Exports include gene, populations, frequencies, calculated risks
- EXP-04: Exports include metadata (gnomAD version, date, filters used)
- Context-appropriate exports: Full results from StepResults, variants-only from modal
</success_criteria>

<output>
After completion, create `.planning/phases/10-export-templates-logging/10-03-SUMMARY.md`
</output>
