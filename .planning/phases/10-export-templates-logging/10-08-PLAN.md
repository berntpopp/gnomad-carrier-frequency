---
phase: 10-export-templates-logging
plan: 08
type: execute
wave: 3
depends_on: ["10-01", "10-06"]
files_modified:
  - src/api/client.ts
  - src/composables/useCarrierFrequency.ts
  - src/composables/useGeneSearch.ts
  - src/composables/useClingenValidity.ts
  - src/App.vue
autonomous: true

must_haves:
  truths:
    - "API calls are logged with request/response details"
    - "Calculation results are logged"
    - "Errors are logged with context"
    - "App startup is logged"
  artifacts:
    - path: "src/api/client.ts"
      provides: "GraphQL client with logging integration"
      contains: "useLogger"
    - path: "src/composables/useCarrierFrequency.ts"
      provides: "Calculation composable with logging"
      contains: "useLogger"
  key_links:
    - from: "src/api/client.ts"
      to: "src/composables/useLogger.ts"
      via: "logger import"
      pattern: "useLogger\\('api'\\)"
    - from: "src/composables/useCarrierFrequency.ts"
      to: "src/composables/useLogger.ts"
      via: "logger import"
      pattern: "useLogger\\('calculation'\\)"
---

<objective>
Integrate logging throughout the application at key events.

Purpose: Capture API calls, calculations, and errors for debugging and troubleshooting.
Output: Logging calls added to API client, composables, and app startup.
</objective>

<execution_context>
@~/.claude/get-shit-done/workflows/execute-plan.md
@~/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/phases/10-export-templates-logging/10-01-PLAN.md
@.planning/phases/10-export-templates-logging/10-06-PLAN.md

@src/composables/useLogger.ts (from plan 01)
@src/stores/useLogStore.ts (from plan 01)
@src/api/client.ts (integration target)
@src/composables/useCarrierFrequency.ts (integration target)
@src/composables/useGeneSearch.ts (integration target)
@src/composables/useClingenValidity.ts (integration target)
</context>

<tasks>

<task type="auto">
  <name>Task 1: Add logging to API client</name>
  <files>src/api/client.ts</files>
  <action>
Add logging to the GraphQL client for API request/response tracking:

1. Import the logger:
```typescript
import { useLogger } from '@/composables/useLogger';
```

2. Create logger instance at module level (or within the client setup):
```typescript
// Note: For module-level logging, we need to access the store directly
// since composables require component context
import { useLogStore } from '@/stores/useLogStore';

function logApi(level: 'DEBUG' | 'INFO' | 'WARN' | 'ERROR', message: string, details?: unknown) {
  try {
    const store = useLogStore();
    store.log(level, 'api', message, details);
  } catch {
    // Store not yet initialized, skip logging
  }
}
```

3. Add logging to fetch/request operations. For the villus client, wrap the fetch or add to existing error handling:

If using a custom fetch wrapper:
```typescript
// Before request
logApi('DEBUG', 'GraphQL request', {
  operationName: query.definitions[0]?.name?.value || 'unknown',
  variables,
});

// After successful response
logApi('INFO', 'GraphQL response received', {
  operationName,
  hasData: !!data,
  hasErrors: !!errors?.length,
});

// On error
logApi('ERROR', 'GraphQL request failed', {
  operationName,
  error: error.message,
});
```

Adapt to the actual client structure. The key is to capture:
- Request details (operation name, key variables like gene symbol)
- Response success/failure
- Errors with context
  </action>
  <verify>API calls appear in log viewer with appropriate details</verify>
  <done>API client logs request/response/error events</done>
</task>

<task type="auto">
  <name>Task 2: Add logging to calculation composables</name>
  <files>src/composables/useCarrierFrequency.ts, src/composables/useGeneSearch.ts</files>
  <action>
Add logging to key composables for tracking calculations and searches:

**src/composables/useCarrierFrequency.ts:**

1. Import logger:
```typescript
import { useLogger } from './useLogger';
```

2. Create logger in composable:
```typescript
const logger = useLogger('calculation');
```

3. Add logging at key points:

```typescript
// When calculation starts
logger.info('Starting carrier frequency calculation', { gene: geneSymbol });

// When calculation completes
logger.info('Calculation complete', {
  gene: result.gene,
  globalCarrierFrequency: result.globalCarrierFrequency,
  qualifyingVariants: result.qualifyingVariantCount,
  populations: result.populations.length,
});

// On error
logger.error('Calculation failed', { gene: geneSymbol, error: error.message });
```

**src/composables/useGeneSearch.ts:**

1. Import logger:
```typescript
import { useLogger } from './useLogger';
```

2. Create logger:
```typescript
const logger = useLogger('search');
```

3. Add logging:
```typescript
// When search starts
logger.debug('Gene search', { query: searchTerm });

// When gene selected
logger.info('Gene selected', {
  symbol: selectedGene.symbol,
  name: selectedGene.name,
});

// On search error
logger.warn('Gene search failed', { query: searchTerm, error: error.message });
```
  </action>
  <verify>Calculations and searches appear in log viewer</verify>
  <done>Calculation composables log key events</done>
</task>

<task type="auto">
  <name>Task 3: Add logging to ClinGen and app startup</name>
  <files>src/composables/useClingenValidity.ts, src/App.vue</files>
  <action>
Add logging to ClinGen operations and app initialization:

**src/composables/useClingenValidity.ts:**

1. Import logger:
```typescript
import { useLogger } from './useLogger';
```

2. Create logger:
```typescript
const logger = useLogger('clingen');
```

3. Add logging:
```typescript
// Cache hit
logger.debug('ClinGen cache hit', { gene: geneSymbol });

// Cache miss - fetching
logger.info('Fetching ClinGen data', { gene: geneSymbol });

// Fetch complete
logger.info('ClinGen data loaded', {
  gene: geneSymbol,
  hasValidity: !!result,
  classification: result?.classification,
});

// Cache refresh
logger.info('ClinGen cache refreshed', { entryCount: entries.length });

// Error
logger.error('ClinGen fetch failed', { gene: geneSymbol, error: error.message });
```

**src/App.vue:**

1. Import logger and store:
```typescript
import { useLogger } from '@/composables';
import { useLogStore } from '@/stores/useLogStore';
import { onMounted } from 'vue';
```

2. Add startup logging:
```typescript
const logger = useLogger('app');
const logStore = useLogStore();

onMounted(() => {
  // Handle autoClearOnStart setting
  if (logStore.settings.autoClearOnStart) {
    logStore.clearAll();
  }

  // Log app startup
  logger.info('Application started', {
    version: import.meta.env.VITE_APP_VERSION,
    timestamp: new Date().toISOString(),
  });
});
```

This ensures:
- App startup is logged (useful for session tracking)
- autoClearOnStart setting is respected
- Version info captured for debugging
  </action>
  <verify>App startup logged, ClinGen operations appear in logs</verify>
  <done>ClinGen composable and app startup log key events</done>
</task>

</tasks>

<verification>
1. `bun run typecheck` - all imports resolve
2. `bun run lint` - no ESLint errors
3. `bun run dev` - start app
4. Open log viewer (footer icon)
5. Verify: "Application started" entry with version
6. Search for a gene - verify search/API logs appear
7. Complete calculation - verify calculation logs
8. Enable autoClearOnStart in settings, refresh - logs cleared on start
</verification>

<success_criteria>
- LOG-01: App logs key events (API calls, calculations, errors)
- API requests/responses logged with operation details
- Calculations logged with gene and result summary
- Errors logged with context for debugging
- App startup logged with version for session tracking
</success_criteria>

<output>
After completion, create `.planning/phases/10-export-templates-logging/10-08-SUMMARY.md`
</output>
