---
phase: 01-foundation
plan: 04
type: execute
wave: 3
depends_on: ["01-03"]
files_modified:
  - src/api/queries/gene-search.ts
  - src/api/queries/gene-variants.ts
  - src/api/queries/types.ts
  - src/api/queries/index.ts
  - src/composables/useGeneSearch.ts
  - src/composables/useGeneVariants.ts
  - src/composables/index.ts
autonomous: true

must_haves:
  truths:
    - "User can enter gene symbol and see autocomplete suggestions from gnomAD"
    - "Gene symbol is validated against gnomAD before proceeding"
    - "Invalid gene shows clear error message"
    - "App queries gnomAD GraphQL API for gene variants"
    - "API errors show user-friendly feedback"
    - "Queries use dataset ID from config for selected version"
    - "Debounce timing comes from config"
  artifacts:
    - path: "src/api/queries/gene-search.ts"
      provides: "GraphQL query for gene autocomplete"
      exports: ["GENE_SEARCH_QUERY"]
    - path: "src/api/queries/gene-variants.ts"
      provides: "GraphQL query for gene variants with populations and ClinVar"
      exports: ["GENE_VARIANTS_QUERY"]
    - path: "src/composables/useGeneSearch.ts"
      provides: "Reactive gene search with debounced autocomplete"
      exports: ["useGeneSearch"]
    - path: "src/composables/useGeneVariants.ts"
      provides: "Reactive variant fetching with error handling"
      exports: ["useGeneVariants"]
  key_links:
    - from: "src/composables/useGeneSearch.ts"
      to: "src/config/index.ts"
      via: "config import for debounce timing"
      pattern: "import.*config.*from.*@/config"
    - from: "src/composables/useGeneVariants.ts"
      to: "src/config/index.ts"
      via: "config import for dataset ID"
      pattern: "import.*getDatasetId.*from.*@/config"
---

<objective>
Create GraphQL queries and Vue composables for gene search autocomplete and variant data fetching from gnomAD API.

Purpose: Implement the API layer that retrieves gene and variant data, with all configuration (debounce timing, dataset IDs, reference genomes) coming from the config module.
Output: Reactive composables that provide debounced gene search and variant data with proper error handling.
</objective>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/phases/01-foundation/01-RESEARCH.md
@.planning/phases/01-foundation/01-03-SUMMARY.md
</context>

<tasks>

<task type="auto">
  <name>Task 1: Create GraphQL query definitions</name>
  <files>
    - src/api/queries/gene-search.ts
    - src/api/queries/gene-variants.ts
    - src/api/queries/types.ts
    - src/api/queries/index.ts
  </files>
  <action>
Create GraphQL queries based on research findings.

**Note on query structure:** Queries themselves are static strings - they don't contain config values. The variables (dataset, referenceGenome) are passed at query time from config.

1. src/api/queries/types.ts:
   ```typescript
   // Response types for gnomAD GraphQL queries

   export interface GeneSearchResult {
     ensembl_id: string;
     symbol: string;
   }

   export interface GeneSearchResponse {
     gene_search: GeneSearchResult[];
   }

   export interface GeneVariantPopulation {
     id: string;
     ac: number;
     an: number;
   }

   export interface GeneVariantExomeGenome {
     ac: number;
     an: number;
     populations: GeneVariantPopulation[];
   }

   export interface GeneVariantTranscript {
     gene_symbol: string;
     transcript_id: string;
     canonical: boolean;
     consequence_terms: string[];
     lof: string | null;
     lof_filter: string | null;
     lof_flags: string | null;
   }

   export interface GeneVariant {
     variant_id: string;
     pos: number;
     ref: string;
     alt: string;
     exome: GeneVariantExomeGenome | null;
     genome: GeneVariantExomeGenome | null;
     transcript_consequences: GeneVariantTranscript[];
   }

   export interface GeneClinvarVariant {
     variant_id: string;
     clinical_significance: string;
     gold_stars: number;
     review_status: string;
     pos: number;
     ref: string;
     alt: string;
   }

   export interface GeneData {
     gene_id: string;
     symbol: string;
     variants: GeneVariant[];
     clinvar_variants: GeneClinvarVariant[];
   }

   export interface GeneVariantsResponse {
     gene: GeneData | null;
   }
   ```

2. src/api/queries/gene-search.ts:
   ```typescript
   // Gene search query - variables (referenceGenome) passed at runtime from config
   export const GENE_SEARCH_QUERY = `
     query GeneSearch($query: String!, $referenceGenome: ReferenceGenomeId!) {
       gene_search(query: $query, reference_genome: $referenceGenome) {
         ensembl_id
         symbol
       }
     }
   `;

   export interface GeneSearchVariables {
     query: string;
     referenceGenome: 'GRCh37' | 'GRCh38';
   }
   ```

3. src/api/queries/gene-variants.ts:
   ```typescript
   // Gene variants query - variables (dataset, referenceGenome) passed at runtime from config
   // Note: Population AF must be calculated from ac/an (not directly available)
   export const GENE_VARIANTS_QUERY = `
     query GeneVariants($geneSymbol: String!, $dataset: DatasetId!, $referenceGenome: ReferenceGenomeId!) {
       gene(gene_symbol: $geneSymbol, reference_genome: $referenceGenome) {
         gene_id
         symbol
         variants(dataset: $dataset) {
           variant_id
           pos
           ref
           alt
           exome {
             ac
             an
             populations {
               id
               ac
               an
             }
           }
           genome {
             ac
             an
             populations {
               id
               ac
               an
             }
           }
           transcript_consequences {
             gene_symbol
             transcript_id
             canonical
             consequence_terms
             lof
             lof_filter
             lof_flags
           }
         }
         clinvar_variants {
           variant_id
           clinical_significance
           gold_stars
           review_status
           pos
           ref
           alt
         }
       }
     }
   `;

   export interface GeneVariantsVariables {
     geneSymbol: string;
     dataset: string;  // From config: 'gnomad_r4', 'gnomad_r3', 'gnomad_r2_1'
     referenceGenome: 'GRCh37' | 'GRCh38';
   }
   ```

4. src/api/queries/index.ts:
   - Re-export all queries and types
  </action>
  <verify>
- TypeScript compiler accepts all query files
- Query strings match gnomAD GraphQL schema (reference: research doc)
- No hardcoded dataset IDs or reference genomes in query strings
  </verify>
  <done>
- GENE_SEARCH_QUERY exported and typed
- GENE_VARIANTS_QUERY exported with population ac/an fields
- Response types match gnomAD API structure
- Query variables include dataset and referenceGenome (filled from config)
  </done>
</task>

<task type="auto">
  <name>Task 2: Create gene search composable with config-driven settings</name>
  <files>
    - src/composables/useGeneSearch.ts
    - src/composables/index.ts
  </files>
  <action>
Create reactive gene search with debounced autocomplete, using config for timing:

1. src/composables/useGeneSearch.ts:
   ```typescript
   import { computed, ref, type Ref } from 'vue';
   import { useQuery } from 'villus';
   import { useDebounceFn } from '@vueuse/core';
   import { GENE_SEARCH_QUERY } from '@/api/queries/gene-search';
   import type { GeneSearchResponse, GeneSearchResult } from '@/api/queries/types';
   import { config, getReferenceGenome, type GnomadVersion } from '@/config';
   import { useGnomadVersion } from '@/api';

   // Get settings from config - NO HARDCODED VALUES
   const { debounceMs, minSearchChars, maxAutocompleteResults } = config.settings;

   export interface UseGeneSearchReturn {
     searchTerm: Ref<string>;
     setSearchTerm: (term: string) => void;
     results: Ref<GeneSearchResult[]>;
     isLoading: Ref<boolean>;
     error: Ref<Error | null>;
     selectedGene: Ref<GeneSearchResult | null>;
     selectGene: (gene: GeneSearchResult) => void;
     clearSelection: () => void;
     isValidGene: Ref<boolean>;
   }

   export function useGeneSearch(): UseGeneSearchReturn {
     const { version } = useGnomadVersion();

     const searchTerm = ref('');
     const debouncedTerm = ref('');
     const selectedGene = ref<GeneSearchResult | null>(null);

     // Debounce using timing from config
     const setSearchTerm = useDebounceFn((term: string) => {
       // Normalize to uppercase for gnomAD (GENE-02: case-insensitive)
       debouncedTerm.value = term.trim().toUpperCase();
     }, debounceMs);  // From config.settings.debounceMs

     // Watch raw input and trigger debounced update
     const updateSearchTerm = (term: string) => {
       searchTerm.value = term;
       // Clear selection when user types
       if (selectedGene.value && term.toUpperCase() !== selectedGene.value.symbol) {
         selectedGene.value = null;
       }
       setSearchTerm(term);
     };

     // Variables use referenceGenome from config based on current version
     const variables = computed(() => ({
       query: debouncedTerm.value,
       referenceGenome: getReferenceGenome(version.value),  // From config
     }));

     const { data, isFetching, error } = useQuery<GeneSearchResponse>({
       query: GENE_SEARCH_QUERY,
       variables,
       skip: () =>
         debouncedTerm.value.length < minSearchChars ||  // From config
         selectedGene.value !== null,
     });

     // Limit results from config
     const results = computed(() =>
       (data.value?.gene_search ?? []).slice(0, maxAutocompleteResults)
     );

     const selectGene = (gene: GeneSearchResult) => {
       selectedGene.value = gene;
       searchTerm.value = gene.symbol;
       debouncedTerm.value = ''; // Stop searching
     };

     const clearSelection = () => {
       selectedGene.value = null;
       searchTerm.value = '';
       debouncedTerm.value = '';
     };

     const isValidGene = computed(() => selectedGene.value !== null);

     return {
       searchTerm,
       setSearchTerm: updateSearchTerm,
       results,
       isLoading: isFetching,
       error: computed(() => error.value ?? null),
       selectedGene,
       selectGene,
       clearSelection,
       isValidGene,
     };
   }
   ```

2. src/composables/index.ts:
   ```typescript
   export { useGeneSearch } from './useGeneSearch';
   export type { UseGeneSearchReturn } from './useGeneSearch';
   ```
  </action>
  <verify>
Verify no magic numbers:
- `grep -r "300" src/composables/` should return nothing (debounceMs from config)
- `grep -r "minChars" src/composables/` should show only config import, not hardcoded

Test in browser with App.vue:
- Type "CFT" - should see CFTR in autocomplete after debounce
- Type "BRCA" - should see BRCA1, BRCA2
- Select gene - results should clear, selectedGene should be set
  </verify>
  <done>
- useGeneSearch exported with proper types
- Debounce timing from config.settings.debounceMs
- Minimum characters from config.settings.minSearchChars
- Max results from config.settings.maxAutocompleteResults
- Reference genome from config based on version
- Case-insensitive input (normalized to uppercase)
- Gene selection tracked separately from search
  </done>
</task>

<task type="auto">
  <name>Task 3: Create gene variants composable with version-aware dataset</name>
  <files>
    - src/composables/useGeneVariants.ts
    - src/composables/index.ts (update)
  </files>
  <action>
Create reactive variant fetching that uses dataset ID from config:

1. src/composables/useGeneVariants.ts:
   ```typescript
   import { computed, type Ref } from 'vue';
   import { useQuery } from 'villus';
   import { GENE_VARIANTS_QUERY } from '@/api/queries/gene-variants';
   import type {
     GeneVariantsResponse,
     GeneVariant,
     GeneClinvarVariant,
   } from '@/api/queries/types';
   import { getDatasetId, getReferenceGenome, type GnomadVersion } from '@/config';
   import { useGnomadVersion } from '@/api';

   export interface UseGeneVariantsReturn {
     gene: Ref<GeneVariantsResponse['gene']>;
     variants: Ref<GeneVariant[]>;
     clinvarVariants: Ref<GeneClinvarVariant[]>;
     isLoading: Ref<boolean>;
     hasError: Ref<boolean>;
     errorMessage: Ref<string | null>;
     refetch: () => Promise<void>;
     hasData: Ref<boolean>;
     currentVersion: Ref<GnomadVersion>;
   }

   export function useGeneVariants(geneSymbol: Ref<string | null>): UseGeneVariantsReturn {
     const { version } = useGnomadVersion();

     // Variables use dataset and referenceGenome from config
     const variables = computed(() => ({
       geneSymbol: geneSymbol.value?.toUpperCase() ?? '',
       dataset: getDatasetId(version.value),           // From config: 'gnomad_r4', etc.
       referenceGenome: getReferenceGenome(version.value),  // From config: 'GRCh38', etc.
     }));

     const { data, isFetching, error, execute } = useQuery<GeneVariantsResponse>({
       query: GENE_VARIANTS_QUERY,
       variables,
       skip: () => !geneSymbol.value,
       cachePolicy: 'cache-first',
     });

     const gene = computed(() => data.value?.gene ?? null);
     const variants = computed(() => gene.value?.variants ?? []);
     const clinvarVariants = computed(() => gene.value?.clinvar_variants ?? []);
     const hasData = computed(() => gene.value !== null);

     const hasError = computed(() =>
       !!error.value ||
       (data.value !== undefined && gene.value === null && !isFetching.value)
     );

     const errorMessage = computed(() => {
       if (error.value) {
         const msg = error.value.message;
         // GENE-03: Invalid gene shows clear error message
         if (msg.includes('not found') || msg.includes('does not exist')) {
           return `Gene "${geneSymbol.value}" not found in gnomAD. Please check the gene symbol.`;
         }
         // API-02: Handle API errors gracefully
         if (msg.includes('timeout') || msg.includes('network')) {
           return 'Network error. Please check your connection and try again.';
         }
         return 'Failed to load variant data. Please try again.';
       }
       // Gene exists in search but has no data
       if (data.value !== undefined && gene.value === null && geneSymbol.value) {
         return `Gene "${geneSymbol.value}" not found in gnomAD database.`;
       }
       return null;
     });

     const refetch = async () => {
       await execute();
     };

     return {
       gene,
       variants,
       clinvarVariants,
       isLoading: isFetching,
       hasError,
       errorMessage,
       refetch,
       hasData,
       currentVersion: version,
     };
   }
   ```

2. Update src/composables/index.ts:
   ```typescript
   export { useGeneSearch } from './useGeneSearch';
   export type { UseGeneSearchReturn } from './useGeneSearch';

   export { useGeneVariants } from './useGeneVariants';
   export type { UseGeneVariantsReturn } from './useGeneVariants';
   ```
  </action>
  <verify>
Verify no hardcoded dataset IDs:
- `grep -r "gnomad_r4" src/composables/` should return nothing
- `grep -r "gnomad_r3" src/composables/` should return nothing
- `grep -r "GRCh38" src/composables/` should return nothing (comes from config)

Test in browser:
- Select CFTR from search - should fetch variants with v4 dataset
- Check that variants array has items
- Check that clinvarVariants array has items
  </verify>
  <done>
- useGeneVariants exported with proper types
- Dataset ID from config via getDatasetId(version)
- Reference genome from config via getReferenceGenome(version)
- Fetches variants only when geneSymbol is provided
- Cache-first policy for performance
- Clear error messages for gene not found / network errors
- refetch function for retry capability
- currentVersion exposed for UI display
  </done>
</task>

</tasks>

<verification>
1. TypeScript compiles without errors
2. No hardcoded values in composables:
   - `grep -rE "(300|gnomad_r|GRCh)" src/composables/` returns nothing
3. Gene search with "CFTR" returns results from gnomAD
4. Gene search with "NOTREAL" returns empty results
5. Selecting CFTR triggers variant fetch with correct dataset from config
6. Variant response includes variants and clinvar_variants arrays
7. Error states display user-friendly messages
8. Debounce timing matches config.settings.debounceMs
</verification>

<success_criteria>
- GENE-01: Autocomplete suggestions appear after minSearchChars from config
- GENE-02: Gene validated against gnomAD API
- GENE-03: Invalid gene shows clear error message
- API-01: App successfully queries gnomAD GraphQL
- API-02: Errors handled with user feedback
- Debounce timing from config.settings.debounceMs
- Dataset ID from config.gnomad.versions[version].datasetId
- Reference genome from config.gnomad.versions[version].referenceGenome
- ZERO hardcoded values in src/composables/
</success_criteria>

<output>
After completion, create `.planning/phases/01-foundation/01-04-SUMMARY.md`
</output>
