---
phase: 01-foundation
plan: 04
type: execute
wave: 3
depends_on: ["01-02", "01-03"]
files_modified:
  - src/composables/useCarrierFrequency.ts
  - src/composables/index.ts
  - src/components/GeneSearch.vue
  - src/components/FrequencyResults.vue
  - src/App.vue
autonomous: true

must_haves:
  truths:
    - "User can enter CFTR and see carrier frequency ~1:25 for NFE population"
    - "All 8 gnomAD populations displayed with carrier frequencies"
    - "Founder effect flagged when population >5x global frequency"
    - "Results show both percentage and ratio formats"
    - "Invalid gene shows error, no crash"
    - "No qualifying variants falls back to 1:100 default"
  artifacts:
    - path: "src/composables/useCarrierFrequency.ts"
      provides: "Orchestrates variant filtering and frequency calculation"
      exports: ["useCarrierFrequency"]
    - path: "src/components/GeneSearch.vue"
      provides: "Gene input with autocomplete UI"
      contains: "v-autocomplete"
    - path: "src/components/FrequencyResults.vue"
      provides: "Population frequency table display"
      contains: "v-data-table"
  key_links:
    - from: "src/composables/useCarrierFrequency.ts"
      to: "src/composables/useGeneVariants.ts"
      via: "composable composition"
      pattern: "useGeneVariants"
    - from: "src/composables/useCarrierFrequency.ts"
      to: "src/utils/variant-filters.ts"
      via: "filter import"
      pattern: "filterPathogenicVariants"
    - from: "src/composables/useCarrierFrequency.ts"
      to: "src/utils/frequency-calc.ts"
      via: "calculation import"
      pattern: "calculateCarrierFrequency"
---

<objective>
Wire together the composables and create a minimal test UI to verify carrier frequency calculation end-to-end with real gnomAD data.

Purpose: Complete Phase 1 by connecting API data to calculation logic and displaying results. This validates the core value proposition: entering a gene and seeing accurate carrier frequencies.
Output: Working gene search with frequency results display that proves the calculation pipeline works correctly.
</objective>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/phases/01-foundation/01-RESEARCH.md
@.planning/phases/01-foundation/01-02-SUMMARY.md
@.planning/phases/01-foundation/01-03-SUMMARY.md
</context>

<tasks>

<task type="auto">
  <name>Task 1: Create carrier frequency composable</name>
  <files>
    - src/composables/useCarrierFrequency.ts
    - src/composables/index.ts (update)
  </files>
  <action>
Create the orchestrating composable that combines filtering and calculation:

1. src/composables/useCarrierFrequency.ts:
   ```typescript
   import { computed, ref, watch, type Ref } from 'vue';
   import { useGeneVariants } from './useGeneVariants';
   import { filterPathogenicVariants } from '@/utils/variant-filters';
   import {
     aggregatePopulationFrequencies,
     buildPopulationFrequencies,
     calculateAlleleFrequency,
     calculateCarrierFrequency,
     calculateRecurrenceRisk,
   } from '@/utils/frequency-calc';
   import { formatCarrierFrequency } from '@/utils/formatters';
   import type {
     CarrierFrequencyResult,
     IndexPatientStatus,
     PopulationFrequency,
   } from '@/types';

   // API-03: Default fallback when no qualifying variants
   const DEFAULT_CARRIER_FREQUENCY = 1 / 100; // 1:100

   export interface UseCarrierFrequencyReturn {
     // Input
     geneSymbol: Ref<string | null>;
     setGeneSymbol: (symbol: string | null) => void;

     // Loading/Error
     isLoading: Ref<boolean>;
     hasError: Ref<boolean>;
     errorMessage: Ref<string | null>;

     // Results
     result: Ref<CarrierFrequencyResult | null>;
     globalFrequency: Ref<{ percent: string; ratio: string } | null>;
     populations: Ref<PopulationFrequency[]>;
     qualifyingVariantCount: Ref<number>;
     hasFounderEffect: Ref<boolean>;
     usingDefault: Ref<boolean>;

     // Recurrence risk
     calculateRisk: (status: IndexPatientStatus) => {
       risk: number;
       percent: string;
       ratio: string;
     } | null;

     // Actions
     refetch: () => Promise<void>;
   }

   export function useCarrierFrequency(): UseCarrierFrequencyReturn {
     const geneSymbol = ref<string | null>(null);

     const setGeneSymbol = (symbol: string | null) => {
       geneSymbol.value = symbol?.toUpperCase() ?? null;
     };

     // Fetch variants
     const {
       variants,
       clinvarVariants,
       isLoading,
       hasError,
       errorMessage,
       refetch,
       hasData,
     } = useGeneVariants(geneSymbol);

     // Filter to pathogenic variants (FILT-01, FILT-02, FILT-03)
     const pathogenicVariants = computed(() => {
       if (!variants.value.length) return [];
       return filterPathogenicVariants(variants.value, clinvarVariants.value);
     });

     const qualifyingVariantCount = computed(() => pathogenicVariants.value.length);

     // API-03: Check if using default (no qualifying variants)
     const usingDefault = computed(() =>
       hasData.value && pathogenicVariants.value.length === 0
     );

     // Aggregate population frequencies
     const aggregatedPops = computed(() => {
       if (usingDefault.value) return null;
       if (!pathogenicVariants.value.length) return null;
       return aggregatePopulationFrequencies(pathogenicVariants.value);
     });

     // Calculate global carrier frequency
     const globalCarrierFrequency = computed((): number | null => {
       if (usingDefault.value) return DEFAULT_CARRIER_FREQUENCY;
       if (!aggregatedPops.value) return null;

       // Sum all pathogenic AFs across all populations for global
       let totalAC = 0;
       let maxAN = 0;
       for (const variant of pathogenicVariants.value) {
         const exomeAC = variant.exome?.ac ?? 0;
         const genomeAC = variant.genome?.ac ?? 0;
         totalAC += exomeAC + genomeAC;

         const exomeAN = variant.exome?.an ?? 0;
         const genomeAN = variant.genome?.an ?? 0;
         maxAN = Math.max(maxAN, exomeAN, genomeAN);
       }

       if (maxAN === 0) return null;
       const globalAF = totalAC / maxAN;
       return 2 * globalAF; // Carrier frequency = 2 x AF
     });

     // Build population frequency array (POP-01, POP-02, POP-03, POP-04)
     const populations = computed((): PopulationFrequency[] => {
       if (!aggregatedPops.value || globalCarrierFrequency.value === null) return [];
       return buildPopulationFrequencies(aggregatedPops.value, globalCarrierFrequency.value);
     });

     // Check for founder effect (any population >5x global)
     const hasFounderEffect = computed(() =>
       populations.value.some(p => p.isFounderEffect)
     );

     // Format global frequency (CALC-04)
     const globalFrequency = computed(() => {
       if (globalCarrierFrequency.value === null) return null;
       return formatCarrierFrequency(globalCarrierFrequency.value);
     });

     // Build full result object
     const result = computed((): CarrierFrequencyResult | null => {
       if (!geneSymbol.value || globalCarrierFrequency.value === null) return null;

       // Find min/max across populations
       const freqs = populations.value
         .map(p => p.carrierFrequency)
         .filter((f): f is number => f !== null);

       return {
         gene: geneSymbol.value,
         globalCarrierFrequency: globalCarrierFrequency.value,
         populations: populations.value,
         qualifyingVariantCount: qualifyingVariantCount.value,
         minFrequency: freqs.length ? Math.min(...freqs) : null,
         maxFrequency: freqs.length ? Math.max(...freqs) : null,
         hasFounderEffect: hasFounderEffect.value,
       };
     });

     // Recurrence risk calculation (CALC-02, CALC-03)
     const calculateRisk = (status: IndexPatientStatus) => {
       if (globalCarrierFrequency.value === null) return null;
       const risk = calculateRecurrenceRisk(globalCarrierFrequency.value, status);
       return {
         risk,
         percent: `${(risk * 100).toFixed(2)}%`,
         ratio: risk > 0 ? `1:${Math.round(1 / risk)}` : 'N/A',
       };
     };

     return {
       geneSymbol,
       setGeneSymbol,
       isLoading,
       hasError,
       errorMessage,
       result,
       globalFrequency,
       populations,
       qualifyingVariantCount,
       hasFounderEffect,
       usingDefault,
       calculateRisk,
       refetch,
     };
   }
   ```

2. Update src/composables/index.ts to export useCarrierFrequency
  </action>
  <verify>
Test manually by importing in App.vue:
- Set geneSymbol to "CFTR"
- Check globalFrequency shows ~4% / 1:25
- Check populations has 8 entries
- Check qualifyingVariantCount > 0
  </verify>
  <done>
- useCarrierFrequency orchestrates the full pipeline
- Filters variants using LoF HC OR ClinVar P/LP criteria
- Calculates global carrier frequency as 2 x sum(AF)
- Builds population frequencies sorted by frequency
- Detects founder effects (>5x global)
- Falls back to 1:100 when no qualifying variants (API-03)
- calculateRisk returns formatted recurrence risk
  </done>
</task>

<task type="auto">
  <name>Task 2: Create minimal test UI components</name>
  <files>
    - src/components/GeneSearch.vue
    - src/components/FrequencyResults.vue
    - src/App.vue
  </files>
  <action>
Create minimal UI to verify the calculation pipeline:

1. src/components/GeneSearch.vue:
   ```vue
   <template>
     <v-autocomplete
       v-model="model"
       v-model:search="searchInput"
       :items="items"
       :loading="loading"
       item-title="symbol"
       item-value="symbol"
       label="Gene Symbol"
       placeholder="Enter gene symbol (e.g., CFTR, BRCA1)"
       clearable
       return-object
       no-filter
       hide-no-data
       :error="!!error"
       :error-messages="error?.message"
       @update:model-value="onSelect"
     >
       <template #item="{ item, props }">
         <v-list-item v-bind="props">
           <template #title>
             <span class="font-weight-bold">{{ item.raw.symbol }}</span>
           </template>
           <template #subtitle>
             {{ item.raw.ensembl_id }}
           </template>
         </v-list-item>
       </template>
     </v-autocomplete>
   </v-template>

   <script setup lang="ts">
   import { ref, watch } from 'vue';
   import { useGeneSearch } from '@/composables';
   import type { GeneSearchResult } from '@/api/queries/types';

   const emit = defineEmits<{
     select: [gene: GeneSearchResult | null];
   }>();

   const {
     searchTerm,
     setSearchTerm,
     results,
     isLoading: loading,
     error,
     selectedGene,
     selectGene,
     clearSelection,
   } = useGeneSearch();

   const model = ref<GeneSearchResult | null>(null);
   const searchInput = ref('');

   // Sync search input to composable
   watch(searchInput, (value) => {
     if (value !== selectedGene.value?.symbol) {
       setSearchTerm(value);
     }
   });

   const items = computed(() =>
     selectedGene.value ? [selectedGene.value] : results.value
   );

   const onSelect = (gene: GeneSearchResult | null) => {
     if (gene) {
       selectGene(gene);
       emit('select', gene);
     } else {
       clearSelection();
       emit('select', null);
     }
   };
   </script>
   ```

2. src/components/FrequencyResults.vue:
   ```vue
   <template>
     <v-card v-if="result" class="mt-4">
       <v-card-title>
         {{ result.gene }} Carrier Frequency
         <v-chip v-if="usingDefault" color="warning" size="small" class="ml-2">
           Default (1:100)
         </v-chip>
       </v-card-title>

       <v-card-text>
         <!-- Global frequency -->
         <div class="text-h5 mb-4">
           Global: {{ globalFrequency?.ratio }}
           <span class="text-body-2 text-medium-emphasis">
             ({{ globalFrequency?.percent }})
           </span>
         </div>

         <!-- Qualifying variants count -->
         <div class="text-body-2 mb-4">
           Based on {{ result.qualifyingVariantCount }} qualifying variant(s)
           <span class="text-medium-emphasis">
             (LoF HC or ClinVar P/LP with >= 1 star)
           </span>
         </div>

         <!-- Founder effect alert -->
         <v-alert
           v-if="result.hasFounderEffect"
           type="info"
           variant="tonal"
           class="mb-4"
         >
           Founder effect detected: Some populations show >5x the global frequency
         </v-alert>

         <!-- Population table -->
         <v-table density="compact">
           <thead>
             <tr>
               <th>Population</th>
               <th class="text-right">Carrier Frequency</th>
               <th class="text-right">Ratio</th>
               <th>Notes</th>
             </tr>
           </thead>
           <tbody>
             <tr
               v-for="pop in result.populations"
               :key="pop.code"
               :class="{ 'bg-blue-lighten-5': pop.isFounderEffect }"
             >
               <td>{{ pop.label }}</td>
               <td class="text-right">
                 {{ pop.carrierFrequency !== null
                   ? (pop.carrierFrequency * 100).toFixed(2) + '%'
                   : 'Not detected' }}
               </td>
               <td class="text-right">
                 {{ pop.carrierFrequency !== null && pop.carrierFrequency > 0
                   ? '1:' + Math.round(1 / pop.carrierFrequency)
                   : '-' }}
               </td>
               <td>
                 <v-chip
                   v-if="pop.isFounderEffect"
                   color="info"
                   size="x-small"
                 >
                   Founder effect
                 </v-chip>
                 <v-chip
                   v-if="pop.isLowSampleSize"
                   color="warning"
                   size="x-small"
                 >
                   Low sample
                 </v-chip>
               </td>
             </tr>
           </tbody>
         </v-table>

         <!-- Bounds -->
         <div class="text-body-2 mt-4 text-medium-emphasis">
           Range across populations:
           {{ result.minFrequency !== null
             ? '1:' + Math.round(1 / result.minFrequency)
             : 'N/A' }}
           to
           {{ result.maxFrequency !== null
             ? '1:' + Math.round(1 / result.maxFrequency)
             : 'N/A' }}
         </div>
       </v-card-text>
     </v-card>

     <!-- Loading state -->
     <v-card v-else-if="loading" class="mt-4">
       <v-card-text class="text-center py-8">
         <v-progress-circular indeterminate color="primary" />
         <div class="mt-2">Loading variant data...</div>
       </v-card-text>
     </v-card>

     <!-- Error state -->
     <v-alert
       v-else-if="error"
       type="error"
       variant="tonal"
       class="mt-4"
     >
       {{ error }}
       <template #append>
         <v-btn variant="text" @click="$emit('retry')">Retry</v-btn>
       </template>
     </v-alert>
   </template>

   <script setup lang="ts">
   import type { CarrierFrequencyResult } from '@/types';

   defineProps<{
     result: CarrierFrequencyResult | null;
     globalFrequency: { percent: string; ratio: string } | null;
     usingDefault: boolean;
     loading: boolean;
     error: string | null;
   }>();

   defineEmits<{
     retry: [];
   }>();
   </script>
   ```

3. Update src/App.vue:
   ```vue
   <template>
     <v-app>
       <v-main>
         <v-container max-width="800">
           <h1 class="text-h4 mb-6">gnomAD Carrier Frequency Calculator</h1>

           <p class="text-body-1 mb-4 text-medium-emphasis">
             Enter a gene symbol to calculate carrier frequency from gnomAD population data.
           </p>

           <!-- Gene Search -->
           <GeneSearch @select="onGeneSelect" />

           <!-- Filter criteria info (FILT-04) -->
           <v-expansion-panels v-if="selectedGene" class="mt-4">
             <v-expansion-panel title="Variant Filter Criteria">
               <v-expansion-panel-text>
                 <p>Variants are included if they meet either criterion:</p>
                 <ul class="ml-4">
                   <li><strong>LoF HC:</strong> High-confidence loss-of-function (LOFTEE prediction) on canonical transcript</li>
                   <li><strong>ClinVar P/LP:</strong> Pathogenic or Likely Pathogenic classification with at least 1 review star</li>
                 </ul>
               </v-expansion-panel-text>
             </v-expansion-panel>
           </v-expansion-panels>

           <!-- Results -->
           <FrequencyResults
             :result="result"
             :global-frequency="globalFrequency"
             :using-default="usingDefault"
             :loading="isLoading"
             :error="errorMessage"
             @retry="refetch"
           />
         </v-container>
       </v-main>
     </v-app>
   </template>

   <script setup lang="ts">
   import { ref, watch } from 'vue';
   import GeneSearch from '@/components/GeneSearch.vue';
   import FrequencyResults from '@/components/FrequencyResults.vue';
   import { useCarrierFrequency } from '@/composables';
   import type { GeneSearchResult } from '@/api/queries/types';

   const {
     setGeneSymbol,
     result,
     globalFrequency,
     usingDefault,
     isLoading,
     errorMessage,
     refetch,
   } = useCarrierFrequency();

   const selectedGene = ref<GeneSearchResult | null>(null);

   const onGeneSelect = (gene: GeneSearchResult | null) => {
     selectedGene.value = gene;
     setGeneSymbol(gene?.symbol ?? null);
   };
   </script>
   ```
  </action>
  <verify>
Manual testing in browser:

1. **CFTR Test (Success case):**
   - Type "CFTR" in search
   - Select CFTR from autocomplete
   - Verify NFE population shows ~1:25 (approximately 4%)
   - Verify all 8 populations displayed
   - Verify founder effect NOT flagged for CFTR

2. **HEXA Test (Founder effect):**
   - Type "HEXA" in search
   - Select HEXA from autocomplete
   - Verify ASJ population shows elevated frequency
   - Verify founder effect IS flagged

3. **Invalid gene test:**
   - Type "NOTAREALGENE"
   - Verify error message appears
   - Verify no crash

4. **Rare gene test (default fallback):**
   - Find a gene with no pathogenic variants
   - Verify default 1:100 is shown with warning chip
  </verify>
  <done>
- GeneSearch component renders autocomplete from gnomAD
- FrequencyResults displays population table with all 8 populations
- CFTR shows ~1:25 for NFE (matches published estimate)
- Founder effect detection works (HEXA/ASJ)
- Default fallback to 1:100 shown with indicator
- Filter criteria displayed in expandable panel (FILT-04)
- Error states display clearly with retry option
- All Phase 1 requirements validated end-to-end
  </done>
</task>

</tasks>

<verification>
1. **CFTR Validation:**
   - Enter CFTR, verify NFE carrier frequency ~1:25 (4%)
   - This matches published CFTR carrier frequency for European populations

2. **HEXA Validation:**
   - Enter HEXA, verify ASJ shows elevated frequency (founder effect flagged)
   - ASJ population should show >5x global frequency

3. **Error Handling:**
   - Enter invalid gene "XYZNOTREAL"
   - Verify clear error message appears
   - Verify app doesn't crash

4. **API Fallback:**
   - If a gene has no qualifying variants, 1:100 default shown
   - Warning chip indicates using default assumption

5. **All 8 Populations:**
   - Table shows afr, amr, asj, eas, fin, mid, nfe, sas
   - Sorted by frequency (highest first)
   - Low sample size flagged where applicable
</verification>

<success_criteria>
Phase 1 complete when:
- GENE-01: Autocomplete suggestions appear after 2+ characters
- GENE-02: Gene validated against gnomAD (only valid genes proceed)
- GENE-03: Invalid gene shows clear error
- API-01: gnomAD GraphQL queries execute successfully
- API-02: Errors handled gracefully with retry option
- API-03: No qualifying variants falls back to 1:100
- FILT-01: LoF HC variants included
- FILT-02: ClinVar P/LP variants included
- FILT-03: ClinVar requires >= 1 star
- FILT-04: Filter criteria documented in UI
- CALC-01: Carrier frequency = 2 x sum(AF) implemented
- CALC-02: Heterozygous recurrence risk = carrier_freq / 4
- CALC-03: Compound het/hom recurrence risk = carrier_freq / 2
- CALC-04: Results show both % and ratio formats
- POP-01: Global frequency displayed as primary result
- POP-02: All 8 gnomAD populations displayed
- POP-03: Min/max bounds shown
- POP-04: Founder effect flagged when >5x global

**Key validation:** CFTR carrier frequency ~1:25 for NFE population
</success_criteria>

<output>
After completion, create `.planning/phases/01-foundation/01-04-SUMMARY.md`
</output>
