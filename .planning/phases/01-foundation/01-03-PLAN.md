---
phase: 01-foundation
plan: 03
type: execute
wave: 2
depends_on: ["01-01", "01-02"]
files_modified:
  - src/api/queries/gene-search.ts
  - src/api/queries/gene-variants.ts
  - src/api/queries/types.ts
  - src/api/queries/index.ts
  - src/composables/useGeneSearch.ts
  - src/composables/useGeneVariants.ts
  - src/composables/index.ts
autonomous: true

must_haves:
  truths:
    - "User can enter gene symbol and see autocomplete suggestions from gnomAD"
    - "Gene symbol is validated against gnomAD before proceeding"
    - "Invalid gene shows clear error message"
    - "App queries gnomAD GraphQL API for gene variants"
    - "API errors show user-friendly feedback"
  artifacts:
    - path: "src/api/queries/gene-search.ts"
      provides: "GraphQL query for gene autocomplete"
      exports: ["GENE_SEARCH_QUERY"]
    - path: "src/api/queries/gene-variants.ts"
      provides: "GraphQL query for gene variants with populations and ClinVar"
      exports: ["GENE_VARIANTS_QUERY"]
    - path: "src/composables/useGeneSearch.ts"
      provides: "Reactive gene search with debounced autocomplete"
      exports: ["useGeneSearch"]
    - path: "src/composables/useGeneVariants.ts"
      provides: "Reactive variant fetching with error handling"
      exports: ["useGeneVariants"]
  key_links:
    - from: "src/composables/useGeneSearch.ts"
      to: "gnomAD API"
      via: "villus useQuery"
      pattern: "useQuery.*GENE_SEARCH_QUERY"
    - from: "src/composables/useGeneVariants.ts"
      to: "gnomAD API"
      via: "villus useQuery"
      pattern: "useQuery.*GENE_VARIANTS_QUERY"
---

<objective>
Create GraphQL queries and Vue composables for gene search autocomplete and variant data fetching from gnomAD API.

Purpose: Implement the API layer that retrieves gene and variant data, enabling gene validation (GENE-01, GENE-02, GENE-03), API integration (API-01, API-02), and data retrieval for filtering.
Output: Reactive composables that provide debounced gene search and variant data with proper error handling.
</objective>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/phases/01-foundation/01-RESEARCH.md
@.planning/phases/01-foundation/01-01-SUMMARY.md
@.planning/phases/01-foundation/01-02-SUMMARY.md
</context>

<tasks>

<task type="auto">
  <name>Task 1: Create GraphQL query definitions</name>
  <files>
    - src/api/queries/gene-search.ts
    - src/api/queries/gene-variants.ts
    - src/api/queries/types.ts
    - src/api/queries/index.ts
  </files>
  <action>
Create GraphQL queries based on research findings:

1. src/api/queries/types.ts:
   ```typescript
   // Response types for gnomAD GraphQL queries

   export interface GeneSearchResult {
     ensembl_id: string;
     symbol: string;
   }

   export interface GeneSearchResponse {
     gene_search: GeneSearchResult[];
   }

   export interface GeneVariantPopulation {
     id: string;
     ac: number;
     an: number;
   }

   export interface GeneVariantExomeGenome {
     ac: number;
     an: number;
     populations: GeneVariantPopulation[];
   }

   export interface GeneVariantTranscript {
     gene_symbol: string;
     transcript_id: string;
     canonical: boolean;
     consequence_terms: string[];
     lof: string | null;
     lof_filter: string | null;
     lof_flags: string | null;
   }

   export interface GeneVariant {
     variant_id: string;
     pos: number;
     ref: string;
     alt: string;
     exome: GeneVariantExomeGenome | null;
     genome: GeneVariantExomeGenome | null;
     transcript_consequences: GeneVariantTranscript[];
   }

   export interface GeneClinvarVariant {
     variant_id: string;
     clinical_significance: string;
     gold_stars: number;
     review_status: string;
     pos: number;
     ref: string;
     alt: string;
   }

   export interface GeneData {
     gene_id: string;
     symbol: string;
     variants: GeneVariant[];
     clinvar_variants: GeneClinvarVariant[];
   }

   export interface GeneVariantsResponse {
     gene: GeneData | null;
   }
   ```

2. src/api/queries/gene-search.ts:
   ```typescript
   export const GENE_SEARCH_QUERY = `
     query GeneSearch($query: String!, $referenceGenome: ReferenceGenomeId!) {
       gene_search(query: $query, reference_genome: $referenceGenome) {
         ensembl_id
         symbol
       }
     }
   `;

   export interface GeneSearchVariables {
     query: string;
     referenceGenome: 'GRCh37' | 'GRCh38';
   }
   ```

3. src/api/queries/gene-variants.ts:
   ```typescript
   // Query gene variants with population frequencies and ClinVar data
   // Note: Population AF must be calculated from ac/an (not directly available)
   export const GENE_VARIANTS_QUERY = `
     query GeneVariants($geneSymbol: String!, $dataset: DatasetId!) {
       gene(gene_symbol: $geneSymbol, reference_genome: GRCh38) {
         gene_id
         symbol
         variants(dataset: $dataset) {
           variant_id
           pos
           ref
           alt
           exome {
             ac
             an
             populations {
               id
               ac
               an
             }
           }
           genome {
             ac
             an
             populations {
               id
               ac
               an
             }
           }
           transcript_consequences {
             gene_symbol
             transcript_id
             canonical
             consequence_terms
             lof
             lof_filter
             lof_flags
           }
         }
         clinvar_variants {
           variant_id
           clinical_significance
           gold_stars
           review_status
           pos
           ref
           alt
         }
       }
     }
   `;

   export interface GeneVariantsVariables {
     geneSymbol: string;
     dataset: 'gnomad_r4';
   }
   ```

4. src/api/queries/index.ts:
   - Re-export all queries and types
  </action>
  <verify>
- TypeScript compiler accepts all query files
- Query strings match gnomAD GraphQL schema (reference: research doc)
- All response types defined
  </verify>
  <done>
- GENE_SEARCH_QUERY exported and typed
- GENE_VARIANTS_QUERY exported with population ac/an fields
- Response types match gnomAD API structure
- Query variables properly typed
  </done>
</task>

<task type="auto">
  <name>Task 2: Create gene search composable</name>
  <files>
    - src/composables/useGeneSearch.ts
    - src/composables/index.ts
  </files>
  <action>
Create reactive gene search with debounced autocomplete:

1. src/composables/useGeneSearch.ts:
   ```typescript
   import { computed, ref, type Ref } from 'vue';
   import { useQuery } from 'villus';
   import { useDebounceFn } from '@vueuse/core';
   import { GENE_SEARCH_QUERY } from '@/api/queries/gene-search';
   import type { GeneSearchResponse, GeneSearchResult } from '@/api/queries/types';

   export interface UseGeneSearchOptions {
     minChars?: number;      // Minimum characters before searching (default: 2)
     debounceMs?: number;    // Debounce delay (default: 300)
   }

   export interface UseGeneSearchReturn {
     searchTerm: Ref<string>;
     setSearchTerm: (term: string) => void;
     results: Ref<GeneSearchResult[]>;
     isLoading: Ref<boolean>;
     error: Ref<Error | null>;
     selectedGene: Ref<GeneSearchResult | null>;
     selectGene: (gene: GeneSearchResult) => void;
     clearSelection: () => void;
     isValidGene: Ref<boolean>;
   }

   export function useGeneSearch(options: UseGeneSearchOptions = {}): UseGeneSearchReturn {
     const { minChars = 2, debounceMs = 300 } = options;

     const searchTerm = ref('');
     const debouncedTerm = ref('');
     const selectedGene = ref<GeneSearchResult | null>(null);

     // Debounce search term updates
     const setSearchTerm = useDebounceFn((term: string) => {
       // Normalize to uppercase for gnomAD (GENE-02: case-insensitive)
       debouncedTerm.value = term.trim().toUpperCase();
     }, debounceMs);

     // Watch raw input and trigger debounced update
     const updateSearchTerm = (term: string) => {
       searchTerm.value = term;
       // Clear selection when user types
       if (selectedGene.value && term.toUpperCase() !== selectedGene.value.symbol) {
         selectedGene.value = null;
       }
       setSearchTerm(term);
     };

     const variables = computed(() => ({
       query: debouncedTerm.value,
       referenceGenome: 'GRCh38' as const,
     }));

     const { data, isFetching, error } = useQuery<GeneSearchResponse>({
       query: GENE_SEARCH_QUERY,
       variables,
       skip: () => debouncedTerm.value.length < minChars || selectedGene.value !== null,
     });

     const results = computed(() => data.value?.gene_search ?? []);

     const selectGene = (gene: GeneSearchResult) => {
       selectedGene.value = gene;
       searchTerm.value = gene.symbol;
       debouncedTerm.value = ''; // Stop searching
     };

     const clearSelection = () => {
       selectedGene.value = null;
       searchTerm.value = '';
       debouncedTerm.value = '';
     };

     const isValidGene = computed(() => selectedGene.value !== null);

     return {
       searchTerm,
       setSearchTerm: updateSearchTerm,
       results,
       isLoading: isFetching,
       error: computed(() => error.value ?? null),
       selectedGene,
       selectGene,
       clearSelection,
       isValidGene,
     };
   }
   ```

2. src/composables/index.ts:
   ```typescript
   export { useGeneSearch } from './useGeneSearch';
   export type { UseGeneSearchOptions, UseGeneSearchReturn } from './useGeneSearch';
   ```
  </action>
  <verify>
Test in browser with App.vue:
- Type "CFT" - should see CFTR in autocomplete after debounce
- Type "BRCA" - should see BRCA1, BRCA2
- Select gene - results should clear, selectedGene should be set
- Type invalid gene "NOTREAL" - results should be empty
  </verify>
  <done>
- useGeneSearch exported with proper types
- Debounced search prevents API spam (300ms default)
- Case-insensitive input (normalized to uppercase)
- Minimum 2 characters before searching
- Gene selection tracked separately from search
- isValidGene computed for form validation
  </done>
</task>

<task type="auto">
  <name>Task 3: Create gene variants composable</name>
  <files>
    - src/composables/useGeneVariants.ts
    - src/composables/index.ts (update)
  </files>
  <action>
Create reactive variant fetching with error handling:

1. src/composables/useGeneVariants.ts:
   ```typescript
   import { computed, type Ref, watch } from 'vue';
   import { useQuery } from 'villus';
   import { GENE_VARIANTS_QUERY } from '@/api/queries/gene-variants';
   import type {
     GeneVariantsResponse,
     GeneVariant,
     GeneClinvarVariant,
   } from '@/api/queries/types';

   export interface UseGeneVariantsReturn {
     gene: Ref<GeneVariantsResponse['gene']>;
     variants: Ref<GeneVariant[]>;
     clinvarVariants: Ref<GeneClinvarVariant[]>;
     isLoading: Ref<boolean>;
     hasError: Ref<boolean>;
     errorMessage: Ref<string | null>;
     refetch: () => Promise<void>;
     hasData: Ref<boolean>;
   }

   export function useGeneVariants(geneSymbol: Ref<string | null>): UseGeneVariantsReturn {
     const variables = computed(() => ({
       geneSymbol: geneSymbol.value?.toUpperCase() ?? '',
       dataset: 'gnomad_r4' as const,
     }));

     const { data, isFetching, error, execute } = useQuery<GeneVariantsResponse>({
       query: GENE_VARIANTS_QUERY,
       variables,
       skip: () => !geneSymbol.value,
       cachePolicy: 'cache-first',
     });

     const gene = computed(() => data.value?.gene ?? null);
     const variants = computed(() => gene.value?.variants ?? []);
     const clinvarVariants = computed(() => gene.value?.clinvar_variants ?? []);
     const hasData = computed(() => gene.value !== null);

     const hasError = computed(() => !!error.value || (data.value !== undefined && gene.value === null && !isFetching.value));

     const errorMessage = computed(() => {
       if (error.value) {
         const msg = error.value.message;
         // GENE-03: Invalid gene shows clear error message
         if (msg.includes('not found') || msg.includes('does not exist')) {
           return `Gene "${geneSymbol.value}" not found in gnomAD. Please check the gene symbol.`;
         }
         // API-02: Handle API errors gracefully
         if (msg.includes('timeout') || msg.includes('network')) {
           return 'Network error. Please check your connection and try again.';
         }
         return 'Failed to load variant data. Please try again.';
       }
       // Gene exists in search but has no data
       if (data.value !== undefined && gene.value === null && geneSymbol.value) {
         return `Gene "${geneSymbol.value}" not found in gnomAD database.`;
       }
       return null;
     });

     const refetch = async () => {
       await execute();
     };

     return {
       gene,
       variants,
       clinvarVariants,
       isLoading: isFetching,
       hasError,
       errorMessage,
       refetch,
       hasData,
     };
   }
   ```

2. Update src/composables/index.ts:
   ```typescript
   export { useGeneSearch } from './useGeneSearch';
   export type { UseGeneSearchOptions, UseGeneSearchReturn } from './useGeneSearch';

   export { useGeneVariants } from './useGeneVariants';
   export type { UseGeneVariantsReturn } from './useGeneVariants';
   ```
  </action>
  <verify>
Test in browser:
- Select CFTR from search - should fetch variants
- Check that variants array has items
- Check that clinvarVariants array has items
- Test error handling with invalid gene
  </verify>
  <done>
- useGeneVariants exported with proper types
- Fetches variants only when geneSymbol is provided
- Cache-first policy for performance
- Clear error messages for:
  - Gene not found (GENE-03)
  - Network errors (API-02)
  - General failures
- refetch function for retry capability
- hasData computed for conditional rendering
  </done>
</task>

</tasks>

<verification>
1. TypeScript compiles without errors
2. Gene search with "CFTR" returns results from gnomAD
3. Gene search with "NOTREAL" returns empty results
4. Selecting CFTR triggers variant fetch
5. Variant response includes variants and clinvar_variants arrays
6. Error states display user-friendly messages
7. Debounce prevents rapid API calls (check network tab)
</verification>

<success_criteria>
- GENE-01: Autocomplete suggestions appear after 2+ characters
- GENE-02: Gene validated against gnomAD API
- GENE-03: Invalid gene shows clear error message
- API-01: App successfully queries gnomAD GraphQL
- API-02: Errors handled with user feedback
- Debounce prevents rate limiting issues
- Case-insensitive input (cftr, CFTR, Cftr all work)
</success_criteria>

<output>
After completion, create `.planning/phases/01-foundation/01-03-SUMMARY.md`
</output>
