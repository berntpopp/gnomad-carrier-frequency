---
phase: 01-foundation
plan: 01
type: execute
wave: 1
depends_on: []
files_modified:
  - src/config/gnomad.json
  - src/config/settings.json
  - src/config/index.ts
  - src/config/types.ts
autonomous: true

must_haves:
  truths:
    - "All gnomAD API endpoints defined in config, not inline strings"
    - "All population codes and labels per version in config"
    - "All thresholds (founder effect 5x, debounce 300ms, etc.) in config"
    - "Config is type-safe with full TypeScript support"
    - "Default version is v4, with v3 and v2 available"
  artifacts:
    - path: "src/config/gnomad.json"
      provides: "gnomAD API configuration per version"
      contains: "gnomad_r4"
    - path: "src/config/settings.json"
      provides: "Application settings and thresholds"
      contains: "founderEffectMultiplier"
    - path: "src/config/index.ts"
      provides: "Type-safe config loader"
      exports: ["config", "getGnomadVersion", "getPopulations"]
    - path: "src/config/types.ts"
      provides: "TypeScript types for config"
      exports: ["GnomadVersion", "GnomadConfig", "AppSettings"]
  key_links:
    - from: "src/config/index.ts"
      to: "src/config/gnomad.json"
      via: "JSON import"
      pattern: "import.*gnomad\\.json"
    - from: "src/config/index.ts"
      to: "src/config/types.ts"
      via: "type imports"
      pattern: "import.*GnomadConfig"
---

<objective>
Create a centralized configuration system for all application settings, gnomAD API endpoints, and version-specific data.

Purpose: Eliminate all hardcoded values from the codebase. Every magic number, string, API endpoint, and population code lives in config files. This enables easy updates, version switching, and maintains SOLID/DRY principles.
Output: Type-safe config module that all other modules import from.
</objective>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/phases/01-foundation/01-RESEARCH.md
@.planning/phases/01-foundation/01-CONTEXT.md
</context>

<tasks>

<task type="auto">
  <name>Task 1: Create gnomAD version configuration</name>
  <files>
    - src/config/gnomad.json
    - src/config/types.ts
  </files>
  <action>
Create the gnomAD API configuration with multi-version support:

1. src/config/types.ts:
   ```typescript
   // gnomAD version identifiers
   export type GnomadVersion = 'v4' | 'v3' | 'v2';

   // Population code varies by version
   export interface PopulationConfig {
     code: string;
     label: string;
     description?: string;
   }

   // Version-specific gnomAD configuration
   export interface GnomadVersionConfig {
     version: GnomadVersion;
     displayName: string;
     apiEndpoint: string;
     datasetId: string;
     referenceGenome: 'GRCh38' | 'GRCh37';
     populations: PopulationConfig[];
     notes?: string;
   }

   // Full gnomAD configuration
   export interface GnomadConfig {
     defaultVersion: GnomadVersion;
     versions: Record<GnomadVersion, GnomadVersionConfig>;
   }

   // Application settings (non-gnomAD specific)
   export interface AppSettings {
     // Calculation thresholds
     founderEffectMultiplier: number;      // Population > Nx global = founder effect
     lowSampleSizeThreshold: number;       // AN below this = low sample warning
     defaultCarrierFrequency: number;      // Fallback when no qualifying variants (1/100)

     // UI behavior
     debounceMs: number;                   // Autocomplete debounce delay
     minSearchChars: number;               // Min chars before autocomplete triggers
     maxAutocompleteResults: number;       // Limit suggestions shown

     // Display
     frequencyDecimalPlaces: number;       // Decimal places for percentage display
   }

   // Combined config type
   export interface Config {
     gnomad: GnomadConfig;
     settings: AppSettings;
   }
   ```

2. src/config/gnomad.json:
   ```json
   {
     "defaultVersion": "v4",
     "versions": {
       "v4": {
         "version": "v4",
         "displayName": "gnomAD v4.1",
         "apiEndpoint": "https://gnomad.broadinstitute.org/api",
         "datasetId": "gnomad_r4",
         "referenceGenome": "GRCh38",
         "populations": [
           { "code": "afr", "label": "African/African-American", "description": "African and African-American ancestry" },
           { "code": "amr", "label": "Admixed American", "description": "Latino/Admixed American ancestry" },
           { "code": "asj", "label": "Ashkenazi Jewish", "description": "Ashkenazi Jewish ancestry" },
           { "code": "eas", "label": "East Asian", "description": "East Asian ancestry" },
           { "code": "fin", "label": "Finnish", "description": "Finnish ancestry (separated from NFE)" },
           { "code": "mid", "label": "Middle Eastern", "description": "Middle Eastern ancestry" },
           { "code": "nfe", "label": "Non-Finnish European", "description": "European ancestry (non-Finnish)" },
           { "code": "sas", "label": "South Asian", "description": "South Asian ancestry" }
         ],
         "notes": "v4.1 released Nov 2023, largest dataset with 807,162 samples"
       },
       "v3": {
         "version": "v3",
         "displayName": "gnomAD v3.1.2",
         "apiEndpoint": "https://gnomad.broadinstitute.org/api",
         "datasetId": "gnomad_r3",
         "referenceGenome": "GRCh38",
         "populations": [
           { "code": "afr", "label": "African/African-American" },
           { "code": "ami", "label": "Amish", "description": "Amish ancestry" },
           { "code": "amr", "label": "Admixed American" },
           { "code": "asj", "label": "Ashkenazi Jewish" },
           { "code": "eas", "label": "East Asian" },
           { "code": "fin", "label": "Finnish" },
           { "code": "nfe", "label": "Non-Finnish European" },
           { "code": "sas", "label": "South Asian" }
         ],
         "notes": "v3 is genome-only (no exomes), includes Amish population"
       },
       "v2": {
         "version": "v2",
         "displayName": "gnomAD v2.1.1",
         "apiEndpoint": "https://gnomad.broadinstitute.org/api",
         "datasetId": "gnomad_r2_1",
         "referenceGenome": "GRCh37",
         "populations": [
           { "code": "afr", "label": "African/African-American" },
           { "code": "amr", "label": "Admixed American" },
           { "code": "asj", "label": "Ashkenazi Jewish" },
           { "code": "eas", "label": "East Asian" },
           { "code": "fin", "label": "Finnish" },
           { "code": "nfe", "label": "Non-Finnish European" },
           { "code": "oth", "label": "Other", "description": "Other/unknown ancestry" },
           { "code": "sas", "label": "South Asian" }
         ],
         "notes": "v2 uses GRCh37, includes 'oth' instead of 'mid'"
       }
     }
   }
   ```
  </action>
  <verify>
- TypeScript compiler accepts types: `bunx tsc --noEmit src/config/types.ts`
- JSON is valid: `cat src/config/gnomad.json | jq .`
- All three versions defined with correct population codes
  </verify>
  <done>
- GnomadVersion type is union of 'v4' | 'v3' | 'v2'
- Each version has apiEndpoint, datasetId, referenceGenome, populations
- Population codes differ per version (v4 has 'mid', v2 has 'oth', v3 has 'ami')
- Default version is v4
  </done>
</task>

<task type="auto">
  <name>Task 2: Create settings configuration and type-safe loader</name>
  <files>
    - src/config/settings.json
    - src/config/index.ts
  </files>
  <action>
Create application settings and the unified config loader:

1. src/config/settings.json:
   ```json
   {
     "founderEffectMultiplier": 5,
     "lowSampleSizeThreshold": 1000,
     "defaultCarrierFrequency": 0.01,
     "debounceMs": 300,
     "minSearchChars": 2,
     "maxAutocompleteResults": 10,
     "frequencyDecimalPlaces": 2
   }
   ```

2. src/config/index.ts:
   ```typescript
   // Type-safe configuration loader
   // All magic numbers and strings come from here - NO HARDCODING elsewhere

   import type {
     Config,
     GnomadConfig,
     GnomadVersion,
     GnomadVersionConfig,
     AppSettings,
     PopulationConfig,
   } from './types';

   import gnomadConfig from './gnomad.json';
   import settingsConfig from './settings.json';

   // Type assertion - JSON imports are validated at build time
   const gnomad = gnomadConfig as GnomadConfig;
   const settings = settingsConfig as AppSettings;

   // Unified config object
   export const config: Config = {
     gnomad,
     settings,
   };

   // Helper: Get version config (defaults to configured default)
   export function getGnomadVersion(version?: GnomadVersion): GnomadVersionConfig {
     const v = version ?? gnomad.defaultVersion;
     return gnomad.versions[v];
   }

   // Helper: Get population codes for a version
   export function getPopulationCodes(version?: GnomadVersion): string[] {
     return getGnomadVersion(version).populations.map(p => p.code);
   }

   // Helper: Get population label by code
   export function getPopulationLabel(code: string, version?: GnomadVersion): string {
     const pop = getGnomadVersion(version).populations.find(p => p.code === code);
     return pop?.label ?? code;
   }

   // Helper: Get all populations for a version
   export function getPopulations(version?: GnomadVersion): PopulationConfig[] {
     return getGnomadVersion(version).populations;
   }

   // Helper: Build population labels map for a version
   export function getPopulationLabels(version?: GnomadVersion): Record<string, string> {
     const pops = getPopulations(version);
     return Object.fromEntries(pops.map(p => [p.code, p.label]));
   }

   // Helper: Get API endpoint for a version
   export function getApiEndpoint(version?: GnomadVersion): string {
     return getGnomadVersion(version).apiEndpoint;
   }

   // Helper: Get dataset ID for a version
   export function getDatasetId(version?: GnomadVersion): string {
     return getGnomadVersion(version).datasetId;
   }

   // Helper: Get reference genome for a version
   export function getReferenceGenome(version?: GnomadVersion): 'GRCh38' | 'GRCh37' {
     return getGnomadVersion(version).referenceGenome;
   }

   // Helper: Get available versions
   export function getAvailableVersions(): GnomadVersion[] {
     return Object.keys(gnomad.versions) as GnomadVersion[];
   }

   // Re-export types for convenience
   export type {
     Config,
     GnomadConfig,
     GnomadVersion,
     GnomadVersionConfig,
     AppSettings,
     PopulationConfig,
   } from './types';
   ```
  </action>
  <verify>
- TypeScript compiles: `bunx tsc --noEmit src/config/index.ts`
- Exports work: import { config, getGnomadVersion } from '@/config' should resolve
- getGnomadVersion() returns v4 config by default
- getGnomadVersion('v2') returns v2 config with GRCh37
- getPopulationCodes('v4') returns 8 codes including 'mid'
- getPopulationCodes('v2') returns 8 codes including 'oth' (not 'mid')
  </verify>
  <done>
- settings.json contains all thresholds and UI settings
- config/index.ts exports unified config object
- Helper functions provide type-safe access to version-specific data
- No hardcoded values anywhere - all come from JSON config files
- Easy to add new versions or modify thresholds
  </done>
</task>

</tasks>

<verification>
1. TypeScript compiles without errors
2. `config.settings.founderEffectMultiplier` returns 5
3. `config.settings.debounceMs` returns 300
4. `getGnomadVersion()` returns v4 config
5. `getGnomadVersion('v2').referenceGenome` returns 'GRCh37'
6. `getPopulationCodes('v4')` includes 'mid'
7. `getPopulationCodes('v2')` includes 'oth' (not 'mid')
8. All 3 gnomAD versions accessible and type-safe
</verification>

<success_criteria>
- Zero hardcoded API endpoints in codebase
- Zero hardcoded population codes in codebase
- Zero magic numbers (thresholds, timings) in codebase
- Type-safe config access with IDE autocomplete
- Multi-version gnomAD support (v4 default, v3/v2 available)
- Single source of truth for all configuration
</success_criteria>

<output>
After completion, create `.planning/phases/01-foundation/01-01-SUMMARY.md`
</output>
