---
phase: 11-url-state-sharing
plan: 01
type: execute
wave: 1
depends_on: []
files_modified:
  - package.json
  - bun.lockb
  - src/types/url-state.ts
  - src/types/index.ts
  - src/composables/useUrlState.ts
  - src/composables/index.ts
  - src/App.vue
autonomous: true

must_haves:
  truths:
    - "URL contains gene symbol when gene is selected"
    - "URL contains wizard step as user progresses"
    - "URL contains filter flags when non-default"
    - "Opening URL with gene parameter triggers gene search and selection"
    - "Opening URL with invalid parameters uses defaults without crashing"
    - "URL updates without creating browser history entries"
  artifacts:
    - path: "src/types/url-state.ts"
      provides: "Zod schema for URL parameter validation"
      exports: ["UrlStateSchema", "UrlState", "parseUrlState"]
    - path: "src/composables/useUrlState.ts"
      provides: "URL state synchronization composable"
      exports: ["useUrlState"]
  key_links:
    - from: "src/composables/useUrlState.ts"
      to: "src/composables/useWizard.ts"
      via: "reads/writes wizard singleton state"
      pattern: "state\\.(gene|currentStep|indexStatus)"
    - from: "src/composables/useUrlState.ts"
      to: "src/stores/useFilterStore.ts"
      via: "reads filter defaults for comparison"
      pattern: "useFilterStore"
    - from: "src/App.vue"
      to: "src/composables/useUrlState.ts"
      via: "initializes URL state sync on mount"
      pattern: "useUrlState"
---

<objective>
Implement URL state infrastructure that synchronizes wizard state to URL query parameters and restores state from URL on page load.

Purpose: Enable shareable URLs that reproduce exact calculation parameters (URL-01, URL-02, URL-03, URL-05, URL-06)
Output: Working URL state composable that syncs wizard state bidirectionally with URL
</objective>

<execution_context>
@~/.claude/get-shit-done/workflows/execute-plan.md
@~/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/11-url-state-sharing/11-RESEARCH.md

@src/composables/useWizard.ts
@src/types/wizard.ts
@src/types/filter.ts
@src/stores/useFilterStore.ts
@src/composables/useGeneSearch.ts
</context>

<tasks>

<task type="auto">
  <name>Task 1: Add Zod dependency and create URL state types</name>
  <files>
    package.json
    bun.lockb
    src/types/url-state.ts
    src/types/index.ts
  </files>
  <action>
1. Install Zod for URL parameter validation:
   ```bash
   bun add zod
   ```

2. Create `src/types/url-state.ts` with Zod schema:
   - Define `UrlStateSchema` with these fields:
     - `gene`: z.string().min(1).max(50).optional() - gene symbol
     - `step`: z.coerce.number().int().min(1).max(4).optional().default(1) - wizard step
     - `status`: z.enum(['heterozygous', 'homozygous']).optional().default('heterozygous') - index status
     - `source`: z.enum(['gnomad', 'literature', 'default']).optional().default('gnomad') - frequency source
     - `litFreq`: z.coerce.number().min(0).max(1).optional() - literature frequency (only if source=literature)
     - `litPmid`: z.string().optional() - literature PMID
     - `filters`: z.string().regex(/^(l?m?c?|none)$/).optional() - compact filter flags (l=lof, m=missense, c=clinvar)
     - `clinvarStars`: z.coerce.number().int().min(0).max(4).optional() - ClinVar star threshold
     - `conflicting`: z.enum(['0', '1']).optional() - include conflicting classifications
     - `conflictThreshold`: z.coerce.number().int().min(50).max(100).optional() - conflicting threshold
   - Export `UrlState` type via `z.infer<typeof UrlStateSchema>`
   - Export `parseUrlState(params: Record<string, unknown>): UrlState` function that:
     - Uses `safeParse` for graceful validation
     - Logs warning on validation failure (using console.warn)
     - Returns defaults on failure via `UrlStateSchema.parse({})`
   - Export helper functions:
     - `encodeFilterFlags(config: FilterConfig): string` - converts filter config to compact string
     - `decodeFilterFlags(flags: string): Partial<FilterConfig>` - converts string back to filter config

3. Update `src/types/index.ts` to export from url-state.ts:
   ```typescript
   export * from './url-state';
   ```
  </action>
  <verify>
    - `bun run typecheck` passes
    - `src/types/url-state.ts` exports UrlStateSchema, UrlState, parseUrlState, encodeFilterFlags, decodeFilterFlags
  </verify>
  <done>
    Zod installed, URL state types and validation schema created with compact filter encoding
  </done>
</task>

<task type="auto">
  <name>Task 2: Create useUrlState composable</name>
  <files>
    src/composables/useUrlState.ts
    src/composables/index.ts
  </files>
  <action>
1. Create `src/composables/useUrlState.ts`:

   Import dependencies:
   - `useUrlSearchParams` from '@vueuse/core'
   - `watch`, `ref`, `onMounted` from 'vue'
   - `parseUrlState`, `encodeFilterFlags`, `decodeFilterFlags` from '@/types'
   - `FACTORY_FILTER_DEFAULTS` from '@/types'
   - `useWizard` from './useWizard'
   - `useFilterStore` from '@/stores/useFilterStore'
   - `useGeneSearch` from './useGeneSearch'

2. Create module-level singleton state:
   ```typescript
   const isInitialized = ref(false)
   const isRestoringFromUrl = ref(false)
   ```

3. Implement `useUrlState()` composable:

   a) Initialize URL params with VueUse:
      ```typescript
      const params = useUrlSearchParams('history', {
        write: true,
        writeMode: 'replace', // Don't create history entries
        removeNullishValues: true,
      })
      ```

   b) Get references to wizard state and filter store:
      - `const { state: wizardState } = useWizard()`
      - `const filterStore = useFilterStore()`
      - `const geneSearch = useGeneSearch()`

   c) Create `restoreFromUrl()` async function:
      - Parse URL params with `parseUrlState(params)`
      - If `gene` present in URL:
        - Use `geneSearch.setSearchTerm(gene)` to trigger search
        - Wait for search results (use watch or nextTick)
        - Find matching gene in results and call `geneSearch.selectGene()`
        - Set `wizardState.gene = selectedGene`
      - Restore wizard state: step, status, source, litFreq, litPmid
      - Restore filter state if `filters` param present:
        - Decode flags and apply to filterStore via `setDefaults()`
        - Apply clinvarStars, conflicting, conflictThreshold if present

   d) Create `updateUrlFromState()` function:
      - Skip if `isRestoringFromUrl.value` is true
      - Build params object from current state:
        - `params.gene = wizardState.gene?.symbol ?? null`
        - `params.step = wizardState.currentStep.toString()`
        - Only include non-default values to keep URLs clean:
          - `params.status` only if not 'heterozygous'
          - `params.source` only if not 'gnomad'
          - `params.litFreq` and `params.litPmid` only if source is 'literature'
          - `params.filters` only if differs from factory defaults
          - `params.clinvarStars` only if differs from factory default (1)
          - `params.conflicting` only if enabled
          - `params.conflictThreshold` only if conflicting enabled and differs from default (80)

   e) Set up watchers to update URL when state changes:
      - Watch `wizardState` (deep) and call `updateUrlFromState()`
      - Watch `filterStore.defaults` (deep) and call `updateUrlFromState()`

   f) On mount, restore from URL if params present:
      ```typescript
      onMounted(async () => {
        if (isInitialized.value) return

        const hasUrlState = ['gene', 'step', 'status', 'source'].some(
          k => params[k] !== undefined && params[k] !== null
        )

        if (hasUrlState) {
          isRestoringFromUrl.value = true
          await restoreFromUrl()
          isRestoringFromUrl.value = false
        }

        isInitialized.value = true
      })
      ```

   g) Export:
      ```typescript
      return {
        isInitialized,
        getShareableUrl: () => window.location.href,
      }
      ```

4. Update `src/composables/index.ts` to export useUrlState:
   ```typescript
   export { useUrlState } from './useUrlState';
   ```
  </action>
  <verify>
    - `bun run typecheck` passes
    - `bun run lint` passes
    - Manual test: Add `?gene=CFTR` to URL, refresh page, verify gene search triggers
  </verify>
  <done>
    useUrlState composable created with bidirectional URL sync, graceful restoration, and compact filter encoding
  </done>
</task>

<task type="auto">
  <name>Task 3: Integrate URL state into App.vue</name>
  <files>
    src/App.vue
  </files>
  <action>
1. Read current `src/App.vue` to understand existing structure.

2. Import and initialize `useUrlState`:
   - Add import: `import { useUrlState } from '@/composables'`
   - Call `useUrlState()` in setup to initialize URL state synchronization
   - The composable handles everything internally via onMounted

3. The composable's `onMounted` hook will:
   - Check URL for state parameters
   - Restore state if present
   - Start watching for state changes to update URL

4. No template changes needed - this is infrastructure only.
  </action>
  <verify>
    - `bun run build` succeeds
    - `bun run dev` starts without errors
    - Test URL restoration:
      1. Navigate to `http://localhost:5173/gnomad-carrier-frequency/?gene=CFTR`
      2. Verify gene search triggers and CFTR is selected
      3. Proceed through wizard steps
      4. Verify URL updates with step parameter
    - Test invalid URL:
      1. Navigate to `http://localhost:5173/gnomad-carrier-frequency/?gene=INVALID123&step=99`
      2. Verify app loads without crash
      3. Verify defaults are used
  </verify>
  <done>
    URL state integration complete - app initializes from URL and updates URL as state changes
  </done>
</task>

</tasks>

<verification>
1. **Build verification:**
   - `bun run typecheck` passes
   - `bun run lint` passes
   - `bun run build` succeeds

2. **URL encoding verification:**
   - Select gene CFTR, verify URL contains `?gene=CFTR`
   - Progress to step 2, verify URL contains `&step=2`
   - Change filters from defaults, verify `filters` param appears
   - Use literature frequency, verify `litFreq` and `litPmid` params appear

3. **URL restoration verification:**
   - Copy URL at step 3 with custom filters
   - Open in new tab/incognito
   - Verify gene is restored, step is correct, filters match

4. **Graceful degradation:**
   - Test malformed URL: `?step=invalid&clinvarStars=99`
   - Verify app loads with defaults, no console errors (only warnings)

5. **History behavior:**
   - Navigate through wizard steps
   - Use browser back button
   - Verify back button navigates away from app (not through wizard history)
</verification>

<success_criteria>
- URL contains gene symbol when gene selected (URL-01)
- URL contains wizard step as user progresses (URL-03)
- URL contains filter settings when non-default (URL-01)
- Opening URL with valid params restores complete state (URL-02)
- Opening URL with invalid params uses defaults without crash (URL-06)
- URL updates use replaceState (no history pollution)
- Shared URLs work in new browser sessions (URL-05)
</success_criteria>

<output>
After completion, create `.planning/phases/11-url-state-sharing/11-01-SUMMARY.md`
</output>
