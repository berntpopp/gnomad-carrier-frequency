---
phase: 11-url-state-sharing
plan: 02
type: execute
wave: 2
depends_on: ["11-01"]
files_modified:
  - src/components/wizard/StepResults.vue
autonomous: true

must_haves:
  truths:
    - "User can see a copy link button in the results step"
    - "Clicking copy link copies the current URL to clipboard"
    - "User sees visual feedback (checkmark/copied text) after copying"
    - "Feedback disappears after 2 seconds"
    - "Button works on browsers without clipboard API (fallback)"
  artifacts:
    - path: "src/components/wizard/StepResults.vue"
      provides: "Copy link button with clipboard integration"
      contains: "useClipboard"
  key_links:
    - from: "src/components/wizard/StepResults.vue"
      to: "@vueuse/core useClipboard"
      via: "clipboard copy functionality"
      pattern: "useClipboard"
    - from: "src/components/wizard/StepResults.vue"
      to: "window.location.href"
      via: "gets current URL for copying"
      pattern: "window\\.location\\.href"
---

<objective>
Add a copy link button to the results step that copies the current URL to clipboard with visual feedback.

Purpose: Enable users to easily share calculation URLs with colleagues (URL-04)
Output: Copy link button in StepResults.vue with clipboard integration and visual feedback
</objective>

<execution_context>
@~/.claude/get-shit-done/workflows/execute-plan.md
@~/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/11-url-state-sharing/11-RESEARCH.md
@.planning/phases/11-url-state-sharing/11-01-SUMMARY.md

@src/components/wizard/StepResults.vue
</context>

<tasks>

<task type="auto">
  <name>Task 1: Add copy link button to StepResults</name>
  <files>
    src/components/wizard/StepResults.vue
  </files>
  <action>
1. Read current `src/components/wizard/StepResults.vue` to understand existing structure.

2. Add VueUse clipboard import:
   ```typescript
   import { useClipboard } from '@vueuse/core';
   ```

3. Set up clipboard composable in script setup:
   ```typescript
   // Clipboard for copy link functionality
   const { copy, copied, isSupported } = useClipboard({
     copiedDuring: 2000, // Show "copied" state for 2 seconds
     legacy: true, // Fallback for older browsers
   });

   // Copy current URL handler
   function copyShareLink() {
     copy(window.location.href);
   }
   ```

4. Add copy link button in the button row (after the Export dropdown, before the View variants button section or as a new row).

   Placement options - choose the most appropriate based on existing layout:

   Option A: Add to the existing "View all variants / Export" button row:
   ```vue
   <div
     v-if="filteredCount > 0"
     class="d-flex align-center flex-wrap gap-2 mt-3"
   >
     <!-- Existing View all variants button -->
     <v-btn
       variant="text"
       color="primary"
       prepend-icon="mdi-table"
       @click="openAllVariantsModal"
     >
       View all variants ({{ filteredCount }})
     </v-btn>

     <!-- Existing Export dropdown -->
     <v-menu>
       <!-- ... existing export menu ... -->
     </v-menu>

     <!-- NEW: Copy link button -->
     <v-btn
       variant="outlined"
       :color="copied ? 'success' : 'primary'"
       :prepend-icon="copied ? 'mdi-check' : 'mdi-link'"
       @click="copyShareLink"
       :disabled="!isSupported"
     >
       {{ copied ? 'Link copied!' : 'Copy link' }}
     </v-btn>
   </div>
   ```

   Option B: If button row is getting crowded, create a new section for sharing:
   ```vue
   <!-- Share section after existing buttons -->
   <div class="d-flex align-center mt-3">
     <v-btn
       variant="outlined"
       :color="copied ? 'success' : 'primary'"
       :prepend-icon="copied ? 'mdi-check' : 'mdi-link'"
       @click="copyShareLink"
       :disabled="!isSupported"
     >
       {{ copied ? 'Link copied!' : 'Copy link' }}
     </v-btn>
     <span
       v-if="!isSupported"
       class="text-caption text-medium-emphasis ml-2"
     >
       Clipboard not available
     </span>
   </div>
   ```

5. Add tooltip for additional context:
   ```vue
   <v-tooltip location="top">
     <template #activator="{ props: tooltipProps }">
       <v-btn
         v-bind="tooltipProps"
         variant="outlined"
         :color="copied ? 'success' : 'primary'"
         :prepend-icon="copied ? 'mdi-check' : 'mdi-link'"
         @click="copyShareLink"
         :disabled="!isSupported"
       >
         {{ copied ? 'Link copied!' : 'Copy link' }}
       </v-btn>
     </template>
     <span class="tooltip-text">
       Copy a shareable link with your current gene, filters, and settings.
       Recipients can open this link to see the same calculation.
     </span>
   </v-tooltip>
   ```

6. Ensure flex-wrap is enabled on the container for responsive layout:
   ```vue
   class="d-flex align-center flex-wrap gap-2 mt-3"
   ```

7. Add aria-label for accessibility:
   ```vue
   aria-label="Copy shareable link to clipboard"
   ```
  </action>
  <verify>
    - `bun run typecheck` passes
    - `bun run lint` passes
    - `bun run build` succeeds
    - Manual test:
      1. Navigate to results step with a gene
      2. Click "Copy link" button
      3. Verify button changes to "Link copied!" with checkmark
      4. Verify feedback reverts after 2 seconds
      5. Paste clipboard contents and verify it's the current URL
  </verify>
  <done>
    Copy link button added to StepResults with clipboard integration, visual feedback, and accessibility support
  </done>
</task>

<task type="auto">
  <name>Task 2: Add screen reader announcement for copy action</name>
  <files>
    src/components/wizard/StepResults.vue
  </files>
  <action>
1. Import the app announcer composable:
   ```typescript
   import { useAppAnnouncer } from '@/composables';
   ```

2. Set up announcer:
   ```typescript
   const { announce } = useAppAnnouncer();
   ```

3. Update copyShareLink function to announce:
   ```typescript
   async function copyShareLink() {
     await copy(window.location.href);
     if (copied.value) {
       announce('Link copied to clipboard');
     }
   }
   ```

   Note: The `copied` ref is set by VueUse after successful copy, so we can check it.

4. Alternative approach if timing is tricky:
   ```typescript
   async function copyShareLink() {
     try {
       await copy(window.location.href);
       announce('Link copied to clipboard');
     } catch {
       announce('Failed to copy link');
     }
   }
   ```
  </action>
  <verify>
    - `bun run typecheck` passes
    - Screen reader test: Enable VoiceOver/NVDA, click copy button, verify "Link copied to clipboard" is announced
  </verify>
  <done>
    Screen reader users are informed when link is copied via ARIA live region announcement
  </done>
</task>

</tasks>

<verification>
1. **Build verification:**
   - `bun run typecheck` passes
   - `bun run lint` passes
   - `bun run build` succeeds

2. **Copy link functionality:**
   - Button visible in results step
   - Click copies current URL to clipboard
   - Visual feedback shows "Link copied!" with checkmark icon
   - Feedback reverts to "Copy link" after 2 seconds

3. **URL contains state:**
   - Copied URL includes gene parameter
   - Copied URL includes step parameter
   - Copied URL includes filter parameters (if non-default)

4. **Accessibility:**
   - Button has appropriate aria-label
   - Screen reader announces copy success
   - Button is keyboard accessible (Tab + Enter)

5. **Edge cases:**
   - Works on HTTPS (required for modern Clipboard API)
   - Fallback works on browsers without Clipboard API
   - Button disabled if clipboard not supported (shows appropriate state)
</verification>

<success_criteria>
- Copy link button visible in results step (URL-04)
- Button copies current URL including all state parameters
- Visual feedback confirms successful copy
- Screen reader announces copy action
- Button accessible via keyboard
- Graceful handling when clipboard not available
</success_criteria>

<output>
After completion, create `.planning/phases/11-url-state-sharing/11-02-SUMMARY.md`
</output>
