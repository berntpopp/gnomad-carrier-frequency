---
phase: 13-variant-exclusion
plan: 02
type: execute
wave: 2
depends_on: ["13-01"]
files_modified:
  - src/components/VariantTable.vue
  - src/components/VariantModal.vue
autonomous: true

must_haves:
  truths:
    - "User can exclude individual variants via checkbox in variant table"
    - "User can exclude/include all variants via header checkbox"
    - "Excluded variants are visually dimmed with strikethrough text"
    - "Excluded variants remain in table at original sort position"
  artifacts:
    - path: "src/components/VariantTable.vue"
      provides: "Variant table with exclusion checkboxes and visual styling"
      contains: "useExclusionState"
    - path: "src/components/VariantModal.vue"
      provides: "Exclusion count badge display"
      contains: "excludedCount"
  key_links:
    - from: "src/components/VariantTable.vue"
      to: "src/composables/useExclusionState.ts"
      via: "composable import"
      pattern: "useExclusionState"
    - from: "src/components/VariantTable.vue"
      to: "checkbox event handlers"
      via: "toggleVariant calls"
      pattern: "toggleVariant\\("
---

<objective>
Add variant exclusion UI to VariantTable: checkboxes for individual exclusion, header checkbox for bulk actions, and visual styling for excluded rows.

Purpose: Enables users to manually exclude variants from calculations (EXCL-01, EXCL-02, EXCL-03, EXCL-08). The familiar checkbox pattern provides intuitive selection UX.

Output:
- Modified `src/components/VariantTable.vue` with exclusion checkboxes and styling
- Modified `src/components/VariantModal.vue` with exclusion count badge
</objective>

<execution_context>
@~/.claude/get-shit-done/workflows/execute-plan.md
@~/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/phases/13-variant-exclusion/13-CONTEXT.md
@.planning/phases/13-variant-exclusion/13-RESEARCH.md
@.planning/phases/13-variant-exclusion/13-01-SUMMARY.md
@src/components/VariantTable.vue
@src/components/VariantModal.vue
</context>

<tasks>

<task type="auto">
  <name>Task 1: Add exclusion checkboxes to VariantTable</name>
  <files>src/components/VariantTable.vue</files>
  <action>
Modify `src/components/VariantTable.vue` to add exclusion functionality:

1. Import useExclusionState composable and add to script:
```typescript
import { useExclusionState } from '@/composables';

// In setup
const {
  excluded,
  excludedCount,
  excludeVariant,
  includeVariant,
  toggleVariant,
  excludeAll,
  includeAll,
  isExcluded,
} = useExclusionState();
```

2. Add computed properties for checkbox states:
```typescript
// All variants are included (none excluded)
const allIncluded = computed(() => {
  if (!props.variants.length) return true;
  return props.variants.every(v => !isExcluded(v.variant_id));
});

// Some but not all variants are excluded
const someExcluded = computed(() => {
  if (!props.variants.length) return false;
  const excludedInTable = props.variants.filter(v => isExcluded(v.variant_id));
  return excludedInTable.length > 0 && excludedInTable.length < props.variants.length;
});

// Handle header checkbox toggle
function handleHeaderToggle(include: boolean) {
  if (include) {
    // Include all variants in this table
    for (const v of props.variants) {
      includeVariant(v.variant_id);
    }
  } else {
    // Exclude all variants in this table
    excludeAll(props.variants.map(v => v.variant_id));
  }
}
```

3. Add "Include" column as FIRST column in headers array:
```typescript
const headers = ref([
  { title: '', key: 'include', sortable: false, width: '48px' },
  { title: 'Variant ID', key: 'variant_id', sortable: true },
  // ... rest of existing headers
]);
```

4. Add template slot for header checkbox (before variant_id slot):
```vue
<!-- Header checkbox for bulk include/exclude -->
<template #header.include>
  <v-checkbox-btn
    :model-value="allIncluded"
    :indeterminate="someExcluded"
    density="compact"
    hide-details
    aria-label="Include all variants"
    @update:model-value="handleHeaderToggle"
  />
</template>
```

5. Add template slot for row checkbox:
```vue
<!-- Row checkbox for individual exclusion -->
<template #[`item.include`]="{ item }">
  <v-checkbox-btn
    :model-value="!isExcluded(item.variant_id)"
    density="compact"
    hide-details
    :aria-label="isExcluded(item.variant_id) ? 'Include variant' : 'Exclude variant'"
    @update:model-value="() => toggleVariant(item.variant_id)"
  />
</template>
```

6. Modify variant_id slot to apply strikethrough styling when excluded:
```vue
<template #[`item.variant_id`]="{ item }">
  <a
    :href="getGnomadUrl(item.variant_id)"
    target="_blank"
    rel="noopener noreferrer"
    :class="[
      'text-primary text-decoration-none',
      { 'text-decoration-line-through text-medium-emphasis': isExcluded(item.variant_id) }
    ]"
  >
    {{ item.variant_id }}
    <v-icon size="x-small" class="ml-1">mdi-open-in-new</v-icon>
  </a>
</template>
```

7. Add item-class prop to v-data-table for row styling:
```vue
<v-data-table
  ...existing props...
  :item-class="getRowClass"
>
```

And add the getRowClass function:
```typescript
// Row class for excluded variant styling
function getRowClass(item: DisplayVariant): string {
  return isExcluded(item.variant_id) ? 'excluded-row' : '';
}
```

8. Add scoped CSS for excluded row styling:
```css
.excluded-row {
  opacity: 0.6;
}

.excluded-row td {
  color: rgba(var(--v-theme-on-surface), 0.6) !important;
}

/* Maintain hover for re-inclusion */
.excluded-row:hover {
  opacity: 0.8;
}
```
  </action>
  <verify>
`bun run typecheck` passes.
`bun run lint` passes.
Manually verify in browser:
1. Open variant modal
2. Each row has a checkbox at the start
3. Clicking checkbox dims the row and strikes through variant ID
4. Header checkbox toggles all variants
5. Indeterminate state shows when some are excluded
  </verify>
  <done>
VariantTable has exclusion checkboxes: individual row checkboxes toggle exclusion, header checkbox for bulk actions, excluded rows show dimmed with strikethrough styling. Checkboxes use "include" semantics (checked = included, unchecked = excluded).
  </done>
</task>

<task type="auto">
  <name>Task 2: Add exclusion count badge to VariantModal</name>
  <files>src/components/VariantModal.vue</files>
  <action>
Modify `src/components/VariantModal.vue` to show exclusion count:

1. Import useExclusionState:
```typescript
import { useExclusionState } from '@/composables';

// In setup
const { excludedCount, includeAll } = useExclusionState();
```

2. Add computed for excluded count within current variants:
```typescript
// Count of excluded variants in current modal view
const excludedInModal = computed(() => {
  const { excluded } = useExclusionState();
  return props.variants.filter(v => excluded.value.includes(v.variant_id)).length;
});
```

3. Add badge chip next to modal title when variants are excluded:
```vue
<v-card-title class="d-flex align-center justify-space-between">
  <span class="d-flex align-center flex-wrap">
    {{ modalTitle }}
    <v-chip
      v-if="excludedInModal > 0"
      color="warning"
      size="small"
      class="ml-2"
      variant="tonal"
    >
      {{ excludedInModal }} excluded
    </v-chip>
  </span>
  <v-btn ... /> <!-- existing close button -->
</v-card-title>
```

4. Add "Clear exclusions" button in card-actions:
```vue
<v-card-actions class="pa-4">
  <!-- Clear exclusions button - only show if any excluded -->
  <v-btn
    v-if="excludedInModal > 0"
    variant="text"
    color="warning"
    size="small"
    @click="includeAll"
  >
    <v-icon start>mdi-refresh</v-icon>
    Clear exclusions
  </v-btn>

  <!-- Export dropdown (existing) -->
  <v-menu>
    ...existing export menu...
  </v-menu>

  <v-spacer />
  <v-btn ... /> <!-- existing close button -->
</v-card-actions>
```
  </action>
  <verify>
`bun run typecheck` passes.
`bun run lint` passes.
Manually verify:
1. Exclude some variants in the table
2. Badge shows "X excluded" next to modal title
3. "Clear exclusions" button appears
4. Clicking "Clear exclusions" includes all variants
  </verify>
  <done>
VariantModal displays exclusion count badge when variants are excluded. "Clear exclusions" button allows restoring all variants at once.
  </done>
</task>

</tasks>

<verification>
After both tasks:
1. `bun run typecheck` passes
2. `bun run lint` passes
3. `bun run build` succeeds
4. `bun run dev` - manually test:
   - Navigate to a gene with variants
   - Open variant modal
   - Checkboxes appear at start of each row
   - Clicking checkbox excludes/includes variant
   - Excluded rows are dimmed with strikethrough
   - Header checkbox toggles all
   - Badge shows exclusion count
   - "Clear exclusions" button works
</verification>

<success_criteria>
- Each variant row has a checkbox at the start (EXCL-01)
- Header checkbox toggles all variants (EXCL-02)
- Excluded rows show dimmed with strikethrough text (EXCL-03)
- Excluded rows remain at original sort position
- Badge shows exclusion count in modal title
- "Clear exclusions" button restores all variants (EXCL-08)
</success_criteria>

<output>
After completion, create `.planning/phases/13-variant-exclusion/13-02-SUMMARY.md`
</output>
