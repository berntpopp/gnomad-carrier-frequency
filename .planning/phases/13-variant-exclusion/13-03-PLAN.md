---
phase: 13-variant-exclusion
plan: 03
type: execute
wave: 2
depends_on: ["13-01"]
files_modified:
  - src/composables/useCarrierFrequency.ts
  - src/components/wizard/StepResults.vue
  - src/components/wizard/StepGene.vue
autonomous: true

must_haves:
  truths:
    - "Carrier frequency recalculates when variants are excluded"
    - "Recalculation is debounced to prevent jittery UI"
    - "Results page shows note when variants have been excluded"
    - "Exclusion state resets when gene changes"
  artifacts:
    - path: "src/composables/useCarrierFrequency.ts"
      provides: "Frequency calculation excluding excluded variants"
      contains: "useExclusionState"
    - path: "src/components/wizard/StepResults.vue"
      provides: "Exclusion note display under variant count"
      contains: "excludedCount"
    - path: "src/components/wizard/StepGene.vue"
      provides: "Exclusion reset on gene selection"
      contains: "resetForGene"
  key_links:
    - from: "src/composables/useCarrierFrequency.ts"
      to: "src/composables/useExclusionState.ts"
      via: "composable import"
      pattern: "useExclusionState"
    - from: "src/components/wizard/StepGene.vue"
      to: "src/composables/useExclusionState.ts"
      via: "resetForGene call"
      pattern: "resetForGene\\("
---

<objective>
Integrate exclusion state with carrier frequency calculation: filter out excluded variants before aggregation, add debounced recalculation, show exclusion note in results, and reset exclusions on gene change.

Purpose: Enables real-time frequency updates when variants are excluded (EXCL-04, EXCL-05, EXCL-07). Debouncing prevents jarring UI updates during rapid checkbox toggling.

Output:
- Modified `src/composables/useCarrierFrequency.ts` to filter excluded variants
- Modified `src/components/wizard/StepResults.vue` to show exclusion note
- Modified `src/components/wizard/StepGene.vue` to reset exclusions on gene change
</objective>

<execution_context>
@~/.claude/get-shit-done/workflows/execute-plan.md
@~/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/phases/13-variant-exclusion/13-CONTEXT.md
@.planning/phases/13-variant-exclusion/13-RESEARCH.md
@.planning/phases/13-variant-exclusion/13-01-SUMMARY.md
@src/composables/useCarrierFrequency.ts
@src/components/wizard/StepResults.vue
@src/components/wizard/StepGene.vue
</context>

<tasks>

<task type="auto">
  <name>Task 1: Integrate exclusion filtering into useCarrierFrequency</name>
  <files>src/composables/useCarrierFrequency.ts</files>
  <action>
Modify `src/composables/useCarrierFrequency.ts` to filter excluded variants:

1. Import useExclusionState and watchDebounced from VueUse:
```typescript
import { watchDebounced } from '@vueuse/core';
import { useExclusionState } from './useExclusionState';
```

2. Add exclusion state to the composable setup:
```typescript
// Get exclusion state (singleton)
const { excluded, excludedCount } = useExclusionState();
```

3. Add a ref to track debounced exclusion state for computation:
```typescript
// Debounced exclusion set for frequency calculation
// Prevents recalculation on every rapid checkbox toggle
const debouncedExcluded = ref<Set<string>>(new Set());

// Watch excluded with debounce
watchDebounced(
  excluded,
  (newExcluded) => {
    debouncedExcluded.value = new Set(newExcluded);
  },
  { debounce: 500, maxWait: 2000, immediate: true }
);
```

4. Modify the pathogenicVariants computed to filter out excluded variants:
```typescript
// Filter to pathogenic variants using configurable filters (FILT-01 through FILT-09)
// Then filter out manually excluded variants (EXCL-04)
const pathogenicVariants = computed(() => {
  if (!normalizedVariants.value.length) return [];

  // First apply standard pathogenicity filters
  const filtered = filterPathogenicVariantsConfigurable(
    normalizedVariants.value,
    normalizedClinvar.value,
    filterConfig.value,
    submissions.value
  );

  // Then filter out manually excluded variants
  return filtered.filter(v => !debouncedExcluded.value.has(v.variant_id));
});
```

5. Add excludedCount to the return interface and object:

Update `UseCarrierFrequencyReturn` interface:
```typescript
export interface UseCarrierFrequencyReturn {
  // ... existing fields ...

  // Exclusion state
  excludedCount: Ref<number>;
}
```

Add to return statement:
```typescript
return {
  // ... existing returns ...
  excludedCount,
};
```

6. Also expose the pre-exclusion variant count for display purposes:

Add to interface and return:
```typescript
// In interface
totalPathogenicCount: Ref<number>; // Count before exclusions

// In composable
const totalPathogenicCount = computed(() => {
  if (!normalizedVariants.value.length) return 0;
  return filterPathogenicVariantsConfigurable(
    normalizedVariants.value,
    normalizedClinvar.value,
    filterConfig.value,
    submissions.value
  ).length;
});

// In return
totalPathogenicCount,
```
  </action>
  <verify>
`bun run typecheck` passes.
`bun run lint` passes.
The composable now filters out excluded variants from frequency calculations.
  </verify>
  <done>
useCarrierFrequency filters excluded variants before aggregation. Exclusion filtering is debounced (500ms) to prevent jittery recalculation. Exposes excludedCount and totalPathogenicCount for UI display.
  </done>
</task>

<task type="auto">
  <name>Task 2: Add exclusion note to StepResults and reset in StepGene</name>
  <files>
    src/components/wizard/StepResults.vue
    src/components/wizard/StepGene.vue
  </files>
  <action>
**StepResults.vue modifications:**

1. Import useExclusionState:
```typescript
import { useExclusionState } from '@/composables';

// In setup
const { excludedCount } = useExclusionState();
```

2. Add props for exclusion-related data (update defineProps):
```typescript
const props = defineProps<{
  // ... existing props ...
  totalPathogenicCount: number; // Count before exclusions
}>();
```

3. Add exclusion note below the variant count display. Find the section that shows:
```
Based on {{ filteredCount }} qualifying variant(s)
```

And modify to include exclusion note:
```vue
<div class="text-body-2 mt-2 text-medium-emphasis d-flex align-center flex-wrap">
  Based on {{ filteredCount }} qualifying variant(s)
  <!-- Exclusion note when variants have been excluded -->
  <span
    v-if="excludedCount > 0"
    class="ml-1 text-warning"
  >
    ({{ excludedCount }} manually excluded)
  </span>
  <v-tooltip location="top">
    <!-- existing tooltip -->
  </v-tooltip>
</div>
```

4. Also add a more prominent alert when exclusions are active:
```vue
<!-- Exclusion alert - shows when variants have been manually excluded -->
<v-alert
  v-if="excludedCount > 0"
  type="info"
  variant="tonal"
  class="mb-4"
  density="compact"
>
  <template #prepend>
    <v-icon>mdi-filter-remove</v-icon>
  </template>
  {{ excludedCount }} variant(s) manually excluded from calculation.
  Open the variant table to review or restore excluded variants.
</v-alert>
```

Place this alert after the ClingenWarning component.

**StepGene.vue modifications:**

1. Import useExclusionState:
```typescript
import { useExclusionState } from '@/composables';

// In setup
const { resetForGene } = useExclusionState();
```

2. Find where gene selection happens (the `selectGene` function or watch on selected gene) and add exclusion reset.

Look for the emit or function that handles gene selection. Add:
```typescript
// Reset exclusions when gene changes
watch(
  () => wizardState.gene,
  (newGene) => {
    if (newGene?.symbol) {
      resetForGene(newGene.symbol);
    }
  }
);
```

Or if there's a `handleGeneSelect` function, add to it:
```typescript
function handleGeneSelect(gene: GeneSearchResult) {
  // ... existing logic ...
  resetForGene(gene.symbol);
}
```
  </action>
  <verify>
`bun run typecheck` passes.
`bun run lint` passes.
Manually verify:
1. Exclude variants in modal
2. Close modal - results page shows exclusion note
3. Alert appears indicating excluded variants
4. Frequency values reflect excluded variants
5. Select different gene - exclusions reset
  </verify>
  <done>
StepResults shows exclusion count note under variant count and an info alert when variants are excluded (EXCL-05). StepGene resets exclusions when gene changes (EXCL-07).
  </done>
</task>

</tasks>

<verification>
After both tasks:
1. `bun run typecheck` passes
2. `bun run lint` passes
3. `bun run build` succeeds
4. `bun run dev` - manually test:
   - Select a gene with variants
   - Open variant modal, exclude some variants
   - Close modal - results show "(X manually excluded)" note
   - Alert shows informing about excluded variants
   - Carrier frequency value reflects exclusions
   - Select different gene - exclusions clear
   - Rapid checkbox toggling doesn't cause jittery updates
</verification>

<success_criteria>
- Carrier frequency recalculates in real-time when variants excluded (EXCL-04)
- Recalculation is debounced (500ms delay) for smooth UX
- Results page shows note when variants have been excluded (EXCL-05)
- Exclusion state resets when gene changes (EXCL-07)
- Info alert prompts user to review excluded variants in modal
</success_criteria>

<output>
After completion, create `.planning/phases/13-variant-exclusion/13-03-SUMMARY.md`
</output>
